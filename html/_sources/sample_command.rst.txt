.. _sample_command-name:

!!!!!!!!!!!!!!
sample_command
!!!!!!!!!!!!!!

xrst input file: ``devel/cmd/sample_command.cpp``

.. meta::
   :keywords: sample_command, the, sample, command

.. index:: sample_command, the, sample, command

.. _sample_command-title:

The Sample Command
##################

.. meta::
   :keywords: syntax

.. index:: syntax

.. _sample_command@Syntax:

Syntax
******

| ``dismod_at`` *database* ``sample`` *method* *variables* *number_sample*
| ``dismod_at`` *database* ``sample`` *method* *variables* *number_sample* *simulate_index*

.. meta::
   :keywords: database

.. index:: database

.. _sample_command@database:

database
********
Is an
http://www.sqlite.org/sqlite/ database containing the
``dismod_at`` :ref:`input-name` tables which are not modified.

.. meta::
   :keywords: purpose

.. index:: purpose

.. _sample_command@Purpose:

Purpose
*******
This command simulates samples of the :ref:`model_variables-name`
from the posterior distribution; see
:ref:`posterior@Simulation` for the posterior distribution.

.. meta::
   :keywords: method

.. index:: method

.. _sample_command@method:

method
******
The sample command argument *method* must be
``simulate`` or ``asymptotic`` ; see discussion below:

.. meta::
   :keywords: variables

.. index:: variables

.. _sample_command@variables:

variables
*********
The sample command argument *variables* must be
``fixed`` or ``both`` .
This corresponds to the asymptotic statistics for
:ref:`fit fixed<fit_command@variables@fixed>` and
:ref:`fit both<fit_command@variables@both>` respectively.

.. meta::
   :keywords: number_sample

.. index:: number_sample

.. _sample_command@number_sample:

number_sample
*************
Is the number of samples. Each sample contains a complete
set of model variables.
If *method* is ``simulate`` ,
*number_sample* must be equal to
:ref:`simulate_command@number_simulate`
in the previous simulate command.

.. meta::
   :keywords: simulate_index

.. index:: simulate_index

.. _sample_command@simulate_index:

simulate_index
**************
If this argument is present, *method* must be ``asymptotic``
and *simulate_index* must be the same as in the corresponding
:ref:`fit command<fit_command@simulate_index>` .

.. meta::
   :keywords: simulate

.. index:: simulate

.. _sample_command@simulate:

simulate
********
A complete set of :ref:`model_variables-name` ,
corresponding to each :ref:`sample_table@sample_index` ,
is written to the sample table.
They correspond to fitting the data in the data_sim table with
:ref:`data_sim_table@simulate_index` equal to
*sample_index* .
The fixed effects correspond to the optimal fit of both the fixed and random
effects with the prior for the fixed effects replaced by the corresponding
values in the :ref:`prior_sim_table-name` .
This value is used for the fixed effects and the value for the
random effects is obtained by optimizing just the random
effects with the prior for the random effects replaced by the corresponding
values in the :ref:`prior_sim_table-name` .
This requires running *number_sample* fits of the model variables
(fitting just the random effects is faster compared to fitting both).
See :ref:`posterior@Simulation` in the discussion of the
posterior distribution of maximum likelihood estimates.

.. meta::
   :keywords: asymptotic

.. index:: asymptotic

.. _sample_command@asymptotic:

asymptotic
**********
If *method* is ``asymptotic`` ,
the :ref:`fit_var_table-name` is an additional input in this case
and it assumed to correspond to a
fit :ref:`fit_command@variables@both` .
If the previous fit did (did not) have a
:ref:`fit_command@simulate_index` it
must (must not) be included in the sample_command.
The asymptotic statistics of the model variables is used to generate
*number_sample* samples of the model variables
The samples with different values of *sample_index* are independent.
All of the Laplace density terms are ignored by the asymptotic statistics.
The constraints are also ignored, except the constraints were
the lower and upper limits for a variable are equal.

.. meta::
   :keywords: fixed, effects, distribution

.. index:: fixed, effects, distribution

.. _sample_command@asymptotic@Fixed Effects Distribution:

Fixed Effects Distribution
==========================
The asymptotic distribution used to simulate the fixed effects is a normal
with mean equal to the value of the fixed effects in the :ref:`fit_var_table-name`
and covariance equal to the inverse of the
Hessian of the fixed effect objective
:ref:`sample_command@Output Tables@hes_fixed_table` .
If a fixed effect is scaled
(see :ref:`prior_table@eta@Scaling Fixed Effects` )
the scaled version of the fixed effect has the asymptotic distribution.
If the lower and upper limits are equal, the corresponding variable
is simulated as having that constant value.

.. meta::
   :keywords: random, effects, distribution

.. index:: random, effects, distribution

.. _sample_command@asymptotic@Random Effects Distribution:

Random Effects Distribution
===========================
If the lower and upper limits for a random effect are equal,
the random effect is simulated as having that constant value.
If the lower and upper limits are not equal and
*variables* is ``fixed`` ,
the random effect is simulated with value zero.
Otherwise,
the asymptotic distribution used to simulate a random effect is a normal
with mean equal to the value of the random effect in the :ref:`fit_var_table-name`
This is the optimal value given the fixed effects; see
:ref:`sample_command@Extra Input Tables@fit_var_table` below.
The covariance of the random effects is equal to the inverse of the
Hessian of the random effect objective
:ref:`sample_command@Output Tables@hes_fixed_table` .

.. meta::
   :keywords: extra, input, tables

.. index:: extra, input, tables

.. _sample_command@Extra Input Tables:

Extra Input Tables
******************

.. meta::
   :keywords: data_sim_table

.. index:: data_sim_table

.. _sample_command@Extra Input Tables@data_sim_table:

data_sim_table
==============
If *method* is ``simulate`` ,
this command has the extra input :ref:`data_sim_table-name`
which was created by the previous :ref:`simulate_command-name` .

.. meta::
   :keywords: prior_sim_table

.. index:: prior_sim_table

.. _sample_command@Extra Input Tables@prior_sim_table:

prior_sim_table
===============
If *method* is ``simulate`` ,
this command has the extra input :ref:`prior_sim_table-name`
which was created by the previous :ref:`simulate_command-name` .

.. meta::
   :keywords: fit_var_table

.. index:: fit_var_table

.. _sample_command@Extra Input Tables@fit_var_table:

fit_var_table
=============
If *method* is ``asymptotic`` ,
this command has the extra input :ref:`fit_var_table-name`
which was created by a previous fit command which
must have included :ref:`fit_command@variables@both`
fixed and random effects.

.. meta::
   :keywords: output, tables

.. index:: output, tables

.. _sample_command@Output Tables:

Output Tables
*************

.. meta::
   :keywords: sample_table

.. index:: sample_table

.. _sample_command@Output Tables@sample_table:

sample_table
============
A new :ref:`sample_table-name` is created each time this command is run.
It contains samples of the model variables.
Hence the number of rows in this table is *number_sample*
times the number of rows in the :ref:`var_table-name` .
If the ``asymptotic`` command fails because the
fixed effects information matrix is not positive definite,
this command will terminate with an error and the sample table will not exist.
The corresponding fixed effects information matrix will be in the
:ref:`sample_command@Output Tables@hes_fixed_table` .

.. meta::
   :keywords: no, sample, table

.. index:: no, sample, table

.. _sample_command@Output Tables@No Sample Table:

No Sample Table
===============
In the special case where *method* is ``asymptotic``
and the Hessian of the fixed objective is not positive definite,
the sample table is not created; i.e.,
there is be no sample table in the database after this command.
In addition, if *variables* is ``both`` and the Hessian
of the random effects objective is not positive definite,
the sample table is not created.

.. meta::
   :keywords: hes_fixed_table

.. index:: hes_fixed_table

.. _sample_command@Output Tables@hes_fixed_table:

hes_fixed_table
===============
A new :ref:`hes_fixed_table-name` is created each time this command is run
with *method* equal to ``asymptotic`` .
The Hessian of the fixed effects objective is written in this table.
If *simulate_index* is present (is not present) the Hessian corresponds
to the simulated measurements in the :ref:`data_sim_table-name`
(measurements in the :ref:`data_table-name` ).

.. meta::
   :keywords: hes_random_table

.. index:: hes_random_table

.. _sample_command@Output Tables@hes_random_table:

hes_random_table
================
A new :ref:`hes_random_table-name` is created each time this command is run
with *method* equal to ``asymptotic`` and
*variables* equal to ``both`` .
The Hessian of the random effects objective is written in this table.
If *simulate_index* is present (is not present) the Hessian corresponds
to the simulated measurements in the :ref:`data_sim_table-name`
(measurements in the :ref:`data_table-name` ).

.. meta::
   :keywords: bounds

.. index:: bounds

.. _sample_command@Bounds:

Bounds
******
If you use the ``simulate`` method,
the samples are all within the specified bounds, including the bounds
on the random effects specified by
:ref:`option_table@Optimize Random Only@bound_random` .
If you use the ``asymptotic`` method,
the only bounds that are enforced are where the upper and lower limits
are equal.

.. meta::
   :keywords: example

.. index:: example

.. _sample_command@Example:

Example
*******
The files
:ref:`sample_command.py-name` , :ref:`user_sample_asy.py-name`
contain examples and tests using this command.

.. toctree::
   :maxdepth: 1
   :hidden:

   sample_command.py
