<html>
<script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath:  [ ['@(@','@)@'] ] ,
    displayMath: [ ['@[@','@]@'] ]
  }
});
</script>
<script type='text/javascript' src=
'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=default'
>
</script>
<head>
<title>Fitting One Function of Two Variables</title>
<meta http-equiv='Content-Type' content='text/html' charset='utf-8'>
<meta name="description" id="description" content="Fitting One Function of Two Variables">
<meta name="keywords" id="keywords" content=" fitting one function two variables purpose rho random effects covariates simulated data density true prevalence computing delta prior random_seed source code ">
<style type='text/css'>
body { color : black }
body { background-color : white }
A:link { color : blue }
A:visited { color : purple }
A:active { color : purple }
</style>
<script type='text/javascript' language='JavaScript' src='_user_one_function.py_htm.js'>
</script>
</head>
<body>
<table><tr>
<td>
<a href="https://bradbell.github.io/dismod_at" target="_top"><img border="0" src="_image.gif"></a>
</td>
<td>
<select onchange='choose_up0(this)'>
<option>Location-&gt;</option>
<option>dismod_at</option>
<option>user_example</option>
<option>user_one_function.py</option>
</select>
</td>
<td>
<select onchange='choose_across0(this)'>
<option>Search-&gt;</option>
<option>contents</option>
<option>reference</option>
<option>index</option>
<option>search</option>
<option>external</option>
</select>
</td>
<td><a href="user_no_children.py.htm" target="_top">Prev</a>
</td><td><a href="user_plot_curve.py.htm" target="_top">Next</a>
</td><td>
<script type='text/javascript' language='JavaScript' src='_childtable_dismod_at_htm.js'></script>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_user_example_htm.js'></script>
</td>
<td>user_one_function.py</td>
</tr></table><br>
@(@\newcommand{\R}[1]{ {\rm #1} }
\newcommand{\B}[1]{ {\bf #1} }
\newcommand{\W}[1]{ \; #1 \; }@)@<center><b><big><big>Fitting One Function of Two Variables</big></big></b></center>

<br><a href="user_one_function.py.htm#Purpose" target="_top">Purpose</a>
<br><a href="user_one_function.py.htm#rho" target="_top">rho</a>
<br><a href="user_one_function.py.htm#Random Effects" target="_top">Random&nbsp;Effects</a>
<br><a href="user_one_function.py.htm#Covariates" target="_top">Covariates</a>
<br><a href="user_one_function.py.htm#Simulated Data" target="_top">Simulated&nbsp;Data</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_one_function.py.htm#Simulated Data.Data Density" target="_top">Data&nbsp;Density</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_one_function.py.htm#Simulated Data.True Prevalence" target="_top">True&nbsp;Prevalence</a>
<br><a href="user_one_function.py.htm#Computing Delta" target="_top">Computing&nbsp;Delta</a>
<br><a href="user_one_function.py.htm#Prevalence Prior" target="_top">Prevalence&nbsp;Prior</a>
<br><a href="user_one_function.py.htm#random_seed" target="_top">random_seed</a>
<br><a href="user_one_function.py.htm#Source Code" target="_top">Source&nbsp;Code</a>
<br><br>
<b><big><a name="Purpose" id="Purpose">Purpose</a></big></b>
<br>
This example shows how to fit one function of two variables given
direct measurements of the function.
For our example, we are give measurements of prevalence,
as a function of age and time, and fit a function to the measurements.

<br>
<br>
<b><big><a name="rho" id="rho">rho</a></big></b>
<br>
We use 
<code><i><font color="black"><span style='white-space: nowrap'>rho</span></font></i></code>

as a surrogate for prevalence because our model for prevalence
does not use 
<code><i><font color="black"><span style='white-space: nowrap'>rho</span></font></i></code>
 (we could have used any other rate
and its corresponding integrand).


<br>
<br>
<b><big><a name="Random Effects" id="Random Effects">Random Effects</a></big></b>
<br>
To keep this example simple, there is only one node <code><font color="blue">world</font></code>
in the <a href="node_table.htm" target="_top"><span style='white-space: nowrap'>node_table</span></a>
, and the
<a href="mulcov_table.htm#subgroup_smooth_id" target="_top"><span style='white-space: nowrap'>subgroup_smooth_id</span></a>

is null in the mulcov_table.
Hence, there are not random effects in this example.

<br>
<br>
<b><big><a name="Covariates" id="Covariates">Covariates</a></big></b>
<br>
Income is the only covariate for this example and it has been normalized
to be between zero and one.  The income reference value corresponds to
no effect. The income multiplier is the true value used to simulate the
data.
<pre style='display:inline'><tt>
income_reference   <font color="#990000">=</font>   <font color="#993399">0.5</font>
income_multiplier  <font color="#990000">=</font> <font color="#990000">-</font> <font color="#993399">0.2</font>
income_mulcov_type <font color="#990000">=</font> <font color="#FF0000">"meas_value"</font>
</tt></pre>
The 
<code><i><font color="black"><span style='white-space: nowrap'>income_mulcov_type</span></font></i></code>
 can be either <code><font color="blue">&quot;meas_value&quot;</font></code> or
<code><font color="blue">&quot;rate_value&quot;</font></code>.
It should not make a difference in the results which
<a href="mulcov_table.htm#mulcov_type" target="_top"><span style='white-space: nowrap'>mulcov_type</span></a>
 is used because
there is only one rate (one function) being fit, and the
<a href="integrand_table.htm#integrand_name.ODE" target="_top"><span style='white-space: nowrap'>ode</span></a>
 is not needed to compute
the integrand.
You can test this by changing 
<code><i><font color="black"><span style='white-space: nowrap'>income_mulcov_type</span></font></i></code>
 to
<code><font color="blue">&quot;rate_value&quot;</font></code>
and uses the same <a href="user_one_function.py.htm#random_seed" target="_top"><span style='white-space: nowrap'>random_seed</span></a>
.

<br>
<br>
<b><big><a name="Simulated Data" id="Simulated Data">Simulated Data</a></big></b>


<br>
<br>
<big><a name="Simulated Data.Data Density" id="Simulated Data.Data Density">Data Density</a></big>
<br>
A direct measurement of 
<code><i><font color="black"><span style='white-space: nowrap'>rho</span></font></i></code>

(which we are using to represent prevalence) corresponds to the
<a href="avg_integrand.htm#Integrand, I_i(a,t).remission" target="_top"><span style='white-space: nowrap'>remission&nbsp;integrand</span></a>
.
We use a <a href="density_table.htm#density_name.log_gaussian" target="_top"><span style='white-space: nowrap'>log_gaussian</span></a>

model with the following parameters:
<pre style='display:inline'><tt>
prevalence_sigma  <font color="#990000">=</font> <font color="#993399">0.1</font>
prevalence_eta    <font color="#990000">=</font> <font color="#993399">1e-6</font>
</tt></pre>
<br>
<big><a name="Simulated Data.True Prevalence" id="Simulated Data.True Prevalence">True Prevalence</a></big>
<br>
For simulating our prevalence data we consider the case where
all the rates are constant and 
<code><i><font color="black"><span style='white-space: nowrap'>rho</span></font></i></code>
, 
<code><i><font color="black"><span style='white-space: nowrap'>chi</span></font></i></code>
 are zero; i.e.,
the differential equation is
<small>@[@

	\begin{array}{rcl}
	S'(a) = -( \iota + \omega ) S(a)
	\\
	C'(a) = + \iota S(a) - \omega C(a)
	\end{array}

@]@</small>
where <small>@(@
S(0) = 1
@)@</small> and <small>@(@
C(0) = 0
@)@</small>.
It follows that
<small>@[@

	S(a) = \exp[ - ( \iota + \omega ) a ]

@]@</small>
<small>@[@

	C(a)
	= \int_0^a \exp[ \omega (s - a) ] \iota S(s) ds

@]@</small>
You can check the formula for <small>@(@
C(a)
@)@</small> as follows:
differentiating w.r.t. <small>@(@
a
@)@</small> inside the integral yields
<small>@(@
- \omega C(a)
@)@</small> and differentiating the upper limit
w.r.t. <small>@(@
a
@)@</small> yields <small>@(@
\iota S(a)
@)@</small>.
It follows that
<small>@[@

	C(a) = \iota \int_0^a \exp[ \omega (s - a) - ( \iota + \omega) s ] ds

@]@</small>
<small>@[@

	C(a) = \iota \exp( - \omega a) \int_0^a \exp( - \iota s ) ds

@]@</small>
<small>@[@

	C(a) = \exp( - \omega a) - \exp[ - ( \iota + \omega) a ]

@]@</small>

<pre><tt><b><font color="#0000FF">def</font></b> <b><font color="#000000">Prevalence</font></b><font color="#990000">(</font>age<font color="#990000">)</font> <font color="#990000">:</font>
     <i><font color="#9A1900"># rho and chi are zero for this simulation of prevalence data</font></i>
     iota      <font color="#990000">=</font> <font color="#993399">1e-4</font> <i><font color="#9A1900"># incidence used to simulate prevalence data</font></i>
     omega     <font color="#990000">=</font> <font color="#993399">1e-2</font> <i><font color="#9A1900"># other cause mortality used to simulate prevalence data</font></i>
     exp_omega <font color="#990000">=</font> <b><font color="#000000">exp</font></b><font color="#990000">(-</font>omega <font color="#990000">*</font> age<font color="#990000">)</font>
     exp_sum   <font color="#990000">=</font> <b><font color="#000000">exp</font></b><font color="#990000">(-(</font>iota <font color="#990000">+</font> omega<font color="#990000">)</font> <font color="#990000">*</font> age<font color="#990000">)</font>
     S         <font color="#990000">=</font> exp_sum
     C         <font color="#990000">=</font> exp_omega <font color="#990000">-</font> exp_sum
     <b><font color="#0000FF">return</font></b> C <font color="#990000">/</font> <font color="#990000">(</font>S <font color="#990000">+</font> C<font color="#990000">)</font></tt></pre>
<br>
<b><big><a name="Computing Delta" id="Computing Delta">Computing Delta</a></big></b>
<br>
Once we have simulated a measurement value,
we can solve for <small>@(@
\Delta
@)@</small> are follows; see
<a href="data_like.htm#Notation.Transformed Standard Deviation, sigma_i" target="_top"><span style='white-space: nowrap'>sigma</span></a>
:
<small>@[@

	\sigma = \log( y + \eta + \Delta ) - \log(y + \eta )

@]@</small>
<small>@[@

	\exp ( \sigma ) = \frac{ y + \eta + \Delta }{ y + \eta }

@]@</small>
<small>@[@

	\exp ( \sigma ) ( y + \eta ) = y + \eta + \Delta

@]@</small>
<small>@[@

	\Delta = [ \exp ( \sigma ) - 1 ] ( y + \eta )

@]@</small>
For this case there are no measurement noise covariates so
<small>@(@
\sigma
@)@</small> is the standard deviation for the simulated data.
Furthermore, the
<a href="option_table.htm#minimum_meas_cv" target="_top"><span style='white-space: nowrap'>minimum_meas_cv</span></a>
 is zero,
so <small>@(@
\Delta
@)@</small> is the 
<code><i><font color="black"><span style='white-space: nowrap'>meas_std</span></font></i></code>
.

<br>
<br>
<b><big><a name="Prevalence Prior" id="Prevalence Prior">Prevalence Prior</a></big></b>
<br>
Prevalence must always be between zero and one so this limits are used
in the prior for prevalence.
Some functions might allow for negative values and the lower limit
for the rate would be negative in that case.

<br>
<br>
<b><big><a name="random_seed" id="random_seed">random_seed</a></big></b>
<br>
We use the clock to choose a seed for the random number generator.
If an error occurs, the seed will be printed so that the error can be
reproduced. You can also use a fixed value for the random seed to see
how changing other parameters changes the results.
<pre style='display:inline'><tt>
<b><font color="#000080">import</font></b> time
random_seed <font color="#990000">=</font> <b><font color="#000000">int</font></b><font color="#990000">(</font> time<font color="#990000">.</font><b><font color="#000000">time</font></b><font color="#990000">()</font> <font color="#990000">)</font>
</tt></pre>
<br>
<b><big><a name="Source Code" id="Source Code">Source Code</a></big></b>

<pre><tt>
<b><font color="#000080">import</font></b> random
<b><font color="#000080">from</font></b> math <b><font color="#000080">import</font></b> exp
<b><font color="#000080">import</font></b> sys
<b><font color="#000080">import</font></b> os
<b><font color="#000080">import</font></b> copy
test_program <font color="#990000">=</font> <font color="#FF0000">'example/user/one_function.py'</font>
<b><font color="#0000FF">if</font></b> sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#990000">!=</font> test_program  <b><font color="#0000FF">or</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">:</font>
     usage  <font color="#990000">=</font> <font color="#FF0000">'python3 '</font> <font color="#990000">+</font> test_program <font color="#990000">+</font> <font color="#FF0000">'\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'where python3 is the python 3 program on your system\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'and working directory is the dismod_at distribution directory\n'</font>
     sys<font color="#990000">.</font><b><font color="#000000">exit</font></b><font color="#990000">(</font>usage<font color="#990000">)</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font>test_program<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># import dismod_at</font></i>
local_dir <font color="#990000">=</font> os<font color="#990000">.</font><b><font color="#000000">getcwd</font></b><font color="#990000">()</font> <font color="#990000">+</font> <font color="#FF0000">'/python'</font>
<b><font color="#0000FF">if</font></b><font color="#990000">(</font> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">isdir</font></b><font color="#990000">(</font> local_dir <font color="#990000">+</font> <font color="#FF0000">'/dismod_at'</font> <font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     sys<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">insert</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> local_dir<font color="#990000">)</font>
<b><font color="#000080">import</font></b> dismod_at
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change into the build/example/user directory</font></i>
<b><font color="#0000FF">if</font></b> <b><font color="#0000FF">not</font></b> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">exists</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font> <font color="#990000">:</font>
    os<font color="#990000">.</font><b><font color="#000000">makedirs</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
os<font color="#990000">.</font><b><font color="#000000">chdir</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
random<font color="#990000">.</font><b><font color="#000000">seed</font></b><font color="#990000">(</font>random_seed<font color="#990000">)</font>
<i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">example_db</font></b> <font color="#990000">(</font>file_name<font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_prevalence</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_prevalence'</font><font color="#990000">,</font> <font color="#FF0000">'prior_dage'</font><font color="#990000">,</font> <font color="#FF0000">'prior_dtime'</font><font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_mulcov</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">):</font>
          <b><font color="#0000FF">return</font></b><font color="#990000">(</font><font color="#FF0000">'prior_mulcov'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># age table:</font></i>
     age_list    <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">0.0</font><font color="#990000">,</font> <font color="#993399">5.0</font><font color="#990000">,</font> <font color="#993399">10.0</font><font color="#990000">,</font> <font color="#993399">20.0</font><font color="#990000">,</font> <font color="#993399">40.0</font><font color="#990000">,</font> <font color="#993399">60.0</font><font color="#990000">,</font> <font color="#993399">80.0</font><font color="#990000">,</font> <font color="#993399">100.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># time table:</font></i>
     time_list   <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">1990.0</font><font color="#990000">,</font> <font color="#993399">2200.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># integrand table:</font></i>
     integrand_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'remission'</font> <font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># node table:</font></i>
     node_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'world'</font><font color="#990000">,</font> <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">''</font> <font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># weight table:</font></i>
     weight_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># covariate table:</font></i>
     covariate_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font><font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'income'</font><font color="#990000">,</font> <font color="#FF0000">'reference'</font><font color="#990000">:</font>income_reference<font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># mulcov table:</font></i>
     <b><font color="#0000FF">if</font></b> income_mulcov_type <font color="#990000">==</font> <font color="#FF0000">'rate_value'</font> <font color="#990000">:</font>
          effected <font color="#990000">=</font> <font color="#FF0000">'rho'</font>
     <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
          <b><font color="#0000FF">assert</font></b> income_mulcov_type <font color="#990000">==</font> <font color="#FF0000">'meas_value'</font>
          effected <font color="#990000">=</font> <font color="#FF0000">'remission'</font>
     mulcov_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font>
               <font color="#FF0000">'covariate'</font><font color="#990000">:</font> <font color="#FF0000">'income'</font><font color="#990000">,</font>
               <font color="#FF0000">'type'</font><font color="#990000">:</font>      income_mulcov_type<font color="#990000">,</font>
               <font color="#FF0000">'effected'</font><font color="#990000">:</font>  effected<font color="#990000">,</font>
               <font color="#FF0000">'group'</font><font color="#990000">:</font>     <font color="#FF0000">'world'</font><font color="#990000">,</font>
               <font color="#FF0000">'smooth'</font><font color="#990000">:</font>    <font color="#FF0000">'smooth_mulcov'</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># avgint table: empty</font></i>
     avgint_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># nslist_table:</font></i>
     nslist_table <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># data table:</font></i>
     data_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># values that are the same for all data rows</font></i>
     row <font color="#990000">=</font> <font color="#990000">{</font>
          <font color="#FF0000">'node'</font><font color="#990000">:</font>        <font color="#FF0000">'world'</font><font color="#990000">,</font>
          <font color="#FF0000">'subgroup'</font><font color="#990000">:</font>    <font color="#FF0000">'world'</font><font color="#990000">,</font>
          <font color="#FF0000">'integrand'</font><font color="#990000">:</font>   <font color="#FF0000">'remission'</font><font color="#990000">,</font>
          <font color="#FF0000">'density'</font><font color="#990000">:</font>     <font color="#FF0000">'log_gaussian'</font><font color="#990000">,</font>
          <font color="#FF0000">'weight'</font><font color="#990000">:</font>      <font color="#FF0000">''</font><font color="#990000">,</font>
          <font color="#FF0000">'hold_out'</font><font color="#990000">:</font>     False<font color="#990000">,</font>
          <font color="#FF0000">'time_lower'</font><font color="#990000">:</font>   <font color="#993399">2000</font><font color="#990000">.,</font>
          <font color="#FF0000">'time_upper'</font><font color="#990000">:</font>   <font color="#993399">2000</font><font color="#990000">.,</font>
          <font color="#FF0000">'eta'</font><font color="#990000">:</font>          prevalence_eta
     <font color="#990000">}</font>
     n_data   <font color="#990000">=</font> <font color="#993399">2000</font>
     n_income <font color="#990000">=</font> <font color="#993399">30</font>
     <b><font color="#0000FF">for</font></b> data_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>n_data<font color="#990000">)</font> <font color="#990000">:</font>
          age           <font color="#990000">=</font> <font color="#993399">100.0</font> <font color="#990000">*</font> data_id <font color="#990000">/</font> <b><font color="#000000">float</font></b><font color="#990000">(</font>n_data <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">)</font>
          income        <font color="#990000">=</font> <font color="#990000">(</font>data_id <font color="#990000">%</font> n_income<font color="#990000">)</font>  <font color="#990000">/</font> <b><font color="#000000">float</font></b><font color="#990000">(</font>n_income <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">)</font>
          income_effect <font color="#990000">=</font> <font color="#990000">(</font>income <font color="#990000">-</font> income_reference<font color="#990000">)</font> <font color="#990000">*</font> income_multiplier
          eta           <font color="#990000">=</font> prevalence_eta
          sigma         <font color="#990000">=</font> prevalence_sigma
          log_noise     <font color="#990000">=</font> random<font color="#990000">.</font><b><font color="#000000">gauss</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> sigma<font color="#990000">)</font>
          y             <font color="#990000">=</font> <b><font color="#000000">exp</font></b><font color="#990000">(</font>log_noise<font color="#990000">)</font> <font color="#990000">*</font> <b><font color="#000000">Prevalence</font></b><font color="#990000">(</font>age<font color="#990000">)</font> <font color="#990000">*</font> <b><font color="#000000">exp</font></b><font color="#990000">(</font>income_effect<font color="#990000">)</font>
          Delta         <font color="#990000">=</font> <font color="#990000">(</font> <b><font color="#000000">exp</font></b><font color="#990000">(</font>sigma<font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">1</font> <font color="#990000">)</font> <font color="#990000">*</font> <font color="#990000">(</font> y <font color="#990000">+</font> eta <font color="#990000">)</font>
          row<font color="#990000">[</font><font color="#FF0000">'age_lower'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
          row<font color="#990000">[</font><font color="#FF0000">'age_upper'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
          row<font color="#990000">[</font><font color="#FF0000">'income'</font><font color="#990000">]</font>     <font color="#990000">=</font> income
          row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font> <font color="#990000">=</font> y
          row<font color="#990000">[</font><font color="#FF0000">'meas_std'</font><font color="#990000">]</font>   <font color="#990000">=</font> Delta
          data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># prior_table</font></i>
     prior_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <i><font color="#9A1900"># prior_prevalence</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_prevalence'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'lower'</font><font color="#990000">:</font>    <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'upper'</font><font color="#990000">:</font>    <font color="#993399">1.0</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.01</font><font color="#990000">,</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_dage</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_dage'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'log_gaussian'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      <font color="#993399">2.0</font><font color="#990000">,</font>
               <font color="#FF0000">'eta'</font><font color="#990000">:</font>      prevalence_eta<font color="#990000">,</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_dtime</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_dtime'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'log_gaussian'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      <font color="#993399">0.1</font><font color="#990000">,</font>
               <font color="#FF0000">'eta'</font><font color="#990000">:</font>      prevalence_eta<font color="#990000">,</font>
          <font color="#990000">},</font> <font color="#990000">{</font> <i><font color="#9A1900"># prior_mulcov</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_mulcov'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'lower'</font><font color="#990000">:</font>    <font color="#990000">-</font><font color="#993399">2.0</font><font color="#990000">,</font>
               <font color="#FF0000">'upper'</font><font color="#990000">:</font>    <font color="#990000">+</font><font color="#993399">2.0</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># smooth table</font></i>
     smooth_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     name    <font color="#990000">=</font> <font color="#FF0000">'smooth_prevalence'</font>
     fun     <font color="#990000">=</font> fun_prevalence
     age_id  <font color="#990000">=</font> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>age_list<font color="#990000">)</font> <font color="#990000">)</font>
     time_id <font color="#990000">=</font> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>time_list<font color="#990000">)</font> <font color="#990000">)</font>
     smooth_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font>
          <font color="#990000">{</font><font color="#FF0000">'name'</font><font color="#990000">:</font>name<font color="#990000">,</font> <font color="#FF0000">'age_id'</font><font color="#990000">:</font>age_id<font color="#990000">,</font> <font color="#FF0000">'time_id'</font><font color="#990000">:</font>time_id<font color="#990000">,</font> <font color="#FF0000">'fun'</font><font color="#990000">:</font>fun <font color="#990000">}</font>
     <font color="#990000">)</font>
     name <font color="#990000">=</font> <font color="#FF0000">'smooth_mulcov'</font>
     fun  <font color="#990000">=</font> fun_mulcov
     smooth_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font>
          <font color="#990000">{</font><font color="#FF0000">'name'</font><font color="#990000">:</font>name<font color="#990000">,</font> <font color="#FF0000">'age_id'</font><font color="#990000">:[</font><font color="#993399">0</font><font color="#990000">],</font> <font color="#FF0000">'time_id'</font><font color="#990000">:[</font><font color="#993399">0</font><font color="#990000">],</font> <font color="#FF0000">'fun'</font><font color="#990000">:</font>fun <font color="#990000">}</font>
     <font color="#990000">)</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># rate table:</font></i>
     rate_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font>    <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'rho'</font><font color="#990000">,</font>
               <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_prevalence'</font><font color="#990000">,</font>
               <font color="#FF0000">'child_smooth'</font><font color="#990000">:</font>  None<font color="#990000">,</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># option_table</font></i>
     option_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'rate_case'</font><font color="#990000">,</font>              <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'no_ode'</font>       <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'parent_node_name'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'world'</font>        <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'ode_step_size'</font><font color="#990000">,</font>          <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'5.0'</font>          <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'random_seed'</font><font color="#990000">,</font>            <font color="#FF0000">'value'</font><font color="#990000">:</font>random_seed    <font color="#990000">},</font>

          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'quasi_fixed'</font><font color="#990000">,</font>            <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'false'</font>        <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'derivative_test_fixed'</font><font color="#990000">,</font>  <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'first-order'</font>  <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_fixed'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'100'</font>          <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_fixed'</font><font color="#990000">,</font>      <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'0'</font>            <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_fixed'</font><font color="#990000">,</font>        <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-8'</font>         <font color="#990000">},</font>

          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'derivative_test_random'</font><font color="#990000">,</font> <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'second-order'</font> <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_random'</font><font color="#990000">,</font>    <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'100'</font>          <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_random'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'0'</font>            <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_random'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-8'</font>         <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># subgroup_table</font></i>
     subgroup_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'world'</font><font color="#990000">,</font> <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'world'</font> <font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># create database</font></i>
     dismod_at<font color="#990000">.</font><b><font color="#000000">create_database</font></b><font color="#990000">(</font>
          file_name<font color="#990000">,</font>
          age_list<font color="#990000">,</font>
          time_list<font color="#990000">,</font>
          integrand_table<font color="#990000">,</font>
          node_table<font color="#990000">,</font>
          subgroup_table<font color="#990000">,</font>
          weight_table<font color="#990000">,</font>
          covariate_table<font color="#990000">,</font>
          avgint_table<font color="#990000">,</font>
          data_table<font color="#990000">,</font>
          prior_table<font color="#990000">,</font>
          smooth_table<font color="#990000">,</font>
          nslist_table<font color="#990000">,</font>
          rate_table<font color="#990000">,</font>
          mulcov_table<font color="#990000">,</font>
          option_table
     <font color="#990000">)</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <b><font color="#0000FF">return</font></b>
<i><font color="#9A1900"># ===========================================================================</font></i>
<i><font color="#9A1900"># create database</font></i>
file_name <font color="#990000">=</font> <font color="#FF0000">'example.db'</font>
<b><font color="#000000">example_db</font></b><font color="#990000">(</font>file_name<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># fun a fit</font></i>
program <font color="#990000">=</font> <font color="#FF0000">'../../devel/dismod_at'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'init'</font> <font color="#990000">])</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'both'</font> <font color="#990000">])</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># read database</font></i>
new           <font color="#990000">=</font> False
connection    <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
var_table     <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
fit_var_table <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
age_table     <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'age'</font><font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># check fit results</font></i>
<i><font color="#9A1900">#</font></i>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     fit_var_value <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
     var_type      <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
     true_value    <font color="#990000">=</font> None
     <b><font color="#0000FF">if</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'mulcov_'</font> <font color="#990000">+</font> income_mulcov_type <font color="#990000">:</font>
          true_value <font color="#990000">=</font> income_multiplier
     <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
          <b><font color="#0000FF">assert</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'rate'</font>
          age_id     <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'age_id'</font><font color="#990000">]</font>
          age        <font color="#990000">=</font> age_table<font color="#990000">[</font>age_id<font color="#990000">][</font><font color="#FF0000">'age'</font><font color="#990000">]</font>
          true_value <font color="#990000">=</font> <b><font color="#000000">Prevalence</font></b><font color="#990000">(</font>age<font color="#990000">)</font>
     <b><font color="#0000FF">if</font></b> true_value <font color="#990000">&gt;</font> <font color="#993399">10.0</font> <font color="#990000">*</font> prevalence_eta  <font color="#990000">:</font>
          rel_error <font color="#990000">=</font> fit_var_value <font color="#990000">/</font> true_value <font color="#990000">-</font> <font color="#993399">1.0</font>
     <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
          rel_error <font color="#990000">=</font> fit_var_value <font color="#990000">-</font> true_value
     <b><font color="#0000FF">if</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>rel_error<font color="#990000">)</font> <font color="#990000">&gt;</font> <font color="#993399">0.05</font> <font color="#990000">:</font>
          <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'fit_var_value = '</font><font color="#990000">,</font> var_fit_value<font color="#990000">)</font>
          <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'true_value    = '</font><font color="#990000">,</font> true_value<font color="#990000">)</font>
          <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'random_seed   = '</font><font color="#990000">,</font> random_seed<font color="#990000">)</font>
     <b><font color="#0000FF">assert</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>rel_error<font color="#990000">)</font> <font color="#990000">&lt;</font> <font color="#993399">0.05</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
connection<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">()</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'one_function.py: OK'</font><font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i></tt></pre>

<hr>Input File: example/user/one_function.py

</body>
</html>
