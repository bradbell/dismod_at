<html>
<script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath:  [ ['@(@','@)@'] ] ,
    displayMath: [ ['@[@','@]@'] ]
  }
});
</script>
<script type='text/javascript' src=
'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=default'
>
</script>
<head>
<title>Example Fitting With Subgroup Covariate Multipliers</title>
<meta http-equiv='Content-Type' content='text/html' charset='utf-8'>
<meta name="description" id="description" content="Example Fitting With Subgroup Covariate Multipliers">
<meta name="keywords" id="keywords" content=" example fitting with subgroup covariate multipliers node table model variables parent rates group multiplier child rate effects mulcov data problem parameters source code ">
<style type='text/css'>
body { color : black }
body { background-color : white }
A:link { color : blue }
A:visited { color : purple }
A:active { color : purple }
</style>
<script type='text/javascript' language='JavaScript' src='_user_subgroup_mulcov.py_htm.js'>
</script>
</head>
<body>
<table><tr>
<td>
<a href="https://bradbell.github.io/dismod_at" target="_top"><img border="0" src="_image.gif"></a>
</td>
<td>
<select onchange='choose_up0(this)'>
<option>Location-&gt;</option>
<option>dismod_at</option>
<option>user</option>
<option>user_subgroup_mulcov.py</option>
</select>
</td>
<td>
<select onchange='choose_across0(this)'>
<option>Search-&gt;</option>
<option>contents</option>
<option>reference</option>
<option>index</option>
<option>search</option>
<option>external</option>
</select>
</td>
<td><a href="user_students.py.htm" target="_top">Prev</a>
</td><td><a href="user_zsum_child_rate.py.htm" target="_top">Next</a>
</td><td>
<script type='text/javascript' language='JavaScript' src='_childtable_dismod_at_htm.js'></script>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_user_htm.js'></script>
</td>
<td>user_subgroup_mulcov.py</td>
</tr></table><br>
@(@\newcommand{\R}[1]{ {\rm #1} }
\newcommand{\B}[1]{ {\bf #1} }
\newcommand{\W}[1]{ \; #1 \; }@)@<center><b><big><big>Example Fitting With Subgroup Covariate Multipliers</big></big></b></center>

<br><a href="user_subgroup_mulcov.py.htm#Node Table" target="_top">Node&nbsp;Table</a>
<br><a href="user_subgroup_mulcov.py.htm#Subgroup Table" target="_top">Subgroup&nbsp;Table</a>
<br><a href="user_subgroup_mulcov.py.htm#Model Variables" target="_top">Model&nbsp;Variables</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_subgroup_mulcov.py.htm#Model Variables.Parent Rates" target="_top">Parent&nbsp;Rates</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_subgroup_mulcov.py.htm#Model Variables.Group Covariate Multiplier" target="_top">Group&nbsp;Covariate&nbsp;Multiplier</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_subgroup_mulcov.py.htm#Model Variables.Child Rate Effects" target="_top">Child&nbsp;Rate&nbsp;Effects</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_subgroup_mulcov.py.htm#Model Variables.Subgroup Covariate Multiplier" target="_top">Subgroup&nbsp;Covariate&nbsp;Multiplier</a>
<br><a href="user_subgroup_mulcov.py.htm#Rate Table" target="_top">Rate&nbsp;Table</a>
<br><a href="user_subgroup_mulcov.py.htm#Mulcov Table" target="_top">Mulcov&nbsp;Table</a>
<br><a href="user_subgroup_mulcov.py.htm#Data Table" target="_top">Data&nbsp;Table</a>
<br><a href="user_subgroup_mulcov.py.htm#Problem Parameters" target="_top">Problem&nbsp;Parameters</a>
<br><a href="user_subgroup_mulcov.py.htm#Source Code" target="_top">Source&nbsp;Code</a>
<br><br>
<b><big><a name="Node Table" id="Node Table">Node Table</a></big></b>
<br>
The following is a diagram of the node tree for this example:
<code><span style='white-space: nowrap'><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;\<br>
&nbsp;&nbsp;&nbsp;&nbsp;c1&nbsp;&nbsp;c2<br>
</span></code><br>
<b><big><a name="Subgroup Table" id="Subgroup Table">Subgroup Table</a></big></b>
<br>
The following is a diagram of the subgroup tree for this example:
<code><span style='white-space: nowrap'><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;\<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g1&nbsp;&nbsp;&nbsp;none<br>
&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;\&nbsp;&nbsp;&nbsp;&nbsp;\<br>
&nbsp;&nbsp;&nbsp;s1&nbsp;&nbsp;&nbsp;s2&nbsp;&nbsp;none<br>
</span></code><br>
<b><big><a name="Model Variables" id="Model Variables">Model Variables</a></big></b>


<br>
<br>
<big><a name="Model Variables.Parent Rates" id="Model Variables.Parent Rates">Parent Rates</a></big>
<br>
There is an iota
<a href="model_variables.htm#Fixed Effects, theta.Parent Rates" target="_top"><span style='white-space: nowrap'>parent&nbsp;rate</span></a>

corresponding to node p1.

<br>
<br>
<big><a name="Model Variables.Group Covariate Multiplier" id="Model Variables.Group Covariate Multiplier">Group Covariate Multiplier</a></big>
<br>
There is a
<a href="model_variables.htm#Fixed Effects, theta.Group Covariate Multipliers" target="_top"><span style='white-space: nowrap'>group&nbsp;covariate&nbsp;multiplier</span></a>

that affects all the data in group g1.

<br>
<br>
<big><a name="Model Variables.Child Rate Effects" id="Model Variables.Child Rate Effects">Child Rate Effects</a></big>
<br>
There are two
<a href="model_variables.htm#Random Effects, u.Child Rate Effects" target="_top"><span style='white-space: nowrap'>child&nbsp;rate&nbsp;effects</span></a>

one for the data corresponding to child c1,
the other for child c2.

<br>
<br>
<big><a name="Model Variables.Subgroup Covariate Multiplier" id="Model Variables.Subgroup Covariate Multiplier">Subgroup Covariate Multiplier</a></big>
<br>
There are two
<a href="model_variables.htm#Random Effects, u.Subgroup Covariate Multipliers" target="_top"><span style='white-space: nowrap'>subgroup&nbsp;covariate&nbsp;multipliers</span></a>

one for the data corresponding to subgroup s1,
the other for subgroup s2.

<br>
<br>
<b><big><a name="Rate Table" id="Rate Table">Rate Table</a></big></b>
<br>
There is one entry in the rate table that
specifies the iota smoothing for the parent node p1.
There is another entry that specifies the iota smoothing
for the child nodes c1, c2.

<br>
<br>
<b><big><a name="Mulcov Table" id="Mulcov Table">Mulcov Table</a></big></b>
<br>
There is one entry in the mulcov table for group g1 and
the two subgroups s1, s1 (that make up g1).
The group smoothing is used for the fixed effect corresponding to g1
and the subgroup smoothing is used for the s1, s2 random effects.

<br>
<br>
<b><big><a name="Data Table" id="Data Table">Data Table</a></big></b>
<br>
Each child (c1, c2) and each subgroup (s1, s2, none)
have a corresponding data point that is simulated without any noise.

<br>
<br>
<b><big><a name="Problem Parameters" id="Problem Parameters">Problem Parameters</a></big></b>

<pre><tt>iota_parent_true      <font color="#990000">=</font> <font color="#993399">0.01</font> <i><font color="#9A1900"># value corresponding to parent with no effects</font></i>
group_effect_true     <font color="#990000">=</font> <font color="#993399">0.3</font>  <i><font color="#9A1900"># value corresponding to group g1</font></i>
child_effect_true     <font color="#990000">=</font> <font color="#993399">0.2</font>  <i><font color="#9A1900"># absolute value of child random effects</font></i>
subgroup_effect_true  <font color="#990000">=</font> <font color="#993399">0.1</font>  <i><font color="#9A1900"># absoulte value of subgroup random effects</font></i>
meas_cv               <font color="#990000">=</font> <font color="#993399">0.1</font>  <i><font color="#9A1900"># coefficient of variation for each data point</font></i></tt></pre>
<br>
<b><big><a name="Source Code" id="Source Code">Source Code</a></big></b>

<pre><tt>
<i><font color="#9A1900">#</font></i>
<b><font color="#000080">import</font></b> sys
<b><font color="#000080">import</font></b> os
<b><font color="#000080">import</font></b> distutils<font color="#990000">.</font>dir_util
<b><font color="#000080">import</font></b> copy
<b><font color="#000080">import</font></b> random
<b><font color="#000080">import</font></b> math
<b><font color="#000080">import</font></b> numpy
<b><font color="#000080">import</font></b> shutil
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># run in build/exampe/user using local (not installed) version of dismod_at</font></i>
test_program <font color="#990000">=</font> <font color="#FF0000">'example/user/subgroup_mulcov.py'</font>
<b><font color="#0000FF">if</font></b> sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#990000">!=</font> test_program  <b><font color="#0000FF">or</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">:</font>
     usage  <font color="#990000">=</font> <font color="#FF0000">'python3 '</font> <font color="#990000">+</font> test_program <font color="#990000">+</font> <font color="#FF0000">'\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'where python3 is the python 3 program on your system\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'and working directory is the dismod_at distribution directory\n'</font>
     sys<font color="#990000">.</font><b><font color="#000000">exit</font></b><font color="#990000">(</font>usage<font color="#990000">)</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font>test_program<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># import dismod_at</font></i>
local_dir <font color="#990000">=</font> os<font color="#990000">.</font><b><font color="#000000">getcwd</font></b><font color="#990000">()</font> <font color="#990000">+</font> <font color="#FF0000">'/python'</font>
<b><font color="#0000FF">if</font></b><font color="#990000">(</font> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">isdir</font></b><font color="#990000">(</font> local_dir <font color="#990000">+</font> <font color="#FF0000">'/dismod_at'</font> <font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     sys<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">insert</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> local_dir<font color="#990000">)</font>
<b><font color="#000080">import</font></b> dismod_at
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change into the build/example/user directory</font></i>
distutils<font color="#990000">.</font>dir_util<font color="#990000">.</font><b><font color="#000000">mkpath</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
os<font color="#990000">.</font><b><font color="#000000">chdir</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">avg_integrand</font></b><font color="#990000">(</font>child<font color="#990000">,</font> subgroup<font color="#990000">)</font> <font color="#990000">:</font>
     effect <font color="#990000">=</font> <font color="#993399">0.0</font>
     <b><font color="#0000FF">if</font></b> subgroup <font color="#990000">==</font> <font color="#FF0000">'s1'</font> <font color="#990000">:</font>
          effect <font color="#990000">+=</font> subgroup_effect_true <font color="#990000">+</font> group_effect_true
     <b><font color="#0000FF">elif</font></b> subgroup <font color="#990000">==</font> <font color="#FF0000">'s2'</font> <font color="#990000">:</font>
          effect <font color="#990000">+=</font> <font color="#990000">-</font> subgroup_effect_true <font color="#990000">+</font> group_effect_true
     <b><font color="#0000FF">if</font></b> child <font color="#990000">==</font> <font color="#FF0000">'c1'</font> <font color="#990000">:</font>
          effect <font color="#990000">+=</font> child_effect_true
     <b><font color="#0000FF">elif</font></b> child <font color="#990000">==</font> <font color="#FF0000">'c2'</font> <font color="#990000">:</font>
          effect <font color="#990000">+=</font> <font color="#990000">-</font> child_effect_true
     <i><font color="#9A1900">#</font></i>
     <b><font color="#0000FF">return</font></b> iota_parent_true <font color="#990000">*</font> math<font color="#990000">.</font><b><font color="#000000">exp</font></b><font color="#990000">(</font>effect<font color="#990000">)</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># example.db function</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">example_db</font></b> <font color="#990000">(</font>file_name<font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_parent</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_parent_value'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_child</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_child'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_group</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_group'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_subgroup</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_subgroup'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># age_table</font></i>
     age_list <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">0.0</font><font color="#990000">,</font> <font color="#993399">100.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># time_table</font></i>
     time_list <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">1990.0</font><font color="#990000">,</font> <font color="#993399">2020.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># node_table</font></i>
     node_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'p1'</font><font color="#990000">,</font>      <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">''</font>    <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'c1'</font><font color="#990000">,</font>      <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'p1'</font>  <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'c2'</font><font color="#990000">,</font>      <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'p1'</font>  <font color="#990000">},</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># subgroup_table</font></i>
     subgroup_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'none'</font><font color="#990000">,</font>  <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'none'</font> <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'s1'</font><font color="#990000">,</font>    <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'g1'</font>   <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'s2'</font><font color="#990000">,</font>    <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'g1'</font>   <font color="#990000">},</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># rate_table</font></i>
     rate_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font>
          <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'iota'</font><font color="#990000">,</font>
          <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_iota_parent'</font><font color="#990000">,</font>
          <font color="#FF0000">'child_smooth'</font><font color="#990000">:</font>  <font color="#FF0000">'smooth_iota_child'</font><font color="#990000">,</font>
     <font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># covariate_table</font></i>
     covariate_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'one'</font><font color="#990000">,</font>    <font color="#FF0000">'reference'</font><font color="#990000">:</font><font color="#993399">0.0</font> <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># mulcov_table</font></i>
     mulcov_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font>
          <font color="#FF0000">'covariate'</font><font color="#990000">:</font> <font color="#FF0000">'one'</font><font color="#990000">,</font>
          <font color="#FF0000">'type'</font><font color="#990000">:</font>      <font color="#FF0000">'rate_value'</font><font color="#990000">,</font>
          <font color="#FF0000">'effected'</font><font color="#990000">:</font>  <font color="#FF0000">'iota'</font><font color="#990000">,</font>
          <font color="#FF0000">'group'</font><font color="#990000">:</font>     <font color="#FF0000">'g1'</font><font color="#990000">,</font>
          <font color="#FF0000">'smooth'</font><font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_group'</font><font color="#990000">,</font>
          <font color="#FF0000">'subsmooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_iota_subgroup'</font><font color="#990000">,</font>
     <font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># prior_table</font></i>
     prior_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font>   <i><font color="#9A1900"># prior_iota_parent_value</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_parent_value'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'lower'</font><font color="#990000">:</font>   iota_parent_true <font color="#990000">/</font> <font color="#993399">100.0</font><font color="#990000">,</font>
               <font color="#FF0000">'upper'</font><font color="#990000">:</font>   iota_parent_true <font color="#990000">*</font> <font color="#993399">100.0</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>    iota_parent_true <font color="#990000">/</font> <font color="#993399">2.0</font><font color="#990000">,</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_iota_child</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_child'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">1e-3</font><font color="#990000">,</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_iota_group</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_group'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_iota_subgroup</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_subgroup'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">1e-3</font><font color="#990000">,</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># smooth_table</font></i>
     smooth_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font>   <i><font color="#9A1900"># smooth_iota_parent</font></i>
               <font color="#FF0000">'name'</font> <font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_parent'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota_parent
          <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_iota_child</font></i>
               <font color="#FF0000">'name'</font> <font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_child'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota_child
          <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_iota_group</font></i>
               <font color="#FF0000">'name'</font> <font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_group'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota_group
          <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_iota_subgroup</font></i>
               <font color="#FF0000">'name'</font> <font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_subgroup'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota_subgroup
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># weight table:</font></i>
     weight_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># nslist_table</font></i>
     nslist_table <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># option_table</font></i>
     option_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'parent_node_name'</font><font color="#990000">,</font>      <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'p1'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'rate_case'</font><font color="#990000">,</font>             <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'iota_pos_rho_zero'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'zero_sum_child_rate'</font><font color="#990000">,</font>   <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'iota'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'zero_sum_mulcov_group'</font><font color="#990000">,</font> <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'g1'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'quasi_fixed'</font><font color="#990000">,</font>           <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'false'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_fixed'</font><font color="#990000">,</font>    <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'100'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_fixed'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'0'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_fixed'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-12'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'derivative_test_fixed'</font><font color="#990000">,</font> <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'adaptive'</font><font color="#990000">},</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># integrand_table</font></i>
     integrand_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font><font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'Sincidence'</font><font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># data_table</font></i>
     data_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># values that are the same for all data points</font></i>
     row <font color="#990000">=</font> <font color="#990000">{</font>
          <font color="#FF0000">'integrand'</font><font color="#990000">:</font>   <font color="#FF0000">'Sincidence'</font><font color="#990000">,</font>
          <font color="#FF0000">'density'</font><font color="#990000">:</font>     <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
          <font color="#FF0000">'weight'</font><font color="#990000">:</font>      <font color="#FF0000">''</font><font color="#990000">,</font>
          <font color="#FF0000">'hold_out'</font><font color="#990000">:</font>    False<font color="#990000">,</font>
          <font color="#FF0000">'age_lower'</font><font color="#990000">:</font>   <font color="#993399">50.0</font><font color="#990000">,</font>
          <font color="#FF0000">'age_upper'</font><font color="#990000">:</font>   <font color="#993399">50.0</font><font color="#990000">,</font>
          <font color="#FF0000">'time_lower'</font><font color="#990000">:</font>  <font color="#993399">2000.0</font><font color="#990000">,</font>
          <font color="#FF0000">'time_upper'</font><font color="#990000">:</font>  <font color="#993399">2000.0</font><font color="#990000">,</font>
          <font color="#FF0000">'one'</font><font color="#990000">:</font>         <font color="#993399">1.0</font><font color="#990000">,</font>
     <font color="#990000">}</font>
     <b><font color="#0000FF">for</font></b> child <b><font color="#0000FF">in</font></b> <font color="#990000">[</font> <font color="#FF0000">'c1'</font><font color="#990000">,</font> <font color="#FF0000">'c2'</font> <font color="#990000">]</font> <font color="#990000">:</font>
          <b><font color="#0000FF">for</font></b> subgroup <b><font color="#0000FF">in</font></b> <font color="#990000">[</font> <font color="#FF0000">'s1'</font><font color="#990000">,</font> <font color="#FF0000">'s2'</font><font color="#990000">,</font> <font color="#FF0000">'none'</font> <font color="#990000">]</font> <font color="#990000">:</font>
               <i><font color="#9A1900"># true value of iota for this child, subgroup</font></i>
               iota       <font color="#990000">=</font> <b><font color="#000000">avg_integrand</font></b><font color="#990000">(</font>child<font color="#990000">,</font> subgroup<font color="#990000">)</font>
               <i><font color="#9A1900"># measurement standard deviation is used during fittting</font></i>
               meas_std   <font color="#990000">=</font> iota <font color="#990000">*</font> meas_cv
               <i><font color="#9A1900"># for this example, measurements are simulated without any noise</font></i>
               meas_value <font color="#990000">=</font> iota
               <i><font color="#9A1900">#</font></i>
               row<font color="#990000">[</font><font color="#FF0000">'node'</font><font color="#990000">]</font>       <font color="#990000">=</font> child
               row<font color="#990000">[</font><font color="#FF0000">'subgroup'</font><font color="#990000">]</font>   <font color="#990000">=</font> subgroup
               row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font> <font color="#990000">=</font> meas_value
               row<font color="#990000">[</font><font color="#FF0000">'meas_std'</font><font color="#990000">]</font>   <font color="#990000">=</font> meas_std
               data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
     <i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># avgint_table</font></i>
     avgint_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># create database</font></i>
     dismod_at<font color="#990000">.</font><b><font color="#000000">create_database</font></b><font color="#990000">(</font>
          file_name<font color="#990000">,</font>
          age_list<font color="#990000">,</font>
          time_list<font color="#990000">,</font>
          integrand_table<font color="#990000">,</font>
          node_table<font color="#990000">,</font>
          subgroup_table<font color="#990000">,</font>
          weight_table<font color="#990000">,</font>
          covariate_table<font color="#990000">,</font>
          avgint_table<font color="#990000">,</font>
          data_table<font color="#990000">,</font>
          prior_table<font color="#990000">,</font>
          smooth_table<font color="#990000">,</font>
          nslist_table<font color="#990000">,</font>
          rate_table<font color="#990000">,</font>
          mulcov_table<font color="#990000">,</font>
          option_table
     <font color="#990000">)</font>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Fit Both</font></i>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># create the database</font></i>
file_name  <font color="#990000">=</font> <font color="#FF0000">'example.db'</font>
<b><font color="#000000">example_db</font></b><font color="#990000">(</font>file_name<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># initialize the database</font></i>
program <font color="#990000">=</font> <font color="#FF0000">'../../devel/dismod_at'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">(</font> <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'init'</font> <font color="#990000">]</font> <font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># fit both the fixed and random effects</font></i>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">(</font> <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'both'</font> <font color="#990000">]</font> <font color="#990000">)</font>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Compare Fit and Truth</font></i>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># read var table and supporting information including the fit</font></i>
new              <font color="#990000">=</font> False
connection       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
subgroup_table   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'subgroup'</font><font color="#990000">)</font>
node_table       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'node'</font><font color="#990000">)</font>
var_table        <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
fit_var_table    <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
n_var            <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check fit results</font></i>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>n_var<font color="#990000">)</font> <font color="#990000">:</font>
     fit_var_value  <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
     var_type       <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
     name           <font color="#990000">=</font> None
     <b><font color="#0000FF">if</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'rate'</font> <font color="#990000">:</font>
          node_id  <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'node_id'</font><font color="#990000">]</font>
          name     <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font>
     <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
          <b><font color="#0000FF">assert</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'mulcov_rate_value'</font>
          group_id        <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'group_id'</font><font color="#990000">]</font>
          subgroup_id     <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'subgroup_id'</font><font color="#990000">]</font>
          <b><font color="#0000FF">if</font></b> subgroup_id <b><font color="#0000FF">is</font></b> <b><font color="#0000FF">not</font></b> None <font color="#990000">:</font>
               name  <font color="#990000">=</font> subgroup_table<font color="#990000">[</font>subgroup_id<font color="#990000">][</font><font color="#FF0000">'subgroup_name'</font><font color="#990000">]</font>
          <b><font color="#0000FF">if</font></b> group_id <b><font color="#0000FF">is</font></b> <b><font color="#0000FF">not</font></b> None <font color="#990000">:</font>
               <b><font color="#0000FF">for</font></b> row <b><font color="#0000FF">in</font></b> subgroup_table <font color="#990000">:</font>
                    <b><font color="#0000FF">if</font></b> row<font color="#990000">[</font><font color="#FF0000">'group_id'</font><font color="#990000">]</font> <font color="#990000">==</font> group_id <font color="#990000">:</font>
                         name <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'group_name'</font><font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     truth_var_value <font color="#990000">=</font> <font color="#990000">{</font>
          <font color="#FF0000">'p1'</font><font color="#990000">:</font> iota_parent_true        <font color="#990000">,</font>
          <font color="#FF0000">'c1'</font><font color="#990000">:</font> child_effect_true       <font color="#990000">,</font>
          <font color="#FF0000">'c2'</font><font color="#990000">:</font> <font color="#990000">-</font> child_effect_true     <font color="#990000">,</font>
          <font color="#FF0000">'g1'</font><font color="#990000">:</font> group_effect_true       <font color="#990000">,</font>
          <font color="#FF0000">'s1'</font><font color="#990000">:</font> subgroup_effect_true    <font color="#990000">,</font>
          <font color="#FF0000">'s2'</font><font color="#990000">:</font> <font color="#990000">-</font> subgroup_effect_true  <font color="#990000">,</font>
     <font color="#990000">}</font>
     truth   <font color="#990000">=</font> truth_var_value<font color="#990000">[</font>name<font color="#990000">]</font>
     relerr  <font color="#990000">=</font> <font color="#993399">1.0</font> <font color="#990000">-</font> fit_var_value <font color="#990000">/</font> truth
     <i><font color="#9A1900"># print(name, truth, fit_var_value, relerr)</font></i>
     <b><font color="#0000FF">assert</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>relerr<font color="#990000">)</font> <font color="#990000">&lt;</font> <font color="#993399">1e-10</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'subgroup_mulcov.py: OK'</font><font color="#990000">)</font></tt></pre>

<hr>Input File: example/user/subgroup_mulcov.py

</body>
</html>
