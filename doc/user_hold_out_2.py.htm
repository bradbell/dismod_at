<html>
<script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath:  [ ['@(@','@)@'] ] ,
    displayMath: [ ['@[@','@]@'] ]
  }
});
</script>
<script type='text/javascript' src=
'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=default'
>
</script>
<head>
<title>hold_out Command: Balancing Sex Covariate Values</title>
<meta http-equiv='Content-Type' content='text/html' charset='utf-8'>
<meta name="description" id="description" content="hold_out Command: Balancing Sex Covariate Values">
<meta name="keywords" id="keywords" content=" ">
<style type='text/css'>
body { color : black }
body { background-color : white }
A:link { color : blue }
A:visited { color : purple }
A:active { color : purple }
</style>
<script type='text/javascript' language='JavaScript' src='_user_hold_out_2.py_htm.js'>
</script>
</head>
<body>
<table><tr>
<td>
<a href="https://bradbell.github.io/dismod_at" target="_top"><img border="0" src="_image.gif"></a>
</td>
<td><a href="user_hold_out_1.py.htm" target="_top">Prev</a>
</td><td><a href="user_ill_condition.py.htm" target="_top">Next</a>
</td><td>
<select onchange='choose_across0(this)'>
<option>Index-&gt;</option>
<option>contents</option>
<option>reference</option>
<option>index</option>
<option>search</option>
<option>external</option>
</select>
</td>
<td>
<select onchange='choose_up0(this)'>
<option>Up-&gt;</option>
<option>dismod_at</option>
<option>user_example</option>
<option>user_hold_out_2.py</option>
</select>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_dismod_at_htm.js'></script>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_user_example_htm.js'></script>
</td>
<td>user_hold_out_2.py</td>
</tr></table><br>
@(@\newcommand{\B}[1]{ {\bf #1} }
\newcommand{\R}[1]{ {\rm #1} }
\newcommand{\W}[1]{ \; #1 \; }@)@<center><b><big><big>hold_out Command: Balancing Sex Covariate Values</big></big></b></center>

<br><a href="user_hold_out_2.py.htm#Purpose" target="_top">Purpose</a>
<br><a href="user_hold_out_2.py.htm#Integrands" target="_top">Integrands</a>
<br><a href="user_hold_out_2.py.htm#Nodes" target="_top">Nodes</a>
<br><a href="user_hold_out_2.py.htm#alpha_true" target="_top">alpha_true</a>
<br><a href="user_hold_out_2.py.htm#iota_avg" target="_top">iota_avg</a>
<br><a href="user_hold_out_2.py.htm#True Iota" target="_top">True&nbsp;Iota</a>
<br><a href="user_hold_out_2.py.htm#Parent Node" target="_top">Parent&nbsp;Node</a>
<br><a href="user_hold_out_2.py.htm#Data" target="_top">Data</a>
<br><a href="user_hold_out_2.py.htm#Model" target="_top">Model</a>
<br><a href="user_hold_out_2.py.htm#fitting" target="_top">fitting</a>
<br><a href="user_hold_out_2.py.htm#hold_out" target="_top">hold_out</a>
<br><a href="user_hold_out_2.py.htm#Source Code" target="_top">Source&nbsp;Code</a>
<br><br>
<b><big><a name="Purpose" id="Purpose">Purpose</a></big></b>
<br>
This example shows how to balance
<a href="hold_out_command.htm#Balancing.Covariates" target="_top"><span style='white-space: nowrap'>covariates</span></a>

using the hold_out command.

<br>
<br>
<b><big><a name="Integrands" id="Integrands">Integrands</a></big></b>
<br>
For this example there is only one integrand, <code><font color="blue">Sincidence</font></code>.

<br>
<br>
<b><big><a name="Nodes" id="Nodes">Nodes</a></big></b>
<br>
There are Three nodes, <code><font color="blue">europe</font></code>, <code><font color="blue">germany</font></code> and <code><font color="blue">italy</font></code>.

<br>
<br>
<b><big><a name="alpha_true" id="alpha_true">alpha_true</a></big></b>
<br>
True value of the covariate multiplier used to simulate data:
<pre style='display:inline'><tt>
alpha_true  <font color="#990000">=</font> <font color="#993399">0.3</font>
</tt></pre>
This multiplies the sex covariate and affects 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
.

<br>
<br>
<b><big><a name="iota_avg" id="iota_avg">iota_avg</a></big></b>
<br>
Average value of 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
.
<pre style='display:inline'><tt>
iota_avg    <font color="#990000">=</font> <font color="#993399">0.01</font>
</tt></pre>
<br>
<b><big><a name="True Iota" id="True Iota">True Iota</a></big></b>
<br>
True value for iota used to simulate the data:
<pre><tt><b><font color="#000080">import</font></b> math
<b><font color="#0000FF">def</font></b> <b><font color="#000000">iota_true</font></b><font color="#990000">(</font>node<font color="#990000">,</font> sex<font color="#990000">)</font> <font color="#990000">:</font>
   effect  <font color="#990000">=</font> alpha_true <font color="#990000">*</font> sex
   <b><font color="#0000FF">if</font></b> node <font color="#990000">==</font> <font color="#FF0000">'germany'</font> <font color="#990000">:</font>
      iota    <font color="#990000">=</font> <font color="#993399">1.2</font> <font color="#990000">*</font> iota_avg  <font color="#990000">*</font> math<font color="#990000">.</font><b><font color="#000000">exp</font></b><font color="#990000">(</font> effect <font color="#990000">)</font>
   <b><font color="#0000FF">elif</font></b> node <font color="#990000">==</font> <font color="#FF0000">'italy'</font> <font color="#990000">:</font>
      iota    <font color="#990000">=</font> <font color="#993399">0.8</font> <font color="#990000">*</font> iota_avg <font color="#990000">*</font> math<font color="#990000">.</font><b><font color="#000000">exp</font></b><font color="#990000">(</font> effect <font color="#990000">)</font>
   <b><font color="#0000FF">return</font></b> iota</tt></pre>
<br>
<b><big><a name="Parent Node" id="Parent Node">Parent Node</a></big></b>
<br>
For this example the parent node is europe and we are only fitting
fixed effects, so the variation between germany and italy is noise in
the model.

<br>
<br>
<b><big><a name="Data" id="Data">Data</a></big></b>
<br>
For each node, the data comes in pairs with both sexes represented equally.
The problem with the data is that we are only fitting fixed effects.
Thus the variation in the node for each data point is a confounding
covariate when we sub-sample without balancing the sex covariate.

<br>
<br>
<b><big><a name="Model" id="Model">Model</a></big></b>
<br>
There is only one rate 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
 and it is constant as a function
of age and time. In addition, there is one covariate multiplier
for income.

<br>
<br>
<b><big><a name="fitting" id="fitting">fitting</a></big></b>
<br>
For this example we are only fitting the fixed effects,
so the variation between germany and italy is a confounding covariate.

<br>
<br>
<b><big><a name="hold_out" id="hold_out">hold_out</a></big></b>
<br>
This example uses the version of the hold_out command that includes
<a href="hold_out_command.htm#Balancing.Covariates" target="_top"><span style='white-space: nowrap'>balancing&nbsp;covariates</span></a>
.
Note that balancing the sex covariate leads to much more accurate
estimates of the covariate multiplier 
<code><i><font color="black"><span style='white-space: nowrap'>alpha</span></font></i></code>
.

<br>
<br>
<b><big><a name="Source Code" id="Source Code">Source Code</a></big></b>

<pre><tt>
<i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
<b><font color="#000080">import</font></b> sys
<b><font color="#000080">import</font></b> os
<b><font color="#000080">import</font></b> csv
<b><font color="#000080">import</font></b> copy
<b><font color="#000080">import</font></b> math
test_program <font color="#990000">=</font> <font color="#FF0000">'example/user/hold_out_2.py'</font>
<b><font color="#0000FF">if</font></b> sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#990000">!=</font> test_program  <b><font color="#0000FF">or</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">:</font>
   usage  <font color="#990000">=</font> <font color="#FF0000">'python3 '</font> <font color="#990000">+</font> test_program <font color="#990000">+</font> <font color="#FF0000">'\n'</font>
   usage <font color="#990000">+=</font> <font color="#FF0000">'where python3 is the python 3 program on your system\n'</font>
   usage <font color="#990000">+=</font> <font color="#FF0000">'and working directory is the dismod_at distribution directory\n'</font>
   sys<font color="#990000">.</font><b><font color="#000000">exit</font></b><font color="#990000">(</font>usage<font color="#990000">)</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font>test_program<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># import dismod_at</font></i>
local_dir <font color="#990000">=</font> os<font color="#990000">.</font><b><font color="#000000">getcwd</font></b><font color="#990000">()</font> <font color="#990000">+</font> <font color="#FF0000">'/python'</font>
<b><font color="#0000FF">if</font></b><font color="#990000">(</font> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">isdir</font></b><font color="#990000">(</font> local_dir <font color="#990000">+</font> <font color="#FF0000">'/dismod_at'</font> <font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
   sys<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">insert</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> local_dir<font color="#990000">)</font>
<b><font color="#000080">import</font></b> dismod_at
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change into the build/example/user directory</font></i>
<b><font color="#0000FF">if</font></b> <b><font color="#0000FF">not</font></b> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">exists</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font> <font color="#990000">:</font>
   os<font color="#990000">.</font><b><font color="#000000">makedirs</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
os<font color="#990000">.</font><b><font color="#000000">chdir</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
<i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Note that the a, t values are not used for this example</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">example_db</font></b> <font color="#990000">(</font>file_name<font color="#990000">)</font> <font color="#990000">:</font>
   <i><font color="#9A1900"># note that the a, t values are not used for this case</font></i>
   <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
   <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_alpha</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_alpha'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># age table:</font></i>
   age_list    <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">0.0</font><font color="#990000">,</font> <font color="#993399">100.0</font> <font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># time table:</font></i>
   time_list   <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">1990.0</font><font color="#990000">,</font> <font color="#993399">2200.0</font> <font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># integrand table:</font></i>
   integrand_table <font color="#990000">=</font> <font color="#990000">[</font>
       <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'Sincidence'</font> <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># node table:</font></i>
   node_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'europe'</font><font color="#990000">,</font>  <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">''</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'germany'</font><font color="#990000">,</font> <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'europe'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'italy'</font><font color="#990000">,</font>   <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'europe'</font> <font color="#990000">},</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># weight table:</font></i>
   weight_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># covariate table:</font></i>
   covariate_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font>  <font color="#FF0000">'name'</font><font color="#990000">:</font>           <font color="#FF0000">'sex'</font><font color="#990000">,</font>
         <font color="#FF0000">'reference'</font><font color="#990000">:</font>      <font color="#993399">0.0</font><font color="#990000">,</font>
         <font color="#FF0000">'max_difference'</font><font color="#990000">:</font> <font color="#993399">0.6</font><font color="#990000">,</font>
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># mulcov table:</font></i>
   <i><font color="#9A1900"># use weight_ for covariate name to avoid confusion with other weight</font></i>
   <i><font color="#9A1900"># in data table (this is a problem with create_database).</font></i>
   mulcov_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font>
         <font color="#FF0000">'covariate'</font><font color="#990000">:</font> <font color="#FF0000">'sex'</font><font color="#990000">,</font>
         <font color="#FF0000">'type'</font><font color="#990000">:</font>      <font color="#FF0000">'rate_value'</font><font color="#990000">,</font>
         <font color="#FF0000">'effected'</font><font color="#990000">:</font>  <font color="#FF0000">'iota'</font><font color="#990000">,</font>
         <font color="#FF0000">'smooth'</font><font color="#990000">:</font>    <font color="#FF0000">'smooth_alpha'</font><font color="#990000">,</font>
         <font color="#FF0000">'group'</font><font color="#990000">:</font>     <font color="#FF0000">'world'</font>
   <font color="#990000">}</font> <font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># avgint table: empty</font></i>
   avgint_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># nslist_table:</font></i>
   nslist_table <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># data table:</font></i>
   data_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   row <font color="#990000">=</font> <font color="#990000">{</font>
      <font color="#FF0000">'integrand'</font><font color="#990000">:</font>   <font color="#FF0000">'Sincidence'</font><font color="#990000">,</font>
      <font color="#FF0000">'hold_out'</font><font color="#990000">:</font>    False<font color="#990000">,</font>
      <font color="#FF0000">'density'</font><font color="#990000">:</font>     <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
      <font color="#FF0000">'weight'</font><font color="#990000">:</font>      <font color="#FF0000">''</font><font color="#990000">,</font>
      <font color="#FF0000">'age_lower'</font><font color="#990000">:</font>    <font color="#993399">50.0</font><font color="#990000">,</font>
      <font color="#FF0000">'age_upper'</font><font color="#990000">:</font>    <font color="#993399">50.0</font><font color="#990000">,</font>
      <font color="#FF0000">'time_lower'</font><font color="#990000">:</font>   <font color="#993399">2000</font><font color="#990000">.,</font>
      <font color="#FF0000">'time_upper'</font><font color="#990000">:</font>   <font color="#993399">2000</font><font color="#990000">.,</font>
      <font color="#FF0000">'subgroup'</font><font color="#990000">:</font>     <font color="#FF0000">'world'</font><font color="#990000">,</font>
      <font color="#FF0000">'meas_std'</font><font color="#990000">:</font>    iota_avg <font color="#990000">/</font> <font color="#993399">10.0</font><font color="#990000">,</font>
   <font color="#990000">}</font>
   n_repeat <font color="#990000">=</font> <font color="#993399">20</font>
   <b><font color="#0000FF">for</font></b> i <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>n_repeat<font color="#990000">)</font> <font color="#990000">:</font>
      <i><font color="#9A1900"># sample twice from germany so that original data is not balenced</font></i>
      <b><font color="#0000FF">for</font></b> node <b><font color="#0000FF">in</font></b> <font color="#990000">[</font> <font color="#FF0000">"germany"</font><font color="#990000">,</font> <font color="#FF0000">"germany"</font><font color="#990000">,</font> <font color="#FF0000">"italy"</font> <font color="#990000">]</font> <font color="#990000">:</font>
         <b><font color="#0000FF">for</font></b> sex <b><font color="#0000FF">in</font></b> <font color="#990000">[</font> <font color="#990000">-</font><font color="#993399">0.5</font><font color="#990000">,</font> <font color="#990000">+</font><font color="#993399">0.5</font> <font color="#990000">]</font> <font color="#990000">:</font>
            meas_value <font color="#990000">=</font> <b><font color="#000000">iota_true</font></b><font color="#990000">(</font>node<font color="#990000">,</font> sex<font color="#990000">)</font>
            row<font color="#990000">[</font><font color="#FF0000">'sex'</font><font color="#990000">]</font>        <font color="#990000">=</font> sex
            row<font color="#990000">[</font><font color="#FF0000">'node'</font><font color="#990000">]</font>       <font color="#990000">=</font> node
            row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font> <font color="#990000">=</font> meas_value
            data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># prior_table</font></i>
   prior_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font>  <i><font color="#9A1900"># prior_iota</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_iota'</font><font color="#990000">,</font>
         <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
         <font color="#FF0000">'lower'</font><font color="#990000">:</font>    iota_avg <font color="#990000">/</font> <font color="#993399">10.0</font><font color="#990000">,</font>
         <font color="#FF0000">'upper'</font><font color="#990000">:</font>    iota_avg <font color="#990000">*</font> <font color="#993399">10.0</font><font color="#990000">,</font>
         <font color="#FF0000">'mean'</font><font color="#990000">:</font>     iota_avg <font color="#990000">*</font> <font color="#993399">2.0</font><font color="#990000">,</font>
      <font color="#990000">},{</font> <i><font color="#9A1900"># prior_alpha</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_alpha'</font><font color="#990000">,</font>
         <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
         <font color="#FF0000">'lower'</font><font color="#990000">:</font>    <font color="#990000">-</font> <b><font color="#000000">abs</font></b><font color="#990000">(</font>alpha_true<font color="#990000">)</font> <font color="#990000">*</font> <font color="#993399">10.0</font><font color="#990000">,</font>
         <font color="#FF0000">'upper'</font><font color="#990000">:</font>    <font color="#990000">+</font> <b><font color="#000000">abs</font></b><font color="#990000">(</font>alpha_true<font color="#990000">)</font> <font color="#990000">*</font> <font color="#993399">10.0</font><font color="#990000">,</font>
         <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># smooth table</font></i>
   smooth_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font>  <i><font color="#9A1900"># smooth_iota</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>      <font color="#FF0000">'smooth_iota'</font><font color="#990000">,</font>
         <font color="#FF0000">'age_id'</font><font color="#990000">:</font>    <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
         <font color="#FF0000">'time_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
         <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota
      <font color="#990000">},{</font>  <i><font color="#9A1900"># smooth_alpha</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>      <font color="#FF0000">'smooth_alpha'</font><font color="#990000">,</font>
         <font color="#FF0000">'age_id'</font><font color="#990000">:</font>    <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
         <font color="#FF0000">'time_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
         <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_alpha
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># rate table:</font></i>
   rate_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font>  <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'iota'</font><font color="#990000">,</font>
         <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_iota'</font><font color="#990000">,</font>
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># option_table</font></i>
   option_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'rate_case'</font><font color="#990000">,</font>              <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'iota_pos_rho_zero'</font>   <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'parent_node_name'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'europe'</font>              <font color="#990000">},</font>

      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'quasi_fixed'</font><font color="#990000">,</font>            <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'false'</font>               <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_fixed'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'50'</font>                  <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_fixed'</font><font color="#990000">,</font>      <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'0'</font>                   <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_fixed'</font><font color="#990000">,</font>        <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-9'</font>                <font color="#990000">},</font>

      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_random'</font><font color="#990000">,</font>    <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'50'</font>                  <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_random'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'0'</font>                   <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_random'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-10'</font>               <font color="#990000">},</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># subgroup_table</font></i>
   subgroup_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'world'</font><font color="#990000">,</font> <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'world'</font> <font color="#990000">}</font> <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># create database</font></i>
   dismod_at<font color="#990000">.</font><b><font color="#000000">create_database</font></b><font color="#990000">(</font>
      file_name<font color="#990000">,</font>
      age_list<font color="#990000">,</font>
      time_list<font color="#990000">,</font>
      integrand_table<font color="#990000">,</font>
      node_table<font color="#990000">,</font>
      subgroup_table<font color="#990000">,</font>
      weight_table<font color="#990000">,</font>
      covariate_table<font color="#990000">,</font>
      avgint_table<font color="#990000">,</font>
      data_table<font color="#990000">,</font>
      prior_table<font color="#990000">,</font>
      smooth_table<font color="#990000">,</font>
      nslist_table<font color="#990000">,</font>
      rate_table<font color="#990000">,</font>
      mulcov_table<font color="#990000">,</font>
      option_table
   <font color="#990000">)</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <b><font color="#0000FF">return</font></b>
<i><font color="#9A1900"># ===========================================================================</font></i>
<i><font color="#9A1900"># Create database</font></i>
file_name <font color="#990000">=</font> <font color="#FF0000">'example.db'</font>
<b><font color="#000000">example_db</font></b><font color="#990000">(</font>file_name<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
integrand_name <font color="#990000">=</font> <font color="#FF0000">'Sincidence'</font>
max_fit        <font color="#990000">=</font> <font color="#FF0000">'10'</font>
cov_name       <font color="#990000">=</font> <font color="#FF0000">'sex'</font>
cov_value_1    <font color="#990000">=</font> <font color="#FF0000">'-0.5'</font>
cov_value_2    <font color="#990000">=</font> <font color="#FF0000">'+0.5'</font>
<i><font color="#9A1900">#</font></i>
program <font color="#990000">=</font> <font color="#FF0000">'../../devel/dismod_at'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'init'</font> <font color="#990000">])</font>
command <font color="#990000">=</font> <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'hold_out'</font><font color="#990000">,</font> integrand_name<font color="#990000">,</font> max_fit <font color="#990000">]</font>
<i><font color="#9A1900"># If you do not balance the covariates the rel_error test for alpha will fail</font></i>
<b><font color="#0000FF">if</font></b> True <font color="#990000">:</font>
   command <font color="#990000">+=</font> <font color="#990000">[</font> cov_name<font color="#990000">,</font> cov_value_1<font color="#990000">,</font> cov_value_2 <font color="#990000">]</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">(</font>command<font color="#990000">)</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'fixed'</font> <font color="#990000">])</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># read database</font></i>
new                   <font color="#990000">=</font> False
connection            <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
var_table             <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
fit_var_table         <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
connection<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">()</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># There are two variables in this model, iota and alpha</font></i>
<b><font color="#0000FF">assert</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font> <font color="#990000">==</font> <font color="#993399">2</font>
<b><font color="#0000FF">assert</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>fit_var_table<font color="#990000">)</font> <font color="#990000">==</font> <font color="#993399">2</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check variable values</font></i>
count  <font color="#990000">=</font> <font color="#993399">0</font>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
   var_type       <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
   fit_var_value  <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
   <b><font color="#0000FF">if</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'mulcov_rate_value'</font> <font color="#990000">:</font>
      <i><font color="#9A1900"># relative error for alpha</font></i>
      rel_error  <font color="#990000">=</font> <font color="#993399">1.0</font> <font color="#990000">-</font> fit_var_value <font color="#990000">/</font> alpha_true
      <b><font color="#0000FF">assert</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>rel_error<font color="#990000">)</font> <font color="#990000">&lt;</font> <font color="#993399">1e-5</font>
   <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
      <i><font color="#9A1900"># relative error for iota</font></i>
      <b><font color="#0000FF">assert</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'rate'</font>
      rel_error <font color="#990000">=</font> <font color="#993399">1.0</font> <font color="#990000">-</font> fit_var_value <font color="#990000">/</font> iota_avg
      <b><font color="#0000FF">assert</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>rel_error<font color="#990000">)</font> <font color="#990000">&lt;</font> <font color="#993399">0.1</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'hold_out_2.py: OK'</font><font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i></tt></pre>

<hr>Input File: example/user/hold_out_2.py

</body>
</html>
