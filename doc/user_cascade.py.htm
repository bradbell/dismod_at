<html>
<script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath:  [ ['@(@','@)@'] ] ,
    displayMath: [ ['@[@','@]@'] ]
  }
});
</script>
<script type='text/javascript' src=
'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=default'
>
</script>
<head>
<title>Generating Priors For Next Level Down Node Tree</title>
<meta http-equiv='Content-Type' content='text/html' charset='utf-8'>
<meta name="description" id="description" content="Generating Priors For Next Level Down Node Tree">
<meta name="keywords" id="keywords" content=" generating priors next level down node tree table problem procedure step 1: create database 2: fit with n1 parent 3: simulate data 4: sample posterior 5: predictions n11 6: 7: parameters age time values rate covariates multipliers gamma alpha source code ">
<style type='text/css'>
body { color : black }
body { background-color : white }
A:link { color : blue }
A:visited { color : purple }
A:active { color : purple }
</style>
<script type='text/javascript' language='JavaScript' src='_user_cascade.py_htm.js'>
</script>
</head>
<body>
<table><tr>
<td>
<a href="https://bradbell.github.io/dismod_at" target="_top"><img border="0" src="_image.gif"></a>
</td>
<td>
<select onchange='choose_up0(this)'>
<option>Location-&gt;</option>
<option>dismod_at</option>
<option>user</option>
<option>user_cascade.py</option>
</select>
</td>
<td>
<select onchange='choose_across0(this)'>
<option>Search-&gt;</option>
<option>contents</option>
<option>reference</option>
<option>index</option>
<option>search</option>
<option>external</option>
</select>
</td>
<td><a href="user_censor.py.htm" target="_top">Prev</a>
</td><td><a href="user_predict_fit.py.htm" target="_top">Next</a>
</td><td>
<script type='text/javascript' language='JavaScript' src='_childtable_dismod_at_htm.js'></script>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_user_htm.js'></script>
</td>
<td>user_cascade.py</td>
</tr></table><br>
@(@\newcommand{\R}[1]{ {\rm #1} }
\newcommand{\B}[1]{ {\bf #1} }
\newcommand{\W}[1]{ \; #1 \; }@)@<center><b><big><big>Generating Priors For Next Level Down Node Tree</big></big></b></center>

<br><a href="user_cascade.py.htm#Node Table" target="_top">Node&nbsp;Table</a>
<br><a href="user_cascade.py.htm#Problem" target="_top">Problem</a>
<br><a href="user_cascade.py.htm#Procedure" target="_top">Procedure</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_cascade.py.htm#Procedure.Step 1: Create Database" target="_top">Step&nbsp;1:&nbsp;Create&nbsp;Database</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_cascade.py.htm#Procedure.Step 2: Fit With n1 As Parent" target="_top">Step&nbsp;2:&nbsp;Fit&nbsp;With&nbsp;n1&nbsp;As&nbsp;Parent</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_cascade.py.htm#Procedure.Step 3: Simulate Data" target="_top">Step&nbsp;3:&nbsp;Simulate&nbsp;Data</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_cascade.py.htm#Procedure.Step 4: Sample Posterior" target="_top">Step&nbsp;4:&nbsp;Sample&nbsp;Posterior</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_cascade.py.htm#Procedure.Step 5: Predictions For n11" target="_top">Step&nbsp;5:&nbsp;Predictions&nbsp;For&nbsp;n11</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_cascade.py.htm#Procedure.Step 6: Priors For n11 As Parent" target="_top">Step&nbsp;6:&nbsp;Priors&nbsp;For&nbsp;n11&nbsp;As&nbsp;Parent</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_cascade.py.htm#Procedure.Step 7: Fit n11 As Parent" target="_top">Step&nbsp;7:&nbsp;Fit&nbsp;n11&nbsp;As&nbsp;Parent</a>
<br><a href="user_cascade.py.htm#Problem Parameters" target="_top">Problem&nbsp;Parameters</a>
<br><a href="user_cascade.py.htm#Age and Time Values" target="_top">Age&nbsp;and&nbsp;Time&nbsp;Values</a>
<br><a href="user_cascade.py.htm#Rate Table" target="_top">Rate&nbsp;Table</a>
<br><a href="user_cascade.py.htm#Covariates" target="_top">Covariates</a>
<br><a href="user_cascade.py.htm#Multipliers" target="_top">Multipliers</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_cascade.py.htm#Multipliers.gamma" target="_top">gamma</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_cascade.py.htm#Multipliers.alpha" target="_top">alpha</a>
<br><a href="user_cascade.py.htm#Data Table" target="_top">Data&nbsp;Table</a>
<br><a href="user_cascade.py.htm#Source Code" target="_top">Source&nbsp;Code</a>
<br><br>
<b><big><a name="Node Table" id="Node Table">Node Table</a></big></b>
<br>
The following is a diagram of the node tree for this example:
<code><span style='white-space: nowrap'><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/-----/\-----\<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n12<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>
&nbsp;&nbsp;&nbsp;n111&nbsp;&nbsp;&nbsp;n112&nbsp;&nbsp;&nbsp;&nbsp;n121&nbsp;&nbsp;&nbsp;n122<br>
</span></code>We refer to 
<code><i><font color="black"><span style='white-space: nowrap'>n1</span></font></i></code>
 as the root node and

<code><i><font color="black"><span style='white-space: nowrap'>n111,&nbsp;n112,&nbsp;n121,&nbsp;n122</span></font></i></code>
 as the leaf nodes.

<br>
<br>
<b><big><a name="Problem" id="Problem">Problem</a></big></b>
<br>
Given the information for a fit with 
<code><i><font color="black"><span style='white-space: nowrap'>n1</span></font></i></code>
 as the parent,
with corresponding data 
<code><i><font color="black"><span style='white-space: nowrap'>y1</span></font></i></code>
,
pass down summary information for a fit with 
<code><i><font color="black"><span style='white-space: nowrap'>n11</span></font></i></code>
 as the parent
with corresponding data 
<code><i><font color="black"><span style='white-space: nowrap'>y11</span></font></i></code>
.

<br>
<br>
<b><big><a name="Procedure" id="Procedure">Procedure</a></big></b>


<br>
<br>
<big><a name="Procedure.Step 1: Create Database" id="Procedure.Step 1: Create Database">Step 1: Create Database</a></big>
<br>
This first database <code><font color="blue">fit_n1.db</font></code>
is for fitting with 
<code><i><font color="black"><span style='white-space: nowrap'>n1</span></font></i></code>
 as the parent and predicting
for 
<code><i><font color="black"><span style='white-space: nowrap'>n11</span></font></i></code>
.

<br>
<br>
<big><a name="Procedure.Step 2: Fit With n1 As Parent" id="Procedure.Step 2: Fit With n1 As Parent">Step 2: Fit With n1 As Parent</a></big>
<br>
Use <a href="fit_command.htm#variables.both" target="_top"><span style='white-space: nowrap'>fit&nbsp;both</span></a>

to fit with 
<code><i><font color="black"><span style='white-space: nowrap'>n1</span></font></i></code>
 as the parent to obtain

<code><i><font color="black"><span style='white-space: nowrap'>e1</span></font></i></code>
 the corresponding estimate for the <a href="model_variables.htm" target="_top"><span style='white-space: nowrap'>model_variables</span></a>
.
This is done using database <code><font color="blue">fit_n1.db</font></code>

<br>
<br>
<big><a name="Procedure.Step 3: Simulate Data" id="Procedure.Step 3: Simulate Data">Step 3: Simulate Data</a></big>
<br>
Set the <a href="truth_var_table.htm" target="_top"><span style='white-space: nowrap'>truth_var_table</span></a>
 equal to the estimate 
<code><i><font color="black"><span style='white-space: nowrap'>e1</span></font></i></code>

and then use the <a href="simulate_command.htm" target="_top"><span style='white-space: nowrap'>simulate_command</span></a>
 to simulate 
<code><i><font color="black"><span style='white-space: nowrap'>N</span></font></i></code>
 data sets.
This is done using database <code><font color="blue">fit_n1.db</font></code>

<br>
<br>
<big><a name="Procedure.Step 4: Sample Posterior" id="Procedure.Step 4: Sample Posterior">Step 4: Sample Posterior</a></big>
<br>
Use the sample command with the
<a href="sample_command.htm#method.simulate" target="_top"><span style='white-space: nowrap'>simulate</span></a>
 method
to create 
<code><i><font color="black"><span style='white-space: nowrap'>N</span></font></i></code>
 samples of the model variables.
Call these samples 
<code><i><font color="black"><span style='white-space: nowrap'>s1_1,&nbsp;...&nbsp;,&nbsp;s1_N</span></font></i></code>
.
This is done using database <code><font color="blue">fit_n1.db</font></code>

<br>
<br>
<big><a name="Procedure.Step 5: Predictions For n11" id="Procedure.Step 5: Predictions For n11">Step 5: Predictions For n11</a></big>
<br>
Use the predict command with the
<a href="predict_command.htm#source.sample" target="_top"><span style='white-space: nowrap'>sample</span></a>

to create 
<code><i><font color="black"><span style='white-space: nowrap'>N</span></font></i></code>
 predictions for the
model variable corresponding to fit with 
<code><i><font color="black"><span style='white-space: nowrap'>n11</span></font></i></code>
 as the parent.
Call these predictions 
<code><i><font color="black"><span style='white-space: nowrap'>p11_1,&nbsp;...&nbsp;,&nbsp;p11_N</span></font></i></code>
.
This is done using database <code><font color="blue">fit_n1.db</font></code>

<br>
<br>
<big><a name="Procedure.Step 6: Priors For n11 As Parent" id="Procedure.Step 6: Priors For n11 As Parent">Step 6: Priors For n11 As Parent</a></big>
<br>
Use the predictions 
<code><i><font color="black"><span style='white-space: nowrap'>p11_1,&nbsp;...&nbsp;,&nbsp;p11_N</span></font></i></code>
 to create priors
for the model variables corresponding to fitting with 
<code><i><font color="black"><span style='white-space: nowrap'>n11</span></font></i></code>

as the parent and with data 
<code><i><font color="black"><span style='white-space: nowrap'>y11</span></font></i></code>
.
In this process account for the fact that the data 
<code><i><font color="black"><span style='white-space: nowrap'>y11</span></font></i></code>
 is a subset
of 
<code><i><font color="black"><span style='white-space: nowrap'>y1</span></font></i></code>
 which was used to obtain the predictions.
These priors are written to the database <code><font color="blue">fit_n11.db</font></code>
which starts as a copy of the final <code><font color="blue">fit_n1.db</font></code>.
This is done so that the subsequent
<a href="init_command.htm" target="_top"><span style='white-space: nowrap'>init</span></a>
 and <a href="fit_command.htm" target="_top"><span style='white-space: nowrap'>fit</span></a>
 commands
do not wipe out the results stored in <code><font color="blue">fit_n1.db</font></code>.

<br>
<br>
<big><a name="Procedure.Step 7: Fit n11 As Parent" id="Procedure.Step 7: Fit n11 As Parent">Step 7: Fit n11 As Parent</a></big>
<br>
Use <a href="fit_command.htm#variables.both" target="_top"><span style='white-space: nowrap'>fit&nbsp;both</span></a>

to fit with 
<code><i><font color="black"><span style='white-space: nowrap'>n11</span></font></i></code>
 as the parent to obtain

<code><i><font color="black"><span style='white-space: nowrap'>e11</span></font></i></code>
 corresponding estimate for the model variables.

<br>
<br>
<b><big><a name="Problem Parameters" id="Problem Parameters">Problem Parameters</a></big></b>
<br>
The following parameters, used in this example, can be changed:
<pre><tt><b><font color="#0000FF">def</font></b> <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font>age<font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">return</font></b> <font color="#993399">0.01</font> <font color="#990000">+</font> <font color="#993399">0.01</font> <font color="#990000">*</font> age <font color="#990000">/</font> <font color="#993399">100.0</font> <i><font color="#9A1900"># must be non-decreasing with age</font></i>
data_per_leaf <font color="#990000">=</font>  <font color="#993399">10</font>    <i><font color="#9A1900"># number of simulated data points for each leaf node</font></i>
meas_cv       <font color="#990000">=</font>  <font color="#993399">0.10</font>  <i><font color="#9A1900"># coefficient of variation for each data point</font></i>
alpha_true    <font color="#990000">=</font> <font color="#990000">-</font><font color="#993399">0.10</font>  <i><font color="#9A1900"># rate_value covariate multiplier used to simulate data</font></i>
random_seed   <font color="#990000">=</font>   <font color="#993399">1555953130</font>    <i><font color="#9A1900"># if zero, seed off the clock</font></i>
number_sample <font color="#990000">=</font>  <font color="#993399">10</font>    <i><font color="#9A1900"># number of simulated data sets and posterior samples</font></i>
<i><font color="#9A1900">#</font></i>
random_effect <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>  <font color="#990000">=</font>  <font color="#993399">0.2</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n12'</font><font color="#990000">]</font>  <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font> <font color="#990000">=</font>  <font color="#993399">0.1</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n112'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font> <font color="#990000">=</font>  <font color="#993399">0.1</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n122'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font>
<i><font color="#9A1900">#</font></i>
avg_income <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">1.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n112'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">2.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">3.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n122'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">4.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>  <font color="#990000">=</font> <font color="#990000">(</font>avg_income<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font> <font color="#990000">+</font> avg_income<font color="#990000">[</font><font color="#FF0000">'n112'</font><font color="#990000">])/</font><font color="#993399">2.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n12'</font><font color="#990000">]</font>  <font color="#990000">=</font> <font color="#990000">(</font>avg_income<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font> <font color="#990000">+</font> avg_income<font color="#990000">[</font><font color="#FF0000">'n122'</font><font color="#990000">])/</font><font color="#993399">2.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n1'</font><font color="#990000">]</font>   <font color="#990000">=</font> <font color="#990000">(</font>avg_income<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>  <font color="#990000">+</font> avg_income<font color="#990000">[</font><font color="#FF0000">'n12'</font><font color="#990000">])</font> <font color="#990000">/</font><font color="#993399">2.0</font></tt></pre>
<br>
<b><big><a name="Age and Time Values" id="Age and Time Values">Age and Time Values</a></big></b>
<br>
The time values do not matter for this problem
because all the functions are constant with respect to time.
The <a href="age_table.htm" target="_top"><span style='white-space: nowrap'>age_table</span></a>
 for this problem is given by
<pre style='display:inline'><tt>
     age_list <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">0.0</font><font color="#990000">,</font> <font color="#993399">20.0</font><font color="#990000">,</font> <font color="#993399">40.0</font><font color="#990000">,</font> <font color="#993399">60.0</font><font color="#990000">,</font> <font color="#993399">80.0</font><font color="#990000">,</font> <font color="#993399">100.0</font> <font color="#990000">]</font>
</tt></pre>
We use 
<code><i><font color="black"><span style='white-space: nowrap'>n_age</span></font></i></code>
 to denote the length of this table.

<br>
<br>
<b><big><a name="Rate Table" id="Rate Table">Rate Table</a></big></b>
<br>
The only rate in this problem is 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
. There are 
<code><i><font color="black"><span style='white-space: nowrap'>n_age</span></font></i></code>

<a href="model_variables.htm#Fixed Effects, theta.Parent Rates" target="_top"><span style='white-space: nowrap'>parent&nbsp;rate</span></a>

values for 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
, one for each point in the age table.
There are two 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>

<a href="model_variables.htm#Random Effects, u.Child Rate Effects" target="_top"><span style='white-space: nowrap'>child&nbsp;rate&nbsp;effects</span></a>
,
one for each child node.
Note that there are two children when fitting 
<code><i><font color="black"><span style='white-space: nowrap'>n1</span></font></i></code>
 as the parent
and when fitting 
<code><i><font color="black"><span style='white-space: nowrap'>n11</span></font></i></code>
 as the parent.

<br>
<br>
<b><big><a name="Covariates" id="Covariates">Covariates</a></big></b>
<br>
There are two <a href="covariate_table.htm" target="_top"><span style='white-space: nowrap'>covariates</span></a>
 for this example.
One covariate has the constant one and reference zero.
The other covariate is income and uses the average for its reference.
The average income is different depending on whether

<code><i><font color="black"><span style='white-space: nowrap'>n1</span></font></i></code>
 or 
<code><i><font color="black"><span style='white-space: nowrap'>n11</span></font></i></code>

is the parent.

<br>
<br>
<b><big><a name="Multipliers" id="Multipliers">Multipliers</a></big></b>
<br>
There are two
<a href="model_variables.htm#Fixed Effects, theta.Covariate Multipliers" target="_top"><span style='white-space: nowrap'>covariate&nbsp;multipliers</span></a>
.

<br>
<br>
<big><a name="Multipliers.gamma" id="Multipliers.gamma">gamma</a></big>
<br>
One multiplier multiples the constant one and models the unknown variation
in the data (sometimes referred to as model misspecification).
We call this covariate multiplier
<a href="data_like.htm#Measurement Noise Covariates.gamma_j" target="_top"><span style='white-space: nowrap'>gamma</span></a>
.
We use a uniform prior on this multiplier so that it absorbs
all the noise due to model misspecification.
When checking for coverage by the samples 
<code><i><font color="black"><span style='white-space: nowrap'>s1_1</span></font></i></code>
, ... , 
<code><i><font color="black"><span style='white-space: nowrap'>s1_N</span></font></i></code>
,
we expand the sample standard deviation by a factor of

<code><font color="blue"><span style='white-space: nowrap'>(1&nbsp;+&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>gamma</span></font></i><font color="blue"><span style='white-space: nowrap'>)</span></font></code>
.
This accounts for the fact that the noise absorbed by 
<code><i><font color="black"><span style='white-space: nowrap'>gamma</span></font></i></code>

is modeled as independent between data points.
When fitting with 
<code><i><font color="black"><span style='white-space: nowrap'>n1</span></font></i></code>
 as the parent, this noise is
correlated between samples in the same leaf.

<br>
<br>
<big><a name="Multipliers.alpha" id="Multipliers.alpha">alpha</a></big>
<br>
The other multiplier multiplies income and affects 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
.
We call this covariate multiplier
<a href="avg_integrand.htm#Rate Functions.Rate Covariate Multiplier, alpha_jk" target="_top"><span style='white-space: nowrap'>alpha</span></a>
.
We note that both average income and random effects vary between the nodes.
When fitting with 
<code><i><font color="black"><span style='white-space: nowrap'>n1</span></font></i></code>
 as the parent,

<code><i><font color="black"><span style='white-space: nowrap'>alpha</span></font></i></code>
 tries to absorb the random effects at the leaf level.
We use a Laplace prior on 
<code><i><font color="black"><span style='white-space: nowrap'>alpha</span></font></i></code>
 to reduce this effect.

<br>
<br>
<b><big><a name="Data Table" id="Data Table">Data Table</a></big></b>
<br>
For this example, all the data is
<a href="avg_integrand.htm#Integrand, I_i(a,t).Sincidence" target="_top"><span style='white-space: nowrap'>Sincidence</span></a>
.
There are 
<code><i><font color="black"><span style='white-space: nowrap'>data_per_leaf</span></font></i></code>
 data point for each leaf node.
Income is varies within each leaf node so the random effect
can be separated from the income effect.
Normally there is much more data, so we compensate by using
a small coefficient of variation for the measurement values

<code><i><font color="black"><span style='white-space: nowrap'>meas_cv</span></font></i></code>
.
The simulation value of 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
, corresponding to no effect, is
a function of age and defined by 
<code><font color="blue"><span style='white-space: nowrap'>iota_no_effect(</span></font><i><font color="black"><span style='white-space: nowrap'>age</span></font></i><font color="blue"><span style='white-space: nowrap'>)</span></font></code>
.
Each data point corresponds to a leaf node.
The total effect for a data point is
the random effect for the leaf node,
plus the random effect for parent of the leaf,
plus the income effect.
Each data point is for a specific age and the corresponding mean
is 
<code><i><font color="black"><span style='white-space: nowrap'>iota_no_effect(</span></font></i><font color="blue"><span style='white-space: nowrap'>age</span></font><i><font color="black"><span style='white-space: nowrap'>)</span></font></i></code>
 times the exponential of the total effect.
The standard deviation of the data is 
<code><i><font color="black"><span style='white-space: nowrap'>meas_cv</span></font></i></code>
 times its mean.
A Gaussian with this mean and standard deviation is used to simulate
each data point.

<br>
<br>
<b><big><a name="Source Code" id="Source Code">Source Code</a></big></b>

<pre><tt>
<i><font color="#9A1900"># begin problem parameters</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font>age<font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">return</font></b> <font color="#993399">0.01</font> <font color="#990000">+</font> <font color="#993399">0.01</font> <font color="#990000">*</font> age <font color="#990000">/</font> <font color="#993399">100.0</font> <i><font color="#9A1900"># must be non-decreasing with age</font></i>
data_per_leaf <font color="#990000">=</font>  <font color="#993399">10</font>    <i><font color="#9A1900"># number of simulated data points for each leaf node</font></i>
meas_cv       <font color="#990000">=</font>  <font color="#993399">0.10</font>  <i><font color="#9A1900"># coefficient of variation for each data point</font></i>
alpha_true    <font color="#990000">=</font> <font color="#990000">-</font><font color="#993399">0.10</font>  <i><font color="#9A1900"># rate_value covariate multiplier used to simulate data</font></i>
random_seed   <font color="#990000">=</font>   <font color="#993399">1555953130</font>    <i><font color="#9A1900"># if zero, seed off the clock</font></i>
number_sample <font color="#990000">=</font>  <font color="#993399">10</font>    <i><font color="#9A1900"># number of simulated data sets and posterior samples</font></i>
<i><font color="#9A1900">#</font></i>
random_effect <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>  <font color="#990000">=</font>  <font color="#993399">0.2</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n12'</font><font color="#990000">]</font>  <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font> <font color="#990000">=</font>  <font color="#993399">0.1</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n112'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font> <font color="#990000">=</font>  <font color="#993399">0.1</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n122'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font>
<i><font color="#9A1900">#</font></i>
avg_income <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">1.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n112'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">2.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">3.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n122'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">4.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>  <font color="#990000">=</font> <font color="#990000">(</font>avg_income<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font> <font color="#990000">+</font> avg_income<font color="#990000">[</font><font color="#FF0000">'n112'</font><font color="#990000">])/</font><font color="#993399">2.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n12'</font><font color="#990000">]</font>  <font color="#990000">=</font> <font color="#990000">(</font>avg_income<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font> <font color="#990000">+</font> avg_income<font color="#990000">[</font><font color="#FF0000">'n122'</font><font color="#990000">])/</font><font color="#993399">2.0</font>
avg_income<font color="#990000">[</font><font color="#FF0000">'n1'</font><font color="#990000">]</font>   <font color="#990000">=</font> <font color="#990000">(</font>avg_income<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>  <font color="#990000">+</font> avg_income<font color="#990000">[</font><font color="#FF0000">'n12'</font><font color="#990000">])</font> <font color="#990000">/</font><font color="#993399">2.0</font>
<i><font color="#9A1900"># end problem parameters</font></i>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># imports</font></i>
<b><font color="#000080">import</font></b> sys
<b><font color="#000080">import</font></b> os
<b><font color="#000080">import</font></b> distutils<font color="#990000">.</font>dir_util
<b><font color="#000080">import</font></b> subprocess
<b><font color="#000080">import</font></b> copy
<b><font color="#000080">import</font></b> random
<b><font color="#000080">import</font></b> math
<b><font color="#000080">import</font></b> numpy
<b><font color="#000080">import</font></b> shutil
<b><font color="#000080">import</font></b> time
<b><font color="#0000FF">if</font></b> random_seed <font color="#990000">==</font> <font color="#993399">0</font> <font color="#990000">:</font>
     random_seed <font color="#990000">=</font> <b><font color="#000000">int</font></b><font color="#990000">(</font> time<font color="#990000">.</font><b><font color="#000000">time</font></b><font color="#990000">()</font> <font color="#990000">)</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># run in build/exampe/user using local (not installed) version of dismod_at</font></i>
test_program <font color="#990000">=</font> <font color="#FF0000">'example/user/cascade.py'</font>
<b><font color="#0000FF">if</font></b> sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#990000">!=</font> test_program  <b><font color="#0000FF">or</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">:</font>
     usage  <font color="#990000">=</font> <font color="#FF0000">'python3 '</font> <font color="#990000">+</font> test_program <font color="#990000">+</font> <font color="#FF0000">'\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'where python3 is the python 3 program on your system\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'and working directory is the dismod_at distribution directory\n'</font>
     sys<font color="#990000">.</font><b><font color="#000000">exit</font></b><font color="#990000">(</font>usage<font color="#990000">)</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font>test_program<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># import dismod_at</font></i>
local_dir <font color="#990000">=</font> os<font color="#990000">.</font><b><font color="#000000">getcwd</font></b><font color="#990000">()</font> <font color="#990000">+</font> <font color="#FF0000">'/python'</font>
<b><font color="#0000FF">if</font></b><font color="#990000">(</font> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">isdir</font></b><font color="#990000">(</font> local_dir <font color="#990000">+</font> <font color="#FF0000">'/dismod_at'</font> <font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     sys<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">insert</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> local_dir<font color="#990000">)</font>
<b><font color="#000080">import</font></b> dismod_at
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change into the build/example/user directory</font></i>
distutils<font color="#990000">.</font>dir_util<font color="#990000">.</font><b><font color="#000000">mkpath</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
os<font color="#990000">.</font><b><font color="#000000">chdir</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># run a system command</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">system_command</font></b><font color="#990000">(</font>command<font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">print</font></b><font color="#990000">(</font> <font color="#FF0000">' '</font><font color="#990000">.</font><b><font color="#000000">join</font></b><font color="#990000">(</font>command<font color="#990000">)</font> <font color="#990000">)</font>
     flag <font color="#990000">=</font> subprocess<font color="#990000">.</font><b><font color="#000000">call</font></b><font color="#990000">(</font> command <font color="#990000">)</font>
     <b><font color="#0000FF">if</font></b> flag <font color="#990000">!=</font> <font color="#993399">0</font> <font color="#990000">:</font>
          sys<font color="#990000">.</font><b><font color="#000000">exit</font></b><font color="#990000">(</font><font color="#FF0000">'command failed: flag = '</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>flag<font color="#990000">))</font>
     <b><font color="#0000FF">return</font></b>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># count number of rows in an sql file</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">sql_count_rows</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> table_name<font color="#990000">)</font> <font color="#990000">:</font>
     sqlcmd <font color="#990000">=</font> <font color="#FF0000">'SELECT COUNT(*) FROM '</font> <font color="#990000">+</font> table_name
     result <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
     n_row  <font color="#990000">=</font> result<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">][</font><font color="#993399">0</font><font color="#990000">]</font>
     <b><font color="#0000FF">return</font></b> n_row
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># average integrand</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">avg_integrand</font></b><font color="#990000">(</font>age<font color="#990000">,</font> income<font color="#990000">,</font> node<font color="#990000">)</font> <font color="#990000">:</font>
     total_effect  <font color="#990000">=</font> alpha_true <font color="#990000">*</font> <font color="#990000">(</font>income <font color="#990000">-</font> avg_income<font color="#990000">[</font><font color="#FF0000">'n1'</font><font color="#990000">])</font>
     <b><font color="#0000FF">if</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>node<font color="#990000">)</font> <font color="#990000">&gt;=</font> <font color="#993399">3</font> <font color="#990000">:</font>
          total_effect <font color="#990000">+=</font> random_effect<font color="#990000">[</font> node<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">:</font><font color="#993399">3</font><font color="#990000">]</font> <font color="#990000">]</font>
     <b><font color="#0000FF">if</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>node<font color="#990000">)</font> <font color="#990000">==</font> <font color="#993399">4</font> <font color="#990000">:</font>
          total_effect <font color="#990000">+=</font> random_effect<font color="#990000">[</font>node<font color="#990000">]</font>
     <b><font color="#0000FF">return</font></b> <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font>age<font color="#990000">)</font> <font color="#990000">*</font> math<font color="#990000">.</font><b><font color="#000000">exp</font></b><font color="#990000">(</font>total_effect<font color="#990000">)</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">example_db</font></b> <font color="#990000">(</font>file_name<font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">constant_weight_fun</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#993399">1.0</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_n1</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_n1_value'</font><font color="#990000">,</font> <font color="#FF0000">'prior_iota_n1_dage'</font><font color="#990000">,</font> None<font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_child</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_child'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_alpha_n1</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_alpha_n1'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_gamma</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_gamma'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># node_table</font></i>
     node_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n1'</font><font color="#990000">,</font>      <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">''</font>    <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n11'</font><font color="#990000">,</font>     <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n1'</font>  <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n12'</font><font color="#990000">,</font>     <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n1'</font>  <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n111'</font><font color="#990000">,</font>    <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n11'</font> <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n112'</font><font color="#990000">,</font>    <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n11'</font> <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n121'</font><font color="#990000">,</font>    <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n12'</font> <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n122'</font><font color="#990000">,</font>    <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n12'</font> <font color="#990000">},</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># age_table</font></i>
     age_list <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">0.0</font><font color="#990000">,</font> <font color="#993399">20.0</font><font color="#990000">,</font> <font color="#993399">40.0</font><font color="#990000">,</font> <font color="#993399">60.0</font><font color="#990000">,</font> <font color="#993399">80.0</font><font color="#990000">,</font> <font color="#993399">100.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># time_table</font></i>
     time_list <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">1990.0</font><font color="#990000">,</font> <font color="#993399">2020.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># rate_table</font></i>
     rate_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font>
          <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'iota'</font><font color="#990000">,</font>
          <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_iota_n1'</font><font color="#990000">,</font>
          <font color="#FF0000">'child_smooth'</font><font color="#990000">:</font>  <font color="#FF0000">'smooth_iota_child'</font><font color="#990000">,</font>
     <font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># covariate_table</font></i>
     covariate_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'one'</font><font color="#990000">,</font>    <font color="#FF0000">'reference'</font><font color="#990000">:</font><font color="#993399">0.0</font> <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'income'</font><font color="#990000">,</font> <font color="#FF0000">'reference'</font><font color="#990000">:</font>avg_income<font color="#990000">[</font><font color="#FF0000">'n1'</font><font color="#990000">]</font> <font color="#990000">},</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># mulcov_table</font></i>
     mulcov_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font>
          <font color="#FF0000">'covariate'</font><font color="#990000">:</font> <font color="#FF0000">'one'</font><font color="#990000">,</font>
          <font color="#FF0000">'type'</font><font color="#990000">:</font>      <font color="#FF0000">'meas_noise'</font><font color="#990000">,</font>
          <font color="#FF0000">'effected'</font><font color="#990000">:</font>  <font color="#FF0000">'Sincidence'</font><font color="#990000">,</font>
          <font color="#FF0000">'smooth'</font><font color="#990000">:</font>    <font color="#FF0000">'smooth_gamma'</font>
          <font color="#990000">},{</font>
          <font color="#FF0000">'covariate'</font><font color="#990000">:</font> <font color="#FF0000">'income'</font><font color="#990000">,</font>
          <font color="#FF0000">'type'</font><font color="#990000">:</font>      <font color="#FF0000">'rate_value'</font><font color="#990000">,</font>
          <font color="#FF0000">'effected'</font><font color="#990000">:</font>  <font color="#FF0000">'iota'</font><font color="#990000">,</font>
          <font color="#FF0000">'smooth'</font><font color="#990000">:</font>    <font color="#FF0000">'smooth_alpha_n1'</font>
     <font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># prior_table</font></i>
     prior_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font>   <i><font color="#9A1900"># prior_iota_n1_value</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_n1_value'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'lower'</font><font color="#990000">:</font>   <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font>   <font color="#990000">/</font> <font color="#993399">10.0</font><font color="#990000">,</font>
               <font color="#FF0000">'upper'</font><font color="#990000">:</font>   <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font><font color="#993399">100</font><font color="#990000">)</font> <font color="#990000">*</font> <font color="#993399">10.0</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>    <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font><font color="#993399">50</font><font color="#990000">)</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_iota_n1_dage</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_n1_dage'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'log_gaussian'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      <font color="#993399">1.0</font><font color="#990000">,</font>
               <font color="#FF0000">'eta'</font><font color="#990000">:</font>      <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">100.0</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_iota_child</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_child'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      <font color="#993399">1.0</font><font color="#990000">,</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_alpha_n1</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_alpha_n1'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'laplace'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      <font color="#993399">0.01</font><font color="#990000">,</font>
               <font color="#FF0000">'lower'</font><font color="#990000">:</font>   <font color="#990000">-</font><b><font color="#000000">abs</font></b><font color="#990000">(</font>alpha_true<font color="#990000">)</font> <font color="#990000">*</font> <font color="#993399">10.0</font><font color="#990000">,</font>
               <font color="#FF0000">'upper'</font><font color="#990000">:</font>    <b><font color="#000000">abs</font></b><font color="#990000">(</font>alpha_true<font color="#990000">)</font> <font color="#990000">*</font> <font color="#993399">10.0</font><font color="#990000">,</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_gamma</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_gamma'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      <font color="#993399">1.0</font><font color="#990000">,</font>
               <font color="#FF0000">'lower'</font><font color="#990000">:</font>    <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'upper'</font><font color="#990000">:</font>   <font color="#993399">10.0</font><font color="#990000">,</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># smooth_table</font></i>
     smooth_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font>   <i><font color="#9A1900"># smooth_iota_n1</font></i>
               <font color="#FF0000">'name'</font> <font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_n1'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <b><font color="#000000">range</font></b><font color="#990000">(</font><b><font color="#000000">len</font></b><font color="#990000">(</font>age_list<font color="#990000">)),</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota_n1
          <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_iota_child</font></i>
               <font color="#FF0000">'name'</font> <font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_child'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota_child
          <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_alpha_n1</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'smooth_alpha_n1'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_alpha_n1
          <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_gamma</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'smooth_gamma'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_gamma
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># weight_table</font></i>
     fun <font color="#990000">=</font> constant_weight_fun
     weight_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'constant'</font><font color="#990000">,</font>  <font color="#FF0000">'age_id'</font><font color="#990000">:[</font><font color="#993399">1</font><font color="#990000">],</font> <font color="#FF0000">'time_id'</font><font color="#990000">:[</font><font color="#993399">1</font><font color="#990000">],</font> <font color="#FF0000">'fun'</font><font color="#990000">:</font>fun <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># nslist_table</font></i>
     nslist_table <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># option_table</font></i>
     option_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'parent_node_name'</font><font color="#990000">,</font>      <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'n1'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'rate_case'</font><font color="#990000">,</font>             <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'iota_pos_rho_zero'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font> <font color="#FF0000">'zero_sum_random'</font><font color="#990000">,</font>      <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'iota'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font> <font color="#FF0000">'meas_noise_effect'</font><font color="#990000">,</font>    <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'add_var_scale_all'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'quasi_fixed'</font><font color="#990000">,</font>           <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'false'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_fixed'</font><font color="#990000">,</font>    <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'100'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_fixed'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'0'</font><font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_fixed'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-12'</font><font color="#990000">},</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># integrand_table</font></i>
     integrand_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font><font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'Sincidence'</font><font color="#990000">},</font> <font color="#990000">{</font><font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'mulcov_1'</font><font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># data_table</font></i>
     data_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># values that are the same for all data points</font></i>
     row <font color="#990000">=</font> <font color="#990000">{</font>
          <font color="#FF0000">'integrand'</font><font color="#990000">:</font>   <font color="#FF0000">'Sincidence'</font><font color="#990000">,</font>
          <font color="#FF0000">'density'</font><font color="#990000">:</font>     <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
          <font color="#FF0000">'weight'</font><font color="#990000">:</font>      <font color="#FF0000">'constant'</font><font color="#990000">,</font>
          <font color="#FF0000">'hold_out'</font><font color="#990000">:</font>    False<font color="#990000">,</font>
          <font color="#FF0000">'time_lower'</font><font color="#990000">:</font>  <font color="#993399">2000.0</font><font color="#990000">,</font>
          <font color="#FF0000">'time_upper'</font><font color="#990000">:</font>  <font color="#993399">2000.0</font><font color="#990000">,</font>
          <font color="#FF0000">'one'</font><font color="#990000">:</font>         <font color="#993399">1.0</font><font color="#990000">,</font>
     <font color="#990000">}</font>
     <b><font color="#0000FF">assert</font></b> covariate_table<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">][</font><font color="#FF0000">'name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'income'</font>
     random<font color="#990000">.</font><b><font color="#000000">seed</font></b><font color="#990000">(</font>random_seed<font color="#990000">)</font>
     <b><font color="#0000FF">for</font></b> age_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>age_list<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
          age       <font color="#990000">=</font> age_list<font color="#990000">[</font>age_id<font color="#990000">]</font>
          <b><font color="#0000FF">for</font></b> node <b><font color="#0000FF">in</font></b> <font color="#990000">[</font> <font color="#FF0000">'n111'</font><font color="#990000">,</font> <font color="#FF0000">'n112'</font><font color="#990000">,</font> <font color="#FF0000">'n121'</font><font color="#990000">,</font> <font color="#FF0000">'n122'</font> <font color="#990000">]</font> <font color="#990000">:</font>
               <b><font color="#0000FF">for</font></b> i <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>data_per_leaf<font color="#990000">)</font> <font color="#990000">:</font>
                    income <font color="#990000">=</font> i <font color="#990000">*</font> avg_income<font color="#990000">[</font>node<font color="#990000">]</font> <font color="#990000">*</font> <font color="#993399">2.0</font> <font color="#990000">/</font> <font color="#990000">(</font>data_per_leaf <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">)</font>
                    iota       <font color="#990000">=</font> <b><font color="#000000">avg_integrand</font></b><font color="#990000">(</font>age<font color="#990000">,</font> income<font color="#990000">,</font> node<font color="#990000">)</font>
                    meas_std   <font color="#990000">=</font> iota <font color="#990000">*</font> meas_cv
                    meas_value <font color="#990000">=</font> random<font color="#990000">.</font><b><font color="#000000">gauss</font></b><font color="#990000">(</font>iota<font color="#990000">,</font> meas_std<font color="#990000">)</font>
                    row<font color="#990000">[</font><font color="#FF0000">'node'</font><font color="#990000">]</font>       <font color="#990000">=</font> node
                    row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font> <font color="#990000">=</font> meas_value
                    row<font color="#990000">[</font><font color="#FF0000">'meas_std'</font><font color="#990000">]</font>   <font color="#990000">=</font> meas_std
                    row<font color="#990000">[</font><font color="#FF0000">'age_lower'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
                    row<font color="#990000">[</font><font color="#FF0000">'age_upper'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
                    row<font color="#990000">[</font><font color="#FF0000">'income'</font><font color="#990000">]</font>     <font color="#990000">=</font> income
                    data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
     <i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># avgint_table</font></i>
     avgint_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># values that are the same for all data points</font></i>
     row <font color="#990000">=</font> <font color="#990000">{</font>
          <font color="#FF0000">'node'</font><font color="#990000">:</font>        <font color="#FF0000">'n11'</font><font color="#990000">,</font>
          <font color="#FF0000">'weight'</font><font color="#990000">:</font>      <font color="#FF0000">'constant'</font><font color="#990000">,</font>
          <font color="#FF0000">'hold_out'</font><font color="#990000">:</font>    False<font color="#990000">,</font>
          <font color="#FF0000">'time_lower'</font><font color="#990000">:</font>  <font color="#993399">2000.0</font><font color="#990000">,</font>
          <font color="#FF0000">'time_upper'</font><font color="#990000">:</font>  <font color="#993399">2000.0</font><font color="#990000">,</font>
          <font color="#FF0000">'income'</font><font color="#990000">:</font>      avg_income<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">],</font>
          <font color="#FF0000">'one'</font><font color="#990000">:</font>         <font color="#993399">1.0</font><font color="#990000">,</font>
     <font color="#990000">}</font>
     <b><font color="#0000FF">for</font></b> age_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>age_list<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
          age  <font color="#990000">=</font> age_list<font color="#990000">[</font>age_id<font color="#990000">]</font>
          row<font color="#990000">[</font><font color="#FF0000">'integrand'</font><font color="#990000">]</font>  <font color="#990000">=</font> <font color="#FF0000">'Sincidence'</font>
          row<font color="#990000">[</font><font color="#FF0000">'age_lower'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
          row<font color="#990000">[</font><font color="#FF0000">'age_upper'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
          avgint_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
     <i><font color="#9A1900"># alpha is constant w.r.t age and time</font></i>
     <b><font color="#0000FF">assert</font></b> mulcov_table<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">][</font><font color="#FF0000">'type'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'rate_value'</font>
     row<font color="#990000">[</font><font color="#FF0000">'integrand'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#FF0000">'mulcov_1'</font>
     row<font color="#990000">[</font><font color="#FF0000">'age_lower'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">0.0</font>
     row<font color="#990000">[</font><font color="#FF0000">'age_upper'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#993399">0.0</font>
     avgint_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># create database</font></i>
     dismod_at<font color="#990000">.</font><b><font color="#000000">create_database</font></b><font color="#990000">(</font>
          file_name<font color="#990000">,</font>
          age_list<font color="#990000">,</font>
          time_list<font color="#990000">,</font>
          integrand_table<font color="#990000">,</font>
          node_table<font color="#990000">,</font>
          weight_table<font color="#990000">,</font>
          covariate_table<font color="#990000">,</font>
          avgint_table<font color="#990000">,</font>
          data_table<font color="#990000">,</font>
          prior_table<font color="#990000">,</font>
          smooth_table<font color="#990000">,</font>
          nslist_table<font color="#990000">,</font>
          rate_table<font color="#990000">,</font>
          mulcov_table<font color="#990000">,</font>
          option_table
     <font color="#990000">)</font>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Step 1: Create fit_n1.db</font></i>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
file_name  <font color="#990000">=</font> <font color="#FF0000">'fit_n1.db'</font>
<b><font color="#000000">example_db</font></b><font color="#990000">(</font>file_name<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># init</font></i>
program <font color="#990000">=</font> <font color="#FF0000">'../../devel/dismod_at'</font>
<b><font color="#000000">system_command</font></b><font color="#990000">(</font> <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'init'</font> <font color="#990000">]</font> <font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Step 2: Fit With n1 As Parent</font></i>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<b><font color="#000000">system_command</font></b><font color="#990000">(</font> <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'both'</font> <font color="#990000">]</font> <font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check e1</font></i>
new              <font color="#990000">=</font> False
connection       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
rate_table       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'rate'</font><font color="#990000">)</font>
node_table       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'node'</font><font color="#990000">)</font>
age_table        <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'age'</font><font color="#990000">)</font>
var_table        <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
fit_var_table    <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
covariate_table  <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'covariate'</font><font color="#990000">)</font>
n_var            <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>n_var<font color="#990000">)</font> <font color="#990000">:</font>
     var_type     <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
     age_id       <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'age_id'</font><font color="#990000">]</font>
     rate_id      <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'rate_id'</font><font color="#990000">]</font>
     node_id      <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'node_id'</font><font color="#990000">]</font>
     covariate_id <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'covariate_id'</font><font color="#990000">]</font>
     value        <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
     fixed        <font color="#990000">=</font> True
     <b><font color="#0000FF">if</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'rate'</font> <font color="#990000">:</font>
          age  <font color="#990000">=</font> age_table<font color="#990000">[</font>age_id<font color="#990000">][</font><font color="#FF0000">'age'</font><font color="#990000">]</font>
          node <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font>
          rate <font color="#990000">=</font> rate_table<font color="#990000">[</font>rate_id<font color="#990000">][</font><font color="#FF0000">'rate_name'</font><font color="#990000">]</font>
          <b><font color="#0000FF">assert</font></b> rate <font color="#990000">==</font> <font color="#FF0000">'iota'</font>
          <b><font color="#0000FF">if</font></b> node <font color="#990000">==</font> <font color="#FF0000">'n1'</font> <font color="#990000">:</font>
               truth <font color="#990000">=</font> <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font>age<font color="#990000">)</font>
          <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
               truth <font color="#990000">=</font> random_effect<font color="#990000">[</font>node<font color="#990000">]</font>
               fixed <font color="#990000">=</font> False
     <b><font color="#0000FF">elif</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'mulcov_rate_value'</font> <font color="#990000">:</font>
          rate      <font color="#990000">=</font> rate_table<font color="#990000">[</font>rate_id<font color="#990000">][</font><font color="#FF0000">'rate_name'</font><font color="#990000">]</font>
          covariate <font color="#990000">=</font> covariate_table<font color="#990000">[</font>covariate_id<font color="#990000">][</font><font color="#FF0000">'covariate_name'</font><font color="#990000">]</font>
          <b><font color="#0000FF">assert</font></b> rate <font color="#990000">==</font> <font color="#FF0000">'iota'</font>
          <b><font color="#0000FF">assert</font></b> covariate <font color="#990000">==</font> <font color="#FF0000">'income'</font>
          truth <font color="#990000">=</font> alpha_true
     <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
          covariate <font color="#990000">=</font> covariate_table<font color="#990000">[</font>covariate_id<font color="#990000">][</font><font color="#FF0000">'covariate_name'</font><font color="#990000">]</font>
          <b><font color="#0000FF">assert</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'mulcov_meas_noise'</font>
          <b><font color="#0000FF">assert</font></b> covariate <font color="#990000">==</font> <font color="#FF0000">'one'</font>
          gamma_fit_n1 <font color="#990000">=</font> value
     <b><font color="#0000FF">if</font></b> var_type <font color="#990000">!=</font> <font color="#FF0000">'mulcov_meas_noise'</font> <font color="#990000">:</font>
          rel_err <font color="#990000">=</font> <font color="#990000">(</font><font color="#993399">1.0</font> <font color="#990000">-</font> value <font color="#990000">/</font> truth<font color="#990000">)</font>
          fmt <font color="#990000">=</font> <font color="#FF0000">'fixed={}, truth={:7.4f}, value={:7.4f}, rel_err={:6.3f}'</font>
          <i><font color="#9A1900"># print( fmt.format(fixed, truth, value, rel_err) )</font></i>
          <b><font color="#0000FF">if</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>rel_err<font color="#990000">)</font> <font color="#990000">&gt;=</font> <font color="#993399">2e-1</font> <font color="#990000">:</font>
               <b><font color="#0000FF">print</font></b><font color="#990000">(</font> fmt<font color="#990000">.</font><b><font color="#000000">format</font></b><font color="#990000">(</font>fixed<font color="#990000">,</font> truth<font color="#990000">,</font> value<font color="#990000">,</font> rel_err<font color="#990000">)</font> <font color="#990000">)</font>
               <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"random_seed = "</font><font color="#990000">,</font>  random_seed<font color="#990000">)</font>
               <b><font color="#0000FF">assert</font></b> False
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Step 3: Simulate Data</font></i>
<i><font color="#9A1900"># Step 4: Sample Posterior</font></i>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># obtain s1_1, ... , s1_N</font></i>
N_str <font color="#990000">=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>number_sample<font color="#990000">)</font>
<b><font color="#000000">system_command</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'set'</font><font color="#990000">,</font> <font color="#FF0000">'truth_var'</font><font color="#990000">,</font> <font color="#FF0000">'fit_var'</font> <font color="#990000">])</font>
<b><font color="#000000">system_command</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'simulate'</font><font color="#990000">,</font> N_str <font color="#990000">])</font>
<b><font color="#000000">system_command</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'sample'</font><font color="#990000">,</font> <font color="#FF0000">'simulate'</font><font color="#990000">,</font> N_str <font color="#990000">])</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check coverage of true values by posterior samples</font></i>
connection<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">()</font>
connection   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
sample_table <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'sample'</font><font color="#990000">)</font>
sample_array <font color="#990000">=</font> numpy<font color="#990000">.</font><b><font color="#000000">zeros</font></b><font color="#990000">(</font> <font color="#990000">(</font>number_sample<font color="#990000">,</font> n_var<font color="#990000">),</font> dtype <font color="#990000">=</font> numpy<font color="#990000">.</font>double <font color="#990000">)</font>
<b><font color="#0000FF">for</font></b> sample_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>sample_table<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     sample_index <font color="#990000">=</font> sample_table<font color="#990000">[</font>sample_id<font color="#990000">][</font><font color="#FF0000">'sample_index'</font><font color="#990000">]</font>
     var_id       <font color="#990000">=</font> sample_table<font color="#990000">[</font>sample_id<font color="#990000">][</font><font color="#FF0000">'var_id'</font><font color="#990000">]</font>
     var_value    <font color="#990000">=</font> sample_table<font color="#990000">[</font>sample_id<font color="#990000">][</font><font color="#FF0000">'var_value'</font><font color="#990000">]</font>
     <b><font color="#0000FF">assert</font></b> sample_id <font color="#990000">==</font> sample_index <font color="#990000">*</font> n_var <font color="#990000">+</font> var_id
     sample_array<font color="#990000">[</font>sample_index<font color="#990000">,</font> var_id<font color="#990000">]</font> <font color="#990000">=</font> var_value
sample_mean <font color="#990000">=</font> numpy<font color="#990000">.</font><b><font color="#000000">mean</font></b><font color="#990000">(</font>sample_array<font color="#990000">,</font> axis<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">)</font>
sample_std  <font color="#990000">=</font> numpy<font color="#990000">.</font><b><font color="#000000">std</font></b><font color="#990000">(</font>sample_array<font color="#990000">,</font> axis<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">,</font> ddof <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>n_var<font color="#990000">)</font> <font color="#990000">:</font>
     var_type     <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
     age_id       <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'age_id'</font><font color="#990000">]</font>
     node_id      <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'node_id'</font><font color="#990000">]</font>
     covariate_id <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'covariate_id'</font><font color="#990000">]</font>
     fit          <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
     mean         <font color="#990000">=</font> sample_mean<font color="#990000">[</font>var_id<font color="#990000">]</font>
     std          <font color="#990000">=</font> sample_std<font color="#990000">[</font>var_id<font color="#990000">]</font> <font color="#990000">*</font> <font color="#990000">(</font><font color="#993399">1.0</font> <font color="#990000">+</font> gamma_fit_n1<font color="#990000">)</font>
     <b><font color="#0000FF">if</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'rate'</font> <font color="#990000">:</font>
          age  <font color="#990000">=</font> age_table<font color="#990000">[</font>age_id<font color="#990000">][</font><font color="#FF0000">'age'</font><font color="#990000">]</font>
          node <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font>
          <b><font color="#0000FF">if</font></b> node <font color="#990000">==</font> <font color="#FF0000">'n1'</font> <font color="#990000">:</font>
               truth <font color="#990000">=</font> <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font>age<font color="#990000">)</font>
          <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
               truth <font color="#990000">=</font> random_effect<font color="#990000">[</font>node<font color="#990000">]</font>
     <b><font color="#0000FF">elif</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'mulcov_rate_value'</font> <font color="#990000">:</font>
          truth <font color="#990000">=</font> alpha_true
     <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
          <b><font color="#0000FF">assert</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'mulcov_meas_noise'</font>
     <b><font color="#0000FF">if</font></b> var_type <font color="#990000">!=</font> <font color="#FF0000">'mulcov_meas_noise'</font> <font color="#990000">:</font>
          std_factor <font color="#990000">=</font> <b><font color="#000000">abs</font></b><font color="#990000">(</font> <font color="#990000">(</font>mean <font color="#990000">-</font> truth<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">/</font> std
          fmt <font color="#990000">=</font> <font color="#FF0000">'truth={:7.4f}, mean={:7.4f}, std_factor={:6.3f}'</font>
          <i><font color="#9A1900"># print( fmt.format(truth, mean, std_factor) )</font></i>
          <b><font color="#0000FF">if</font></b> std_factor <font color="#990000">&gt;</font> <font color="#993399">3.0</font> <font color="#990000">:</font>
               <b><font color="#0000FF">print</font></b><font color="#990000">(</font> fmt<font color="#990000">.</font><b><font color="#000000">format</font></b><font color="#990000">(</font>truth<font color="#990000">,</font> mean<font color="#990000">,</font> std_factor<font color="#990000">)</font> <font color="#990000">)</font>
               <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"random_seed = "</font><font color="#990000">,</font>  random_seed<font color="#990000">)</font>
               <b><font color="#0000FF">assert</font></b> False
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Step 5: Predictions For n11</font></i>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># obtain p11_1, p_11_2, ...</font></i>
<i><font color="#9A1900"># and add prior_n11_age values to data base</font></i>
<b><font color="#000000">system_command</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'predict'</font><font color="#990000">,</font> <font color="#FF0000">'sample'</font> <font color="#990000">])</font>
avgint_table    <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'avgint'</font><font color="#990000">)</font>
predict_table   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'predict'</font><font color="#990000">)</font>
n_avgint        <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font> avgint_table <font color="#990000">)</font>
n_predict       <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font> predict_table <font color="#990000">)</font>
n_subset        <font color="#990000">=</font> <b><font color="#000000">int</font></b><font color="#990000">(</font> n_predict <font color="#990000">/</font> number_sample <font color="#990000">)</font>
<b><font color="#0000FF">assert</font></b> n_predict <font color="#990000">==</font> n_subset <font color="#990000">*</font> number_sample
predict_array <font color="#990000">=</font> numpy<font color="#990000">.</font><b><font color="#000000">zeros</font></b><font color="#990000">(</font> <font color="#990000">(</font>number_sample<font color="#990000">,</font> n_avgint<font color="#990000">),</font> dtype <font color="#990000">=</font> numpy<font color="#990000">.</font>double <font color="#990000">)</font>
predict_found <font color="#990000">=</font> n_avgint <font color="#990000">*</font> <font color="#990000">[</font>False<font color="#990000">]</font>
<b><font color="#0000FF">for</font></b> predict_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> n_predict <font color="#990000">)</font> <font color="#990000">:</font>
     sample_index  <font color="#990000">=</font> predict_table<font color="#990000">[</font>predict_id<font color="#990000">][</font><font color="#FF0000">'sample_index'</font><font color="#990000">]</font>
     avgint_id     <font color="#990000">=</font> predict_table<font color="#990000">[</font>predict_id<font color="#990000">][</font><font color="#FF0000">'avgint_id'</font><font color="#990000">]</font>
     value         <font color="#990000">=</font> predict_table<font color="#990000">[</font>predict_id<font color="#990000">][</font><font color="#FF0000">'avg_integrand'</font><font color="#990000">]</font>
     predict_array<font color="#990000">[</font>sample_index<font color="#990000">,</font> avgint_id<font color="#990000">]</font> <font color="#990000">=</font> value
     predict_found<font color="#990000">[</font>avgint_id<font color="#990000">]</font> <font color="#990000">=</font> True
predict_mean <font color="#990000">=</font> numpy<font color="#990000">.</font><b><font color="#000000">mean</font></b><font color="#990000">(</font>predict_array<font color="#990000">,</font> axis<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">)</font>
predict_std  <font color="#990000">=</font> numpy<font color="#990000">.</font><b><font color="#000000">std</font></b><font color="#990000">(</font>predict_array<font color="#990000">,</font> axis<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">,</font> ddof <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Step 6: Priors for n11 as Parent</font></i>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># create fit_n11.db starting from fit_n1.db</font></i>
shutil<font color="#990000">.</font><b><font color="#000000">copyfile</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> <font color="#FF0000">'fit_n11.db'</font><font color="#990000">)</font>
file_name <font color="#990000">=</font> <font color="#FF0000">'fit_n11.db'</font>
connection<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">()</font>
connection       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># get last id from certain tables</font></i>
sqlcmd           <font color="#990000">=</font> <font color="#FF0000">'SELECT COUNT(prior_id) FROM prior'</font>
result           <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
prior_id         <font color="#990000">=</font> <b><font color="#000000">sql_count_rows</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'prior'</font><font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">1</font>
smooth_id        <font color="#990000">=</font> <b><font color="#000000">sql_count_rows</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'smooth'</font><font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">1</font>
smooth_grid_id   <font color="#990000">=</font> <b><font color="#000000">sql_count_rows</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'smooth_grid'</font><font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">1</font>
<i><font color="#9A1900">#</font></i>
sqlcmd      <font color="#990000">=</font> <font color="#FF0000">'SELECT density_id FROM density WHERE density_name=="uniform"'</font>
result      <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
uniform_id  <font color="#990000">=</font> result<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">][</font><font color="#993399">0</font><font color="#990000">]</font>
<i><font color="#9A1900">#</font></i>
sqlcmd      <font color="#990000">=</font> <font color="#FF0000">'SELECT density_id FROM density WHERE density_name=="gaussian"'</font>
result      <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
gaussian_id <font color="#990000">=</font> result<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">][</font><font color="#993399">0</font><font color="#990000">]</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># add smooth_iota_n11</font></i>
smooth_name <font color="#990000">=</font> <font color="#FF0000">'smooth_iota_n11'</font>
n_age       <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font> age_table <font color="#990000">)</font>
smooth_id   <font color="#990000">=</font> smooth_id <font color="#990000">+</font> <font color="#993399">1</font>
sqlcmd  <font color="#990000">=</font> <font color="#FF0000">'INSERT INTO smooth \n'</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'(smooth_id, smooth_name, n_age, n_time) \n'</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'VALUES ('</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>smooth_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'"'</font> <font color="#990000">+</font> smooth_name <font color="#990000">+</font> <font color="#FF0000">'",'</font>
sqlcmd <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font> n_age <font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'1)'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
iota_smooth_id <font color="#990000">=</font> smooth_id
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># add smooth_alpha_n11</font></i>
smooth_name <font color="#990000">=</font> <font color="#FF0000">'smooth_alpha_n11'</font>
smooth_id   <font color="#990000">=</font> smooth_id <font color="#990000">+</font> <font color="#993399">1</font>
sqlcmd  <font color="#990000">=</font> <font color="#FF0000">'INSERT INTO smooth \n'</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'(smooth_id, smooth_name, n_age, n_time) \n'</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'VALUES ('</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>smooth_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'"'</font> <font color="#990000">+</font> smooth_name <font color="#990000">+</font> <font color="#FF0000">'",'</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'1,'</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'1)'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
alpha_smooth_id <font color="#990000">=</font> smooth_id
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># add prior_none</font></i>
prior_name <font color="#990000">=</font> <font color="#FF0000">'prior_none'</font>
prior_id   <font color="#990000">=</font> prior_id <font color="#990000">+</font> <font color="#993399">1</font>
sqlcmd     <font color="#990000">=</font> <font color="#FF0000">'INSERT INTO prior \n'</font>
sqlcmd    <font color="#990000">+=</font> <font color="#FF0000">'(prior_id, prior_name, density_id, mean) \n'</font>
sqlcmd    <font color="#990000">+=</font> <font color="#FF0000">'VALUES ('</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>prior_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
sqlcmd    <font color="#990000">+=</font> <font color="#FF0000">'"'</font> <font color="#990000">+</font> prior_name <font color="#990000">+</font> <font color="#FF0000">'",'</font>
sqlcmd    <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>uniform_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
sqlcmd    <font color="#990000">+=</font> <font color="#FF0000">'0)'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
none_prior_id <font color="#990000">=</font> smooth_id
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># add new entries in prior and smooth_grid tables</font></i>
<b><font color="#0000FF">assert</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>age_table<font color="#990000">)</font> <font color="#990000">==</font> n_avgint <font color="#990000">-</font> <font color="#993399">1</font>
<b><font color="#0000FF">for</font></b> avgint_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> n_avgint <font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">assert</font></b> predict_found<font color="#990000">[</font>avgint_id<font color="#990000">]</font>
     age        <font color="#990000">=</font> avgint_table<font color="#990000">[</font>avgint_id<font color="#990000">][</font><font color="#FF0000">'age_lower'</font><font color="#990000">]</font>
     mean       <font color="#990000">=</font> predict_mean<font color="#990000">[</font>avgint_id<font color="#990000">]</font>
     std        <font color="#990000">=</font> <font color="#990000">(</font><font color="#993399">1.0</font> <font color="#990000">+</font> gamma_fit_n1<font color="#990000">)</font> <font color="#990000">*</font> predict_std<font color="#990000">[</font>avgint_id<font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># entry in prior table for alpha</font></i>
     prior_id   <font color="#990000">=</font> prior_id <font color="#990000">+</font> <font color="#993399">1</font>
     prior_name <font color="#990000">=</font> <font color="#FF0000">'prior_alpha_n11'</font>
     lower      <font color="#990000">=</font> <font color="#FF0000">'null'</font>
     upper      <font color="#990000">=</font> <font color="#FF0000">'null'</font>
     <b><font color="#0000FF">if</font></b> avgint_id <font color="#990000">&lt;</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>age_table<font color="#990000">)</font> <font color="#990000">:</font>
          <i><font color="#9A1900"># entry in prior table for iota</font></i>
          prior_name <font color="#990000">=</font> <font color="#FF0000">'prior_iota_n11_'</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font><b><font color="#000000">int</font></b><font color="#990000">(</font>age<font color="#990000">))</font>
          lower      <font color="#990000">=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font> <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">10.0</font> <font color="#990000">)</font>
          upper      <font color="#990000">=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font> <b><font color="#000000">iota_no_effect</font></b><font color="#990000">(</font><font color="#993399">100</font><font color="#990000">)</font> <font color="#990000">*</font> <font color="#993399">10.0</font> <font color="#990000">)</font>
     sqlcmd  <font color="#990000">=</font> <font color="#FF0000">'INSERT INTO prior \n'</font>
     sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'(prior_id, prior_name, density_id, mean, std, lower, upper)\n'</font>
     sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'VALUES ('</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>prior_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'"'</font> <font color="#990000">+</font> prior_name <font color="#990000">+</font> <font color="#FF0000">'",'</font>
     sqlcmd <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>gaussian_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font> <b><font color="#000000">round</font></b><font color="#990000">(</font>mean<font color="#990000">,</font> <font color="#993399">4</font><font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font> <b><font color="#000000">round</font></b><font color="#990000">(</font>std<font color="#990000">,</font> <font color="#993399">5</font><font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> lower <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> upper <font color="#990000">+</font> <font color="#FF0000">')'</font>
     dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># entry in smooth_grid table</font></i>
     age_id          <font color="#990000">=</font> <font color="#993399">0</font>
     time_id         <font color="#990000">=</font> <font color="#993399">0</font>
     value_prior_id  <font color="#990000">=</font> prior_id
     dage_prior_id   <font color="#990000">=</font> none_prior_id
     tmp_smooth_id   <font color="#990000">=</font> alpha_smooth_id
     <b><font color="#0000FF">if</font></b> avgint_id <font color="#990000">&lt;</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>age_table<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">assert</font></b> age <font color="#990000">==</font> age_table<font color="#990000">[</font>avgint_id<font color="#990000">][</font><font color="#FF0000">'age'</font><font color="#990000">]</font>
          age_id        <font color="#990000">=</font> avgint_id
          tmp_smooth_id <font color="#990000">=</font> iota_smooth_id
     smooth_grid_id   <font color="#990000">=</font> smooth_grid_id <font color="#990000">+</font> <font color="#993399">1</font>
     sqlcmd  <font color="#990000">=</font> <font color="#FF0000">'INSERT INTO smooth_grid \n'</font>
     sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'(smooth_grid_id, smooth_id, age_id, time_id, '</font>
     sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'value_prior_id, dage_prior_id) \n'</font>
     sqlcmd <font color="#990000">+=</font> <font color="#FF0000">'VALUES ('</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>smooth_grid_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>tmp_smooth_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>age_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>time_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>value_prior_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">','</font>
     sqlcmd <font color="#990000">+=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>dage_prior_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">')'</font>
     dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change parent to be n11</font></i>
sqlcmd  <font color="#990000">=</font> <font color="#FF0000">'UPDATE option SET option_value = "n11"'</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">' WHERE option_name == "parent_node_name"'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># use smooth_iota_n11 for parent smoothing of iota</font></i>
sqlcmd  <font color="#990000">=</font> <font color="#FF0000">'UPDATE rate SET parent_smooth_id = '</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>iota_smooth_id<font color="#990000">)</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">' WHERE rate_name == "iota"'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># use smooth_alpha_n11 for smoothing alpha</font></i>
sqlcmd  <font color="#990000">=</font> <font color="#FF0000">'UPDATE mulcov SET smooth_id = '</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>alpha_smooth_id<font color="#990000">)</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">' WHERE mulcov_type == "rate_value"'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change reference income</font></i>
sqlcmd  <font color="#990000">=</font> <font color="#FF0000">'UPDATE covariate SET reference = '</font> <font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>avg_income<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">])</font>
sqlcmd <font color="#990000">+=</font> <font color="#FF0000">' WHERE covariate_name == "income"'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> sqlcmd<font color="#990000">)</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Step 7: Fit With n11 as Parent</font></i>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># obtain e11, estimate of model variables with n11 as the parent node</font></i>
<b><font color="#000000">system_command</font></b><font color="#990000">(</font> <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'init'</font> <font color="#990000">]</font> <font color="#990000">)</font>
<b><font color="#000000">system_command</font></b><font color="#990000">(</font> <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'both'</font> <font color="#990000">]</font> <font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check e11</font></i>
var_table        <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
fit_var_table    <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
n_var            <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>n_var<font color="#990000">)</font> <font color="#990000">:</font>
     var_type     <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
     age_id       <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'age_id'</font><font color="#990000">]</font>
     rate_id      <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'rate_id'</font><font color="#990000">]</font>
     node_id      <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'node_id'</font><font color="#990000">]</font>
     covariate_id <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'covariate_id'</font><font color="#990000">]</font>
     value        <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
     fixed        <font color="#990000">=</font> True
     <b><font color="#0000FF">if</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'rate'</font> <font color="#990000">:</font>
          age  <font color="#990000">=</font> age_table<font color="#990000">[</font>age_id<font color="#990000">][</font><font color="#FF0000">'age'</font><font color="#990000">]</font>
          node <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font>
          rate <font color="#990000">=</font> rate_table<font color="#990000">[</font>rate_id<font color="#990000">][</font><font color="#FF0000">'rate_name'</font><font color="#990000">]</font>
          <b><font color="#0000FF">assert</font></b> rate <font color="#990000">==</font> <font color="#FF0000">'iota'</font>
          <b><font color="#0000FF">if</font></b> node <font color="#990000">==</font> <font color="#FF0000">'n11'</font> <font color="#990000">:</font>
               truth <font color="#990000">=</font> <b><font color="#000000">avg_integrand</font></b><font color="#990000">(</font>age<font color="#990000">,</font> avg_income<font color="#990000">[</font>node<font color="#990000">],</font> node<font color="#990000">)</font>
          <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
               truth <font color="#990000">=</font> random_effect<font color="#990000">[</font>node<font color="#990000">]</font>
               fixed <font color="#990000">=</font> False
     <b><font color="#0000FF">elif</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'mulcov_rate_value'</font> <font color="#990000">:</font>
          truth <font color="#990000">=</font> alpha_true
     <b><font color="#0000FF">if</font></b> var_type <font color="#990000">!=</font> <font color="#FF0000">'mulcov_meas_noise'</font> <font color="#990000">:</font>
          rel_err <font color="#990000">=</font> <font color="#990000">(</font><font color="#993399">1.0</font> <font color="#990000">-</font> value <font color="#990000">/</font> truth<font color="#990000">)</font>
          fmt     <font color="#990000">=</font> <font color="#FF0000">'fixed={}, truth={:7.4f}, value={:7.4f}, rel_err={:6.3f}'</font>
          <i><font color="#9A1900"># print( fmt.format(fixed, truth, value, rel_err) )</font></i>
          <b><font color="#0000FF">if</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>rel_err<font color="#990000">)</font> <font color="#990000">&gt;=</font> <font color="#993399">2e-1</font> <font color="#990000">:</font>
               <b><font color="#0000FF">print</font></b><font color="#990000">(</font> fmt<font color="#990000">.</font><b><font color="#000000">format</font></b><font color="#990000">(</font>fixed<font color="#990000">,</font> truth<font color="#990000">,</font> value<font color="#990000">,</font> rel_err<font color="#990000">)</font> <font color="#990000">)</font>
               <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"random_seed = "</font><font color="#990000">,</font>  random_seed<font color="#990000">)</font>
               <b><font color="#0000FF">assert</font></b> False
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'cascade.py: OK'</font><font color="#990000">)</font></tt></pre>

<hr>Input File: example/user/cascade.py

</body>
</html>
