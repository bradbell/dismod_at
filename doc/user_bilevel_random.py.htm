<html>
<script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath:  [ ['@(@','@)@'] ] ,
    displayMath: [ ['@[@','@]@'] ]
  }
});
</script>
<script type='text/javascript' src=
'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=default'
>
</script>
<head>
<title>Example Fitting With Two Levels of Random Effects</title>
<meta http-equiv='Content-Type' content='text/html' charset='utf-8'>
<meta name="description" id="description" content="Example Fitting With Two Levels of Random Effects">
<meta name="keywords" id="keywords" content=" ">
<style type='text/css'>
body { color : black }
body { background-color : white }
A:link { color : blue }
A:visited { color : purple }
A:active { color : purple }
</style>
<script type='text/javascript' language='JavaScript' src='_user_bilevel_random.py_htm.js'>
</script>
</head>
<body>
<table><tr>
<td>
<a href="https://bradbell.github.io/dismod_at" target="_top"><img border="0" src="_image.gif"></a>
</td>
<td><a href="user_age_avg_split.py.htm" target="_top">Prev</a>
</td><td><a href="user_bnd_mulcov.py.htm" target="_top">Next</a>
</td><td>
<select onchange='choose_across0(this)'>
<option>Index-&gt;</option>
<option>contents</option>
<option>reference</option>
<option>index</option>
<option>search</option>
<option>external</option>
</select>
</td>
<td>
<select onchange='choose_up0(this)'>
<option>Up-&gt;</option>
<option>dismod_at</option>
<option>user_example</option>
<option>user_bilevel_random.py</option>
</select>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_dismod_at_htm.js'></script>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_user_example_htm.js'></script>
</td>
<td>user_bilevel_random.py</td>
</tr></table><br>
@(@\newcommand{\B}[1]{ {\bf #1} }
\newcommand{\R}[1]{ {\rm #1} }
\newcommand{\W}[1]{ \; #1 \; }@)@<center><b><big><big>Example Fitting With Two Levels of Random Effects</big></big></b></center>

<br><a href="user_bilevel_random.py.htm#Node Table" target="_top">Node&nbsp;Table</a>
<br><a href="user_bilevel_random.py.htm#Problem Parameters" target="_top">Problem&nbsp;Parameters</a>
<br><a href="user_bilevel_random.py.htm#Model Variables" target="_top">Model&nbsp;Variables</a>
<br><a href="user_bilevel_random.py.htm#n1" target="_top">n1</a>
<br><a href="user_bilevel_random.py.htm#n11, n12" target="_top">n11,&nbsp;n12</a>
<br><a href="user_bilevel_random.py.htm#n111, n112, n121, 122" target="_top">n111,&nbsp;n112,&nbsp;n121,&nbsp;122</a>
<br><a href="user_bilevel_random.py.htm#Subgroup Table" target="_top">Subgroup&nbsp;Table</a>
<br><a href="user_bilevel_random.py.htm#Mulcov Table" target="_top">Mulcov&nbsp;Table</a>
<br><a href="user_bilevel_random.py.htm#Data Table" target="_top">Data&nbsp;Table</a>
<br><a href="user_bilevel_random.py.htm#Procedure" target="_top">Procedure</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_bilevel_random.py.htm#Procedure.Fit Both" target="_top">Fit&nbsp;Both</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_bilevel_random.py.htm#Procedure.Compare Fit and Truth" target="_top">Compare&nbsp;Fit&nbsp;and&nbsp;Truth</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_bilevel_random.py.htm#Procedure.Sample Posterior and Check Coverage" target="_top">Sample&nbsp;Posterior&nbsp;and&nbsp;Check&nbsp;Coverage</a>
<br><a href="user_bilevel_random.py.htm#Source Code" target="_top">Source&nbsp;Code</a>
<br><br>
<b><big><a name="Node Table" id="Node Table">Node Table</a></big></b>
<br>
The following is a diagram of the node tree for this example:
<code><span style='white-space: nowrap'><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/-----/\-----\<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n12<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>
&nbsp;&nbsp;&nbsp;n111&nbsp;&nbsp;&nbsp;n112&nbsp;&nbsp;&nbsp;&nbsp;n121&nbsp;&nbsp;&nbsp;n122<br>
</span></code>We refer to 
<code><i><font color="black"><span style='white-space: nowrap'>n1</span></font></i></code>
 as the root node and

<code><i><font color="black"><span style='white-space: nowrap'>n111,&nbsp;n112,&nbsp;n121,&nbsp;n122</span></font></i></code>
 as the leaf nodes.

<br>
<br>
<b><big><a name="Problem Parameters" id="Problem Parameters">Problem Parameters</a></big></b>
<br>
The following parameters, used in this example, can be changed:
<pre><tt><i><font color="#9A1900"># True value of iota at node n1</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">iota_n1</font></b><font color="#990000">(</font>age<font color="#990000">)</font> <font color="#990000">:</font>
   <b><font color="#0000FF">return</font></b> <font color="#993399">0.01</font> <font color="#990000">+</font> <font color="#993399">0.01</font> <font color="#990000">*</font> age <font color="#990000">/</font> <font color="#993399">100.0</font> <i><font color="#9A1900"># must be non-decreasing with age</font></i>
data_per_node <font color="#990000">=</font>  <font color="#993399">20</font>    <i><font color="#9A1900"># number of simulated data points for each leaf node</font></i>
meas_cv       <font color="#990000">=</font>  <font color="#993399">0.1</font>   <i><font color="#9A1900"># coefficient of variation for each data point</font></i>
random_seed   <font color="#990000">=</font> <font color="#993399">0</font>      <i><font color="#9A1900"># if zero, seed off the clock</font></i>
number_sample <font color="#990000">=</font> <font color="#993399">10</font>     <i><font color="#9A1900"># number of posterior samples</font></i>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># True value for random effects</font></i>
random_effect <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>  <font color="#990000">=</font>  <font color="#993399">0.1</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n12'</font><font color="#990000">]</font>  <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font> <font color="#990000">=</font>  <font color="#993399">0.2</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n112'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font> <font color="#990000">=</font>  <font color="#993399">0.3</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n122'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font></tt></pre>
<br>
<b><big><a name="Model Variables" id="Model Variables">Model Variables</a></big></b>


<br>
<br>
<b><big><a name="n1" id="n1">n1</a></big></b>
<br>
The values of iota at node n1 at age 0 and age 100 are fixed effects.

<br>
<br>
<b><big><a name="n11, n12" id="n11, n12">n11, n12</a></big></b>
<br>
There is a
<a href="model_variables.htm#Random Effects, u.Child Rate Effects" target="_top"><span style='white-space: nowrap'>child&nbsp;rate&nbsp;effect</span></a>

for nodes n11 and node n12.
This adjusts the value at node n1 to its value for n11 and n12.

<br>
<br>
<b><big><a name="n111, n112, n121, 122" id="n111, n112, n121, 122">n111, n112, n121, 122</a></big></b>
<br>
There is a
<a href="model_variables.htm#Random Effects, u.Subgroup Covariate Multipliers" target="_top"><span style='white-space: nowrap'>subgroup&nbsp;covariate&nbsp;multiplier</span></a>

for nodes n111, n112, n121, and n122.
The effect (multiplier times covariate) for the target
nodes n111 and n112 adjusts the value at node n11 to the target node.
The effect for the target
nodes n121 and n122 adjusts the value at node n12 to the target node.

<br>
<br>
<b><big><a name="Subgroup Table" id="Subgroup Table">Subgroup Table</a></big></b>
<br>
The subgroup table is used for the second level of random effects and
contains the following subgraph of the node graph:
<code><span style='white-space: nowrap'><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n12<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<br>
&nbsp;&nbsp;&nbsp;n111&nbsp;&nbsp;&nbsp;n112&nbsp;&nbsp;&nbsp;&nbsp;n121&nbsp;&nbsp;&nbsp;n122<br>
</span></code>In addition, a special subgroup called <code><font color="blue">none</font></code> is
used for data points that correspond to nodes n1, n11, and n12; i.e.,
the parent node and the nodes at the first level.

<br>
<br>
<b><big><a name="Mulcov Table" id="Mulcov Table">Mulcov Table</a></big></b>
<br>
There are two entries in the mulcov table.
The first (second) entry is for group n11 (n12) and corresponds to the
subgroup covariate multipliers for n111, n112 (n121, n122).

<br>
<br>
<b><big><a name="Data Table" id="Data Table">Data Table</a></big></b>
<br>
If there was only data for the leaf nodes,
(n111, n112, n121, n122) there would be an ambiguity in the solution.
For example, we could shift the estimates for n111 and n112 by
<small>@(@
+ \Delta
@)@</small> and the estimate for n11 by <small>@(@
- \Delta
@)@</small>
and get the same fit to the data and prior
(because we are using a uniform of the priors).
For this reason, we have included data for n11, n12, and n1.
If you like, you can think of this data as prior information.

<br>
<br>
<b><big><a name="Procedure" id="Procedure">Procedure</a></big></b>


<br>
<br>
<big><a name="Procedure.Fit Both" id="Procedure.Fit Both">Fit Both</a></big>
<br>
Create the database, initialize it, and fit both fixed and random effects.

<br>
<br>
<big><a name="Procedure.Compare Fit and Truth" id="Procedure.Compare Fit and Truth">Compare Fit and Truth</a></big>
<br>
check the fit results and create the truth_var table.

<br>
<br>
<big><a name="Procedure.Sample Posterior and Check Coverage" id="Procedure.Sample Posterior and Check Coverage">Sample Posterior and Check Coverage</a></big>
<br>
Sample from the posterior distribution and check for coverage.
Note that using two levels of random effects (instead of one)
should give a better value of the uncertainty of the model variables
(when there are two levels of random effects).

<br>
<br>
<b><big><a name="Source Code" id="Source Code">Source Code</a></big></b>

<pre><tt>
<i><font color="#9A1900"># begin problem parameters</font></i>
<i><font color="#9A1900"># True value of iota at node n1</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">iota_n1</font></b><font color="#990000">(</font>age<font color="#990000">)</font> <font color="#990000">:</font>
   <b><font color="#0000FF">return</font></b> <font color="#993399">0.01</font> <font color="#990000">+</font> <font color="#993399">0.01</font> <font color="#990000">*</font> age <font color="#990000">/</font> <font color="#993399">100.0</font> <i><font color="#9A1900"># must be non-decreasing with age</font></i>
data_per_node <font color="#990000">=</font>  <font color="#993399">20</font>    <i><font color="#9A1900"># number of simulated data points for each leaf node</font></i>
meas_cv       <font color="#990000">=</font>  <font color="#993399">0.1</font>   <i><font color="#9A1900"># coefficient of variation for each data point</font></i>
random_seed   <font color="#990000">=</font> <font color="#993399">0</font>      <i><font color="#9A1900"># if zero, seed off the clock</font></i>
number_sample <font color="#990000">=</font> <font color="#993399">10</font>     <i><font color="#9A1900"># number of posterior samples</font></i>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># True value for random effects</font></i>
random_effect <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>  <font color="#990000">=</font>  <font color="#993399">0.1</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n12'</font><font color="#990000">]</font>  <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n11'</font><font color="#990000">]</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font> <font color="#990000">=</font>  <font color="#993399">0.2</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n112'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n111'</font><font color="#990000">]</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font> <font color="#990000">=</font>  <font color="#993399">0.3</font>
random_effect<font color="#990000">[</font><font color="#FF0000">'n122'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">-</font>random_effect<font color="#990000">[</font><font color="#FF0000">'n121'</font><font color="#990000">]</font>
<i><font color="#9A1900"># end problem parameters</font></i>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># imports</font></i>
<b><font color="#000080">import</font></b> sys
<b><font color="#000080">import</font></b> os
<b><font color="#000080">import</font></b> copy
<b><font color="#000080">import</font></b> random
<b><font color="#000080">import</font></b> math
<b><font color="#000080">import</font></b> numpy
<b><font color="#000080">import</font></b> shutil
<b><font color="#000080">import</font></b> time
<b><font color="#0000FF">if</font></b> random_seed <font color="#990000">==</font> <font color="#993399">0</font> <font color="#990000">:</font>
   random_seed <font color="#990000">=</font> <b><font color="#000000">int</font></b><font color="#990000">(</font> time<font color="#990000">.</font><b><font color="#000000">time</font></b><font color="#990000">()</font> <font color="#990000">)</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># run in build/example/user using local (not installed) version of dismod_at</font></i>
test_program <font color="#990000">=</font> <font color="#FF0000">'example/user/bilevel_random.py'</font>
<b><font color="#0000FF">if</font></b> sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#990000">!=</font> test_program  <b><font color="#0000FF">or</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">:</font>
   usage  <font color="#990000">=</font> <font color="#FF0000">'python3 '</font> <font color="#990000">+</font> test_program <font color="#990000">+</font> <font color="#FF0000">'\n'</font>
   usage <font color="#990000">+=</font> <font color="#FF0000">'where python3 is the python 3 program on your system\n'</font>
   usage <font color="#990000">+=</font> <font color="#FF0000">'and working directory is the dismod_at distribution directory\n'</font>
   sys<font color="#990000">.</font><b><font color="#000000">exit</font></b><font color="#990000">(</font>usage<font color="#990000">)</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font>test_program<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># import dismod_at</font></i>
local_dir <font color="#990000">=</font> os<font color="#990000">.</font><b><font color="#000000">getcwd</font></b><font color="#990000">()</font> <font color="#990000">+</font> <font color="#FF0000">'/python'</font>
<b><font color="#0000FF">if</font></b><font color="#990000">(</font> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">isdir</font></b><font color="#990000">(</font> local_dir <font color="#990000">+</font> <font color="#FF0000">'/dismod_at'</font> <font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
   sys<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">insert</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> local_dir<font color="#990000">)</font>
<b><font color="#000080">import</font></b> dismod_at
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change into the build/example/user directory</font></i>
<b><font color="#0000FF">if</font></b> <b><font color="#0000FF">not</font></b> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">exists</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font> <font color="#990000">:</font>
   os<font color="#990000">.</font><b><font color="#000000">makedirs</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
os<font color="#990000">.</font><b><font color="#000000">chdir</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900">#</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">avg_integrand</font></b><font color="#990000">(</font>age<font color="#990000">,</font> node<font color="#990000">)</font> <font color="#990000">:</font>
   total_effect <font color="#990000">=</font> <font color="#993399">0.0</font>
   <b><font color="#0000FF">if</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>node<font color="#990000">)</font> <font color="#990000">&gt;=</font> <font color="#993399">3</font> <font color="#990000">:</font>
      total_effect <font color="#990000">+=</font> random_effect<font color="#990000">[</font> node<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">:</font><font color="#993399">3</font><font color="#990000">]</font> <font color="#990000">]</font>
   <b><font color="#0000FF">if</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>node<font color="#990000">)</font> <font color="#990000">==</font> <font color="#993399">4</font> <font color="#990000">:</font>
      total_effect <font color="#990000">+=</font> random_effect<font color="#990000">[</font>node<font color="#990000">]</font>
   <b><font color="#0000FF">return</font></b> <b><font color="#000000">iota_n1</font></b><font color="#990000">(</font>age<font color="#990000">)</font> <font color="#990000">*</font> math<font color="#990000">.</font><b><font color="#000000">exp</font></b><font color="#990000">(</font>total_effect<font color="#990000">)</font>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># example.db function</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">example_db</font></b> <font color="#990000">(</font>file_name<font color="#990000">)</font> <font color="#990000">:</font>
   <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_n1</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_n1_value'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
   <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_child</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_child'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
   <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_subgroup</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_subgroup'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># node_table</font></i>
   node_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n1'</font><font color="#990000">,</font>      <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">''</font>    <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n11'</font><font color="#990000">,</font>     <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n1'</font>  <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n12'</font><font color="#990000">,</font>     <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n1'</font>  <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n111'</font><font color="#990000">,</font>    <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n11'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n112'</font><font color="#990000">,</font>    <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n11'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n121'</font><font color="#990000">,</font>    <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n12'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'n122'</font><font color="#990000">,</font>    <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'n12'</font> <font color="#990000">},</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># age_table</font></i>
   age_list <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">0.0</font><font color="#990000">,</font> <font color="#993399">100.0</font> <font color="#990000">]</font>
   <i><font color="#9A1900"># time_table</font></i>
   time_list <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">1990.0</font><font color="#990000">,</font> <font color="#993399">2020.0</font> <font color="#990000">]</font>
   <i><font color="#9A1900"># rate_table</font></i>
   rate_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font>
      <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'iota'</font><font color="#990000">,</font>
      <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_iota_n1'</font><font color="#990000">,</font>
      <font color="#FF0000">'child_smooth'</font><font color="#990000">:</font>  <font color="#FF0000">'smooth_iota_child'</font><font color="#990000">,</font>
   <font color="#990000">}</font> <font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># subgroup_table</font></i>
   subgroup_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'none'</font><font color="#990000">,</font>  <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'none'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'n111'</font><font color="#990000">,</font>  <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'n11'</font>  <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'n112'</font><font color="#990000">,</font>  <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'n11'</font>  <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'n121'</font><font color="#990000">,</font>  <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'n12'</font>  <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'n122'</font><font color="#990000">,</font>  <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'n12'</font>  <font color="#990000">},</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># covariate_table</font></i>
   covariate_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'one'</font><font color="#990000">,</font>    <font color="#FF0000">'reference'</font><font color="#990000">:</font><font color="#993399">0.0</font> <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># mulcov_table</font></i>
   mulcov_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font>
      <font color="#FF0000">'covariate'</font><font color="#990000">:</font> <font color="#FF0000">'one'</font><font color="#990000">,</font>
      <font color="#FF0000">'type'</font><font color="#990000">:</font>      <font color="#FF0000">'rate_value'</font><font color="#990000">,</font>
      <font color="#FF0000">'effected'</font><font color="#990000">:</font>  <font color="#FF0000">'iota'</font><font color="#990000">,</font>
      <font color="#FF0000">'group'</font><font color="#990000">:</font>     <font color="#FF0000">'n11'</font><font color="#990000">,</font>
      <font color="#FF0000">'smooth'</font><font color="#990000">:</font>    None<font color="#990000">,</font>
      <font color="#FF0000">'subsmooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_iota_subgroup'</font><font color="#990000">,</font>
      <font color="#990000">},{</font>
      <font color="#FF0000">'covariate'</font><font color="#990000">:</font> <font color="#FF0000">'one'</font><font color="#990000">,</font>
      <font color="#FF0000">'type'</font><font color="#990000">:</font>      <font color="#FF0000">'rate_value'</font><font color="#990000">,</font>
      <font color="#FF0000">'effected'</font><font color="#990000">:</font>  <font color="#FF0000">'iota'</font><font color="#990000">,</font>
      <font color="#FF0000">'group'</font><font color="#990000">:</font>     <font color="#FF0000">'n12'</font><font color="#990000">,</font>
      <font color="#FF0000">'smooth'</font><font color="#990000">:</font>    None<font color="#990000">,</font>
      <font color="#FF0000">'subsmooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_iota_subgroup'</font><font color="#990000">,</font>
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># prior_table</font></i>
   prior_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font>   <i><font color="#9A1900"># prior_iota_n1_value</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_n1_value'</font><font color="#990000">,</font>
         <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
         <font color="#FF0000">'lower'</font><font color="#990000">:</font>   <b><font color="#000000">iota_n1</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font>   <font color="#990000">/</font> <font color="#993399">100.0</font><font color="#990000">,</font>
         <font color="#FF0000">'upper'</font><font color="#990000">:</font>   <b><font color="#000000">iota_n1</font></b><font color="#990000">(</font><font color="#993399">100</font><font color="#990000">)</font> <font color="#990000">*</font> <font color="#993399">100.0</font><font color="#990000">,</font>
         <font color="#FF0000">'mean'</font><font color="#990000">:</font>    <b><font color="#000000">iota_n1</font></b><font color="#990000">(</font><font color="#993399">50</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">2.0</font><font color="#990000">,</font>
      <font color="#990000">},{</font> <i><font color="#9A1900"># prior_iota_child</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_child'</font><font color="#990000">,</font>
         <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
         <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
      <font color="#990000">},{</font> <i><font color="#9A1900"># prior_iota_subgroup</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>    <font color="#FF0000">'prior_iota_subgroup'</font><font color="#990000">,</font>
         <font color="#FF0000">'density'</font><font color="#990000">:</font> <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
         <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># smooth_table</font></i>
   smooth_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font>   <i><font color="#9A1900"># smooth_iota_n1</font></i>
         <font color="#FF0000">'name'</font> <font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_n1'</font><font color="#990000">,</font>
         <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">],</font>
         <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
         <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota_n1
      <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_iota_child</font></i>
         <font color="#FF0000">'name'</font> <font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_child'</font><font color="#990000">,</font>
         <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
         <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
         <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota_child
      <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_iota_subgroup</font></i>
         <font color="#FF0000">'name'</font> <font color="#990000">:</font>    <font color="#FF0000">'smooth_iota_subgroup'</font><font color="#990000">,</font>
         <font color="#FF0000">'age_id'</font><font color="#990000">:</font>   <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
         <font color="#FF0000">'time_id'</font><font color="#990000">:</font>  <font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font>
         <font color="#FF0000">'fun'</font><font color="#990000">:</font>      fun_iota_subgroup
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># weight table:</font></i>
   weight_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900"># nslist_table</font></i>
   nslist_table <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
   <i><font color="#9A1900"># option_table</font></i>
   option_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'parent_node_name'</font><font color="#990000">,</font>      <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'n1'</font><font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'rate_case'</font><font color="#990000">,</font>             <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'iota_pos_rho_zero'</font><font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font> <font color="#FF0000">'zero_sum_child_rate'</font><font color="#990000">,</font>  <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'iota'</font><font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'quasi_fixed'</font><font color="#990000">,</font>           <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'false'</font><font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_fixed'</font><font color="#990000">,</font>    <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'100'</font><font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_fixed'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'0'</font><font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_fixed'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-12'</font><font color="#990000">},</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># integrand_table</font></i>
   integrand_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font><font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'Sincidence'</font><font color="#990000">}</font> <font color="#990000">]</font>
   <i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># data_table</font></i>
   data_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900"># values that are the same for all data points</font></i>
   row <font color="#990000">=</font> <font color="#990000">{</font>
      <font color="#FF0000">'integrand'</font><font color="#990000">:</font>   <font color="#FF0000">'Sincidence'</font><font color="#990000">,</font>
      <font color="#FF0000">'density'</font><font color="#990000">:</font>     <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
      <font color="#FF0000">'weight'</font><font color="#990000">:</font>      <font color="#FF0000">''</font><font color="#990000">,</font>
      <font color="#FF0000">'hold_out'</font><font color="#990000">:</font>    False<font color="#990000">,</font>
      <font color="#FF0000">'time_lower'</font><font color="#990000">:</font>  <font color="#993399">2000.0</font><font color="#990000">,</font>
      <font color="#FF0000">'time_upper'</font><font color="#990000">:</font>  <font color="#993399">2000.0</font><font color="#990000">,</font>
      <font color="#FF0000">'one'</font><font color="#990000">:</font>         <font color="#993399">1.0</font><font color="#990000">,</font>
   <font color="#990000">}</font>
   random<font color="#990000">.</font><b><font color="#000000">seed</font></b><font color="#990000">(</font>random_seed<font color="#990000">)</font>
   <b><font color="#0000FF">for</font></b> age_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>age_list<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
      age       <font color="#990000">=</font> age_list<font color="#990000">[</font>age_id<font color="#990000">]</font>
      <b><font color="#0000FF">for</font></b> node <b><font color="#0000FF">in</font></b> <font color="#990000">[</font> <font color="#FF0000">'n1'</font><font color="#990000">,</font> <font color="#FF0000">'n11'</font><font color="#990000">,</font> <font color="#FF0000">'n12'</font><font color="#990000">,</font> <font color="#FF0000">'n111'</font><font color="#990000">,</font> <font color="#FF0000">'n112'</font><font color="#990000">,</font> <font color="#FF0000">'n121'</font><font color="#990000">,</font> <font color="#FF0000">'n122'</font> <font color="#990000">]</font> <font color="#990000">:</font>
         <b><font color="#0000FF">for</font></b> i <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>data_per_node<font color="#990000">)</font> <font color="#990000">:</font>
            iota       <font color="#990000">=</font> <b><font color="#000000">avg_integrand</font></b><font color="#990000">(</font>age<font color="#990000">,</font> node<font color="#990000">)</font>
            meas_std   <font color="#990000">=</font> iota <font color="#990000">*</font> meas_cv
            meas_value <font color="#990000">=</font> random<font color="#990000">.</font><b><font color="#000000">gauss</font></b><font color="#990000">(</font>iota<font color="#990000">,</font> meas_std<font color="#990000">)</font>
            <b><font color="#0000FF">if</font></b> node <b><font color="#0000FF">in</font></b> <font color="#990000">[</font> <font color="#FF0000">'n1'</font><font color="#990000">,</font> <font color="#FF0000">'n11'</font><font color="#990000">,</font> <font color="#FF0000">'n12'</font> <font color="#990000">]</font> <font color="#990000">:</font>
               row<font color="#990000">[</font><font color="#FF0000">'subgroup'</font><font color="#990000">]</font> <font color="#990000">=</font> <font color="#FF0000">'none'</font>
            <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
               row<font color="#990000">[</font><font color="#FF0000">'subgroup'</font><font color="#990000">]</font>   <font color="#990000">=</font> node
            row<font color="#990000">[</font><font color="#FF0000">'node'</font><font color="#990000">]</font>       <font color="#990000">=</font> node
            row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font> <font color="#990000">=</font> meas_value
            row<font color="#990000">[</font><font color="#FF0000">'meas_std'</font><font color="#990000">]</font>   <font color="#990000">=</font> meas_std
            row<font color="#990000">[</font><font color="#FF0000">'age_lower'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
            row<font color="#990000">[</font><font color="#FF0000">'age_upper'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
            data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
   <i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># avgint_table</font></i>
   avgint_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># create database</font></i>
   dismod_at<font color="#990000">.</font><b><font color="#000000">create_database</font></b><font color="#990000">(</font>
      file_name<font color="#990000">,</font>
      age_list<font color="#990000">,</font>
      time_list<font color="#990000">,</font>
      integrand_table<font color="#990000">,</font>
      node_table<font color="#990000">,</font>
      subgroup_table<font color="#990000">,</font>
      weight_table<font color="#990000">,</font>
      covariate_table<font color="#990000">,</font>
      avgint_table<font color="#990000">,</font>
      data_table<font color="#990000">,</font>
      prior_table<font color="#990000">,</font>
      smooth_table<font color="#990000">,</font>
      nslist_table<font color="#990000">,</font>
      rate_table<font color="#990000">,</font>
      mulcov_table<font color="#990000">,</font>
      option_table
   <font color="#990000">)</font>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Fit Both</font></i>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># create the database</font></i>
file_name  <font color="#990000">=</font> <font color="#FF0000">'example.db'</font>
<b><font color="#000000">example_db</font></b><font color="#990000">(</font>file_name<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># initialize the database</font></i>
program <font color="#990000">=</font> <font color="#FF0000">'../../devel/dismod_at'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">(</font> <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'init'</font> <font color="#990000">]</font> <font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># fit both the fixed and random effects</font></i>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">(</font> <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'both'</font> <font color="#990000">]</font> <font color="#990000">)</font>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Compare Fit and Truth</font></i>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># read var table and supporting information including the fit</font></i>
new              <font color="#990000">=</font> False
connection       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
subgroup_table   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'subgroup'</font><font color="#990000">)</font>
node_table       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'node'</font><font color="#990000">)</font>
age_table        <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'age'</font><font color="#990000">)</font>
var_table        <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
fit_var_table    <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
n_var            <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check fit results and create the truth_var table</font></i>
tbl_name         <font color="#990000">=</font> <font color="#FF0000">'truth_var'</font>
col_name         <font color="#990000">=</font> <font color="#990000">[</font> <font color="#FF0000">'truth_var_value'</font> <font color="#990000">]</font>
col_type         <font color="#990000">=</font> <font color="#990000">[</font> <font color="#FF0000">'real'</font> <font color="#990000">]</font>
row_list         <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
var_id2node_name <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>n_var<font color="#990000">)</font> <font color="#990000">:</font>
   var_type     <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
   age_id       <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'age_id'</font><font color="#990000">]</font>
   <b><font color="#0000FF">if</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'rate'</font> <font color="#990000">:</font>
      node_id   <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'node_id'</font><font color="#990000">]</font>
      node_name <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font>
   <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
      <b><font color="#0000FF">assert</font></b> var_type <font color="#990000">==</font> <font color="#FF0000">'mulcov_rate_value'</font>
      subgroup_id  <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'subgroup_id'</font><font color="#990000">]</font>
      node_name    <font color="#990000">=</font> subgroup_table<font color="#990000">[</font>subgroup_id<font color="#990000">][</font><font color="#FF0000">'subgroup_name'</font><font color="#990000">]</font>
   <b><font color="#0000FF">if</font></b> node_name <font color="#990000">==</font> <font color="#FF0000">'n1'</font> <font color="#990000">:</font>
      age             <font color="#990000">=</font> age_table<font color="#990000">[</font>age_id<font color="#990000">][</font><font color="#FF0000">'age'</font><font color="#990000">]</font>
      truth_var_value <font color="#990000">=</font> <b><font color="#000000">iota_n1</font></b><font color="#990000">(</font>age<font color="#990000">)</font>
   <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
      truth_var_value <font color="#990000">=</font> random_effect<font color="#990000">[</font>node_name<font color="#990000">]</font>
   row_list<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> <font color="#990000">[</font> truth_var_value <font color="#990000">]</font> <font color="#990000">)</font>
   var_id2node_name<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font>node_name<font color="#990000">)</font>
   <i><font color="#9A1900">#</font></i>
   fit_var_value <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
   relerr           <font color="#990000">=</font> <font color="#993399">1.0</font> <font color="#990000">-</font> fit_var_value <font color="#990000">/</font> truth_var_value
   <b><font color="#0000FF">if</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>relerr<font color="#990000">)</font> <font color="#990000">&gt;</font> <font color="#993399">3.0</font> <font color="#990000">*</font> meas_cv <font color="#990000">:</font>
      <b><font color="#0000FF">print</font></b><font color="#990000">(</font>node_name<font color="#990000">,</font> truth_var_value<font color="#990000">,</font> fit_var_value<font color="#990000">,</font> relerr<font color="#990000">)</font>
      <b><font color="#0000FF">assert</font></b> False
<i><font color="#9A1900">#</font></i>
dismod_at<font color="#990000">.</font><b><font color="#000000">create_table</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> tbl_name<font color="#990000">,</font> col_name<font color="#990000">,</font> col_type<font color="#990000">,</font> row_list<font color="#990000">)</font>
connection<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">()</font>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Sample Posterior and Check Coverage</font></i>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># sample from the posterior distribution</font></i>
n_str <font color="#990000">=</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>number_sample<font color="#990000">)</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">(</font> <font color="#990000">[</font>program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'simulate'</font><font color="#990000">,</font> n_str<font color="#990000">]</font> <font color="#990000">)</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">(</font>
   <font color="#990000">[</font>program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'sample'</font><font color="#990000">,</font>  <font color="#FF0000">'simulate'</font><font color="#990000">,</font> <font color="#FF0000">'both'</font><font color="#990000">,</font> n_str<font color="#990000">]</font>
<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># compute sample standard deviation and check for coverate</font></i>
connection   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
sample_table    <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'sample'</font><font color="#990000">)</font>
sample_array    <font color="#990000">=</font> numpy<font color="#990000">.</font><b><font color="#000000">zeros</font></b><font color="#990000">(</font> <font color="#990000">(</font>number_sample<font color="#990000">,</font> n_var<font color="#990000">),</font> dtype <font color="#990000">=</font> numpy<font color="#990000">.</font>double <font color="#990000">)</font>
<b><font color="#0000FF">for</font></b> sample_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>sample_table<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
   sample_index <font color="#990000">=</font> sample_table<font color="#990000">[</font>sample_id<font color="#990000">][</font><font color="#FF0000">'sample_index'</font><font color="#990000">]</font>
   var_id       <font color="#990000">=</font> sample_table<font color="#990000">[</font>sample_id<font color="#990000">][</font><font color="#FF0000">'var_id'</font><font color="#990000">]</font>
   var_value    <font color="#990000">=</font> sample_table<font color="#990000">[</font>sample_id<font color="#990000">][</font><font color="#FF0000">'var_value'</font><font color="#990000">]</font>
   <b><font color="#0000FF">assert</font></b> sample_id <font color="#990000">==</font> sample_index <font color="#990000">*</font> n_var <font color="#990000">+</font> var_id
   sample_array<font color="#990000">[</font>sample_index<font color="#990000">,</font> var_id<font color="#990000">]</font> <font color="#990000">=</font> var_value
sample_std  <font color="#990000">=</font> numpy<font color="#990000">.</font><b><font color="#000000">std</font></b><font color="#990000">(</font>sample_array<font color="#990000">,</font> axis<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">,</font> ddof <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check for covarage</font></i>
truth_var_table <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'truth_var'</font><font color="#990000">)</font>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font>n_var<font color="#990000">)</font> <font color="#990000">:</font>
   var_type        <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
   age_id          <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'age_id'</font><font color="#990000">]</font>
   node_name       <font color="#990000">=</font> var_id2node_name<font color="#990000">[</font>var_id<font color="#990000">]</font>
   fit             <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
   truth           <font color="#990000">=</font> truth_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'truth_var_value'</font><font color="#990000">]</font>
   std             <font color="#990000">=</font> sample_std<font color="#990000">[</font>var_id<font color="#990000">]</font>
   std_factor      <font color="#990000">=</font> <font color="#990000">(</font>fit <font color="#990000">-</font> truth<font color="#990000">)</font> <font color="#990000">/</font> std
   <b><font color="#0000FF">if</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>std_factor<font color="#990000">)</font> <font color="#990000">&gt;</font> <font color="#993399">3.0</font> <font color="#990000">:</font>
      <b><font color="#0000FF">print</font></b><font color="#990000">(</font>node_name<font color="#990000">,</font> <font color="#FF0000">", std_factor = "</font><font color="#990000">,</font> std_factor<font color="#990000">)</font>
      <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">"std = "</font><font color="#990000">,</font> std<font color="#990000">,</font> <font color="#FF0000">", fit = "</font><font color="#990000">,</font> fit<font color="#990000">,</font> <font color="#FF0000">", truth = "</font><font color="#990000">,</font> truth<font color="#990000">)</font>
      <b><font color="#0000FF">assert</font></b> False
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># ----------------------------------------------------------------------------</font></i>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'bilevel_random.py: OK'</font><font color="#990000">)</font></tt></pre>

<hr>Input File: example/user/bilevel_random.py

</body>
</html>
