<html>
<script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath:  [ ['@(@','@)@'] ] ,
    displayMath: [ ['@[@','@]@'] ]
  }
});
</script>
<script type='text/javascript' src=
'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=default'
>
</script>
<head>
<title>Fit Fixed First Then Both</title>
<meta http-equiv='Content-Type' content='text/html' charset='utf-8'>
<meta name="description" id="description" content="Fit Fixed First Then Both">
<meta name="keywords" id="keywords" content=" fit fixed first then both purpose discussion source code ">
<style type='text/css'>
body { color : black }
body { background-color : white }
A:link { color : blue }
A:visited { color : purple }
A:active { color : purple }
</style>
<script type='text/javascript' language='JavaScript' src='_user_fit_fixed_both.py_htm.js'>
</script>
</head>
<body>
<table><tr>
<td>
<a href="https://bradbell.github.io/dismod_at" target="_top"><img border="0" src="_image.gif"></a>
</td>
<td>
<select onchange='choose_up0(this)'>
<option>Location-&gt;</option>
<option>dismod_at</option>
<option>user</option>
<option>user_fit_fixed_both.py</option>
</select>
</td>
<td>
<select onchange='choose_across0(this)'>
<option>Search-&gt;</option>
<option>contents</option>
<option>reference</option>
<option>index</option>
<option>search</option>
<option>external</option>
</select>
</td>
<td><a href="user_diff_constraint.py.htm" target="_top">Prev</a>
</td><td><a href="user_fit_meas_noise.py.htm" target="_top">Next</a>
</td><td>
<script type='text/javascript' language='JavaScript' src='_childtable_dismod_at_htm.js'></script>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_user_htm.js'></script>
</td>
<td>user_fit_fixed_both.py</td>
</tr></table><br>
@(@\newcommand{\R}[1]{ {\rm #1} }
\newcommand{\B}[1]{ {\bf #1} }
\newcommand{\W}[1]{ \; #1 \; }@)@<center><b><big><big>Fit Fixed First Then Both</big></big></b></center>

<br><a href="user_fit_fixed_both.py.htm#Purpose" target="_top">Purpose</a>
<br><a href="user_fit_fixed_both.py.htm#Discussion" target="_top">Discussion</a>
<br><a href="user_fit_fixed_both.py.htm#Source Code" target="_top">Source&nbsp;Code</a>
<br><br>
<b><big><a name="Purpose" id="Purpose">Purpose</a></big></b>
<br>
This example demonstrates using the commands

<code><font color="blue"><span style='white-space: nowrap'><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dismod_at&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>database</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;fit&nbsp;fixed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dismod_at&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>database</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;set&nbsp;start_var&nbsp;fit_var<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dismod_at&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>database</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;fit&nbsp;both<br>
</span></font></code>
This stabilizes the optimization when the <code><font color="blue">init</font></code> command
<a href="init_command.htm#start_var_table" target="_top"><span style='white-space: nowrap'>start_var_table</span></a>
 is
far from the optimal fixed effects; see
<a href="fit_command.htm" target="_top"><span style='white-space: nowrap'>fit_command</span></a>
.


<br>
<br>
<b><big><a name="Discussion" id="Discussion">Discussion</a></big></b>
<br>
The following describes the model and data for this example:

<ol type="1"><li>
The <a href="age_table.htm" target="_top"><span style='white-space: nowrap'>age_table</span></a>
 has values
<code><font color="blue">0.0</font></code>, <code><font color="blue">50.0</font></code>, <code><font color="blue">100.0</font></code>.
The <a href="time_table.htm" target="_top"><span style='white-space: nowrap'>time_table</span></a>
 has values
<code><font color="blue">1995.0</font></code>, <code><font color="blue">2005.0</font></code>, <code><font color="blue">2015.0</font></code>.
</li><li>

The parent node is North America, the child nodes are
Canada and the United States.
</li><li>

The only <a href="model_variables.htm" target="_top"><span style='white-space: nowrap'>model_variables</span></a>
 in this example are
<a href="rate_table.htm#rate_name.iota" target="_top"><span style='white-space: nowrap'>iota</span></a>
 for the parent and the
corresponding random effects for two children.
These rates are modeled as constant with respect to age and
linear between time 1995 and 2015.
The true iota is
<table><tr><td align='left'  valign='top'>

0.01             <code><span style='white-space: nowrap'>&nbsp;&nbsp;</span></code> </td><td align='left'  valign='top'>
 North America </td></tr><tr><td align='left'  valign='top'>

0.01 * exp(+0.5) <code><span style='white-space: nowrap'>&nbsp;&nbsp;</span></code> </td><td align='left'  valign='top'>
 United States </td></tr><tr><td align='left'  valign='top'>

0.01 * exp(-0.5) <code><span style='white-space: nowrap'>&nbsp;&nbsp;</span></code> </td><td align='left'  valign='top'>
 Canada
</td></tr>
</table>
Note that the random effect for the United States is +0.5
and for Canada it is -0.5.
</li><li>

There are three measurements, one for each node.
All the measurements are at age 50 and time 2000
(there is no age or time interval for the data points).
The measurement value is exactly equal to the true value of 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>

for the corresponding node.
The measurement noise is modeled to have a 10 percent coefficient
of variation (even though there is no noise in the actual measurements).
</li><li>

The prior for North America is a uniform with mean equal to
the true value for North America divided by 100. This makes the fixed effect
in <a href="init_command.htm#start_var_table" target="_top"><span style='white-space: nowrap'>start_var_table</span></a>
 a poor starting
value.
The prior for Canada and the United States is a Gaussian with mean zero and
standard deviation 100.
The large standard deviation is so that it does not have much effect.
</li><li>

The prior for the difference in 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
 between time 1995
and time 2015 for the children (parent) is a Gaussian (log Gaussian)
with mean zero and standard deviation 0.1.
</li><li>

The init command is sets
<a href="init_command.htm#start_var_table" target="_top"><span style='white-space: nowrap'>start_var_table</span></a>
 equal to the
prior mean.
The prior mean for North America (the fixed effect) is far from its
true values and doing a fit fixed obtains a better starting point
for the fit both.
</li></ol>



<br>
<br>
<b><big><a name="Source Code" id="Source Code">Source Code</a></big></b>

<pre><tt>
<i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
iota_parent_true            <font color="#990000">=</font> <font color="#993399">1e-2</font>
united_states_random_effect <font color="#990000">=</font> <font color="#990000">+</font><font color="#993399">0.5</font>
<i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
<b><font color="#000080">import</font></b> sys
<b><font color="#000080">import</font></b> os
<b><font color="#000080">import</font></b> distutils<font color="#990000">.</font>dir_util
<b><font color="#000080">import</font></b> copy
<b><font color="#000080">from</font></b> math <b><font color="#000080">import</font></b> exp
test_program <font color="#990000">=</font> <font color="#FF0000">'example/user/fit_fixed_both.py'</font>
<b><font color="#0000FF">if</font></b> sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#990000">!=</font> test_program  <b><font color="#0000FF">or</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">:</font>
     usage  <font color="#990000">=</font> <font color="#FF0000">'python3 '</font> <font color="#990000">+</font> test_program <font color="#990000">+</font> <font color="#FF0000">'\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'where python3 is the python 3 program on your system\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'and working directory is the dismod_at distribution directory\n'</font>
     sys<font color="#990000">.</font><b><font color="#000000">exit</font></b><font color="#990000">(</font>usage<font color="#990000">)</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font>test_program<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># import dismod_at</font></i>
local_dir <font color="#990000">=</font> os<font color="#990000">.</font><b><font color="#000000">getcwd</font></b><font color="#990000">()</font> <font color="#990000">+</font> <font color="#FF0000">'/python'</font>
<b><font color="#0000FF">if</font></b><font color="#990000">(</font> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">isdir</font></b><font color="#990000">(</font> local_dir <font color="#990000">+</font> <font color="#FF0000">'/dismod_at'</font> <font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     sys<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">insert</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> local_dir<font color="#990000">)</font>
<b><font color="#000080">import</font></b> dismod_at
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change into the build/example/user directory</font></i>
distutils<font color="#990000">.</font>dir_util<font color="#990000">.</font><b><font color="#000000">mkpath</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
os<font color="#990000">.</font><b><font color="#000000">chdir</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
<i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Note that the a, t values are not used for this example</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">example_db</font></b> <font color="#990000">(</font>file_name<font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_child</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_child'</font><font color="#990000">,</font> None<font color="#990000">,</font> <font color="#FF0000">'prior_child_diff'</font><font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_parent</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_parent'</font><font color="#990000">,</font> None<font color="#990000">,</font> <font color="#FF0000">'prior_parent_diff'</font><font color="#990000">)</font>
     <b><font color="#000080">import</font></b> dismod_at
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># age table</font></i>
     age_list    <font color="#990000">=</font> <font color="#990000">[</font>    <font color="#993399">0.0</font><font color="#990000">,</font> <font color="#993399">50.0</font><font color="#990000">,</font>    <font color="#993399">100.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># time table</font></i>
     time_list   <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">1995.0</font><font color="#990000">,</font> <font color="#993399">2005.0</font><font color="#990000">,</font> <font color="#993399">2015.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># integrand table</font></i>
     integrand_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'Sincidence'</font> <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># node table: world -&gt; north_america</font></i>
     <i><font color="#9A1900">#             north_america -&gt; (united_states, canada)</font></i>
     node_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'world'</font><font color="#990000">,</font>         <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">''</font> <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'north_america'</font><font color="#990000">,</font> <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'world'</font> <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'united_states'</font><font color="#990000">,</font> <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'north_america'</font> <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'canada'</font><font color="#990000">,</font>        <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'north_america'</font> <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># weight table:</font></i>
     weight_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># covariate table: no covriates</font></i>
     covariate_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># mulcov table</font></i>
     mulcov_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># avgint table:</font></i>
     avgint_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># nslist_table:</font></i>
     nslist_table <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># data table:</font></i>
     data_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># write out data</font></i>
     row <font color="#990000">=</font> <font color="#990000">{</font>
          <font color="#FF0000">'density'</font><font color="#990000">:</font>     <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
          <font color="#FF0000">'weight'</font><font color="#990000">:</font>      <font color="#FF0000">''</font><font color="#990000">,</font>
          <font color="#FF0000">'hold_out'</font><font color="#990000">:</font>     False<font color="#990000">,</font>
          <font color="#FF0000">'time_lower'</font><font color="#990000">:</font>   <font color="#993399">2000.0</font><font color="#990000">,</font>
          <font color="#FF0000">'time_upper'</font><font color="#990000">:</font>   <font color="#993399">2000.0</font><font color="#990000">,</font>
          <font color="#FF0000">'age_lower'</font><font color="#990000">:</font>    <font color="#993399">50.0</font><font color="#990000">,</font>
          <font color="#FF0000">'age_upper'</font><font color="#990000">:</font>    <font color="#993399">50.0</font><font color="#990000">,</font>
          <font color="#FF0000">'integrand'</font><font color="#990000">:</font>    <font color="#FF0000">'Sincidence'</font><font color="#990000">,</font>
     <font color="#990000">}</font>
     row<font color="#990000">[</font><font color="#FF0000">'node'</font><font color="#990000">]</font>        <font color="#990000">=</font> <font color="#FF0000">'north_america'</font>
     row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font>  <font color="#990000">=</font> iota_parent_true
     row<font color="#990000">[</font><font color="#FF0000">'meas_std'</font><font color="#990000">]</font>    <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font> <font color="#990000">*</font> <font color="#993399">1e-1</font>
     data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
     row<font color="#990000">[</font><font color="#FF0000">'node'</font><font color="#990000">]</font>        <font color="#990000">=</font> <font color="#FF0000">'united_states'</font>
     row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font>  <font color="#990000">=</font> iota_parent_true <font color="#990000">*</font> <b><font color="#000000">exp</font></b><font color="#990000">(+</font> united_states_random_effect<font color="#990000">)</font>
     row<font color="#990000">[</font><font color="#FF0000">'meas_std'</font><font color="#990000">]</font>    <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font> <font color="#990000">*</font> <font color="#993399">1e-1</font>
     data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
     row<font color="#990000">[</font><font color="#FF0000">'node'</font><font color="#990000">]</font>        <font color="#990000">=</font> <font color="#FF0000">'canada'</font>
     row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font>  <font color="#990000">=</font> iota_parent_true <font color="#990000">*</font> <b><font color="#000000">exp</font></b><font color="#990000">(-</font> united_states_random_effect<font color="#990000">)</font>
     data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># prior_table</font></i>
     prior_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <i><font color="#9A1900"># prior_iota_parent</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_iota_parent'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'lower'</font><font color="#990000">:</font>    iota_parent_true <font color="#990000">*</font> <font color="#993399">1e-2</font><font color="#990000">,</font>
               <font color="#FF0000">'upper'</font><font color="#990000">:</font>    iota_parent_true <font color="#990000">*</font> <font color="#993399">1e+2</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     iota_parent_true <font color="#990000">*</font> <font color="#993399">2.0</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_iota_child</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_iota_child'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      <font color="#993399">100.0</font><font color="#990000">,</font> <i><font color="#9A1900"># very large so like a uniform distribution</font></i>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_parent_diff</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_parent_diff'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'log_gaussian'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      <font color="#993399">0.1</font><font color="#990000">,</font>
               <font color="#FF0000">'eta'</font><font color="#990000">:</font>      <font color="#993399">1e-8</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_child_diff</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_child_diff'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      <font color="#993399">0.1</font><font color="#990000">,</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># smooth table</font></i>
     last_time_id   <font color="#990000">=</font> <font color="#993399">2</font>
     smooth_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <i><font color="#9A1900"># smooth_iota_child</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>                     <font color="#FF0000">'smooth_iota_child'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>                   <font color="#990000">[</font> <font color="#993399">0</font> <font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>                  <font color="#990000">[</font> <font color="#993399">0</font><font color="#990000">,</font> last_time_id <font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>                      fun_iota_child
          <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_iota_parent</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>                     <font color="#FF0000">'smooth_iota_parent'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>                   <font color="#990000">[</font> <font color="#993399">0</font> <font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>                  <font color="#990000">[</font> <font color="#993399">0</font><font color="#990000">,</font> last_time_id <font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>                       fun_iota_parent
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># rate table</font></i>
     rate_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'iota'</font><font color="#990000">,</font>
               <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_iota_parent'</font><font color="#990000">,</font>
               <font color="#FF0000">'child_smooth'</font><font color="#990000">:</font>  <font color="#FF0000">'smooth_iota_child'</font><font color="#990000">,</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># option_table</font></i>
     option_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'parent_node_name'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'north_america'</font> <font color="#990000">},</font>

          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'quasi_fixed'</font><font color="#990000">,</font>            <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'true'</font>          <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'derivative_test_fixed'</font><font color="#990000">,</font>  <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'first-order'</font>   <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_fixed'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'100'</font>           <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_fixed'</font><font color="#990000">,</font>        <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-11'</font>         <font color="#990000">},</font>

          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'derivative_test_random'</font><font color="#990000">,</font> <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'second-order'</font>  <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_random'</font><font color="#990000">,</font>    <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'100'</font>           <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_random'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-11'</font>         <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># subgroup_table</font></i>
     subgroup_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'world'</font><font color="#990000">,</font> <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'world'</font> <font color="#990000">}</font> <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># create database</font></i>
     dismod_at<font color="#990000">.</font><b><font color="#000000">create_database</font></b><font color="#990000">(</font>
          file_name<font color="#990000">,</font>
          age_list<font color="#990000">,</font>
          time_list<font color="#990000">,</font>
          integrand_table<font color="#990000">,</font>
          node_table<font color="#990000">,</font>
          subgroup_table<font color="#990000">,</font>
          weight_table<font color="#990000">,</font>
          covariate_table<font color="#990000">,</font>
          avgint_table<font color="#990000">,</font>
          data_table<font color="#990000">,</font>
          prior_table<font color="#990000">,</font>
          smooth_table<font color="#990000">,</font>
          nslist_table<font color="#990000">,</font>
          rate_table<font color="#990000">,</font>
          mulcov_table<font color="#990000">,</font>
          option_table
     <font color="#990000">)</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <b><font color="#0000FF">return</font></b>
<i><font color="#9A1900"># ===========================================================================</font></i>
<i><font color="#9A1900"># Create database and run init, start, fit with just fixed effects</font></i>
file_name <font color="#990000">=</font> <font color="#FF0000">'example.db'</font>
<b><font color="#000000">example_db</font></b><font color="#990000">(</font>file_name<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
program <font color="#990000">=</font> <font color="#FF0000">'../../devel/dismod_at'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'init'</font> <font color="#990000">])</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'fixed'</font> <font color="#990000">])</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># connect to database</font></i>
new             <font color="#990000">=</font> False
connection      <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># check the zero random effects solution</font></i>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># get variable and fit_var tables</font></i>
var_table     <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
fit_var_table <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
rate_table    <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'rate'</font><font color="#990000">)</font>
node_table    <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'node'</font><font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># one age and two times for each of north_america, canada, unites_states</font></i>
n_var <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font>
<b><font color="#0000FF">assert</font></b> n_var <font color="#990000">==</font> <font color="#993399">6</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check that all the random effects are zero after a fit fixed</font></i>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> n_var <font color="#990000">)</font> <font color="#990000">:</font>
     var_type <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
     <b><font color="#0000FF">assert</font></b><font color="#990000">(</font> var_type <font color="#990000">==</font> <font color="#FF0000">'rate'</font> <font color="#990000">)</font>
     <i><font color="#9A1900">#</font></i>
     rate_id <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'rate_id'</font><font color="#990000">]</font>
     <b><font color="#0000FF">assert</font></b><font color="#990000">(</font> rate_table<font color="#990000">[</font>rate_id<font color="#990000">][</font><font color="#FF0000">'rate_name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'iota'</font> <font color="#990000">)</font>
     <i><font color="#9A1900">#</font></i>
     value   <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     node_id  <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'node_id'</font><font color="#990000">]</font>
     parent    <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'north_america'</font>
     <b><font color="#0000FF">if</font></b> parent <font color="#990000">:</font>
          <i><font color="#9A1900"># check that result of fit fixed in much better than prior mean</font></i>
          <b><font color="#0000FF">assert</font></b> value <font color="#990000">/</font> iota_parent_true <font color="#990000">&lt;</font> <font color="#993399">2.0</font>
          <b><font color="#0000FF">assert</font></b> <font color="#993399">0.5</font> <font color="#990000">&lt;</font> value <font color="#990000">/</font> iota_parent_true
     <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
          canada         <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'canada'</font>
          united_states  <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'united_states'</font>
          <b><font color="#0000FF">assert</font></b> canada <b><font color="#0000FF">or</font></b> united_states
          <b><font color="#0000FF">assert</font></b> value <font color="#990000">==</font> <font color="#993399">0.0</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Copy results of fit fixed to start table</font></i>
cmd <font color="#990000">=</font> <font color="#FF0000">'../../devel/dismod_at example.db set start_var fit_var'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'set'</font><font color="#990000">,</font> <font color="#FF0000">'start_var'</font><font color="#990000">,</font> <font color="#FF0000">'fit_var'</font> <font color="#990000">])</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># Fit both fixed and random effects</font></i>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'both'</font> <font color="#990000">])</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># check the non-zero random effects solution</font></i>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># get solution from fit_var table</font></i>
fit_var_table   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> n_var <font color="#990000">)</font> <font color="#990000">:</font>
     var_type <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font>
     <b><font color="#0000FF">assert</font></b><font color="#990000">(</font> var_type <font color="#990000">==</font> <font color="#FF0000">'rate'</font> <font color="#990000">)</font>
     <i><font color="#9A1900">#</font></i>
     rate_id <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'rate_id'</font><font color="#990000">]</font>
     <b><font color="#0000FF">assert</font></b><font color="#990000">(</font> rate_table<font color="#990000">[</font>rate_id<font color="#990000">][</font><font color="#FF0000">'rate_name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'iota'</font> <font color="#990000">)</font>
     <i><font color="#9A1900">#</font></i>
     value   <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     node_id  <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'node_id'</font><font color="#990000">]</font>
     parent   <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'north_america'</font>
     <b><font color="#0000FF">if</font></b> parent <font color="#990000">:</font>
          err <font color="#990000">=</font> value <font color="#990000">/</font> iota_parent_true <font color="#990000">-</font> <font color="#993399">1.0</font>
          <b><font color="#0000FF">assert</font></b><font color="#990000">(</font> <b><font color="#000000">abs</font></b><font color="#990000">(</font>err<font color="#990000">)</font> <font color="#990000">&lt;</font> <font color="#993399">1e-5</font> <font color="#990000">)</font>
     <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
          canada         <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'canada'</font>
          united_states  <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'united_states'</font>
          <b><font color="#0000FF">if</font></b> united_states <font color="#990000">:</font>
               child_optimal <font color="#990000">=</font> united_states_random_effect
          <b><font color="#0000FF">if</font></b> canada <font color="#990000">:</font>
               child_optimal <font color="#990000">=</font> <font color="#990000">-</font> united_states_random_effect
          err <font color="#990000">=</font> value <font color="#990000">/</font> child_optimal <font color="#990000">-</font> <font color="#993399">1.0</font>
          <b><font color="#0000FF">assert</font></b><font color="#990000">(</font> <b><font color="#000000">abs</font></b><font color="#990000">(</font>err<font color="#990000">)</font> <font color="#990000">&lt;</font> <font color="#993399">1e-4</font> <font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------</font></i>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'fit_fixed_both: OK'</font><font color="#990000">)</font></tt></pre>

<hr>Input File: example/user/fit_fixed_both.py

</body>
</html>
