<html>
<script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath:  [ ['@(@','@)@'] ] ,
    displayMath: [ ['@[@','@]@'] ]
  }
});
</script>
<script type='text/javascript' src=
'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=default'
>
</script>
<head>
<title>Example Plotting The Rates for a Fit</title>
<meta http-equiv='Content-Type' content='text/html' charset='utf-8'>
<meta name="description" id="description" content="Example Plotting The Rates for a Fit">
<meta name="keywords" id="keywords" content=" ">
<style type='text/css'>
body { color : black }
body { background-color : white }
A:link { color : blue }
A:visited { color : purple }
A:active { color : purple }
</style>
<script type='text/javascript' language='JavaScript' src='_user_plot_rate_fit.py_htm.js'>
</script>
</head>
<body>
<table><tr>
<td>
<a href="https://bradbell.github.io/dismod_at" target="_top"><img border="0" src="_image.gif"></a>
</td>
<td><a href="user_plot_data_fit.py.htm" target="_top">Prev</a>
</td><td><a href="user_predict_fit.py.htm" target="_top">Next</a>
</td><td>
<select onchange='choose_across0(this)'>
<option>Index-&gt;</option>
<option>contents</option>
<option>reference</option>
<option>index</option>
<option>search</option>
<option>external</option>
</select>
</td>
<td>
<select onchange='choose_up0(this)'>
<option>Up-&gt;</option>
<option>dismod_at</option>
<option>user_example</option>
<option>user_plot_rate_fit.py</option>
</select>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_dismod_at_htm.js'></script>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_user_example_htm.js'></script>
</td>
<td>user_plot_rate_fit.py</td>
</tr></table><br>
@(@\newcommand{\B}[1]{ {\bf #1} }
\newcommand{\R}[1]{ {\rm #1} }
\newcommand{\W}[1]{ \; #1 \; }@)@<center><b><big><big>Example Plotting The Rates for a Fit</big></big></b></center>

<br><a href="user_plot_rate_fit.py.htm#Nodes" target="_top">Nodes</a>
<br><a href="user_plot_rate_fit.py.htm#Rates" target="_top">Rates</a>
<br><a href="user_plot_rate_fit.py.htm#Integrands" target="_top">Integrands</a>
<br><a href="user_plot_rate_fit.py.htm#Data" target="_top">Data</a>
<br><a href="user_plot_rate_fit.py.htm#Call to plot_rate_fit" target="_top">Call&nbsp;to&nbsp;plot_rate_fit</a>
<br><a href="user_plot_rate_fit.py.htm#Source Code" target="_top">Source&nbsp;Code</a>
<br><br>
<b><big><a name="Nodes" id="Nodes">Nodes</a></big></b>
<br>
There are four nodes in this example.
The world node has one child, north_america.
The north_america node has two children, united_states and canada.
The <a href="option_table.htm#Parent Node" target="_top"><span style='white-space: nowrap'>parent_node</span></a>
 is canada which
does not have any children.

<br>
<br>
<b><big><a name="Rates" id="Rates">Rates</a></big></b>
<br>
There is a parent smoothing the 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
, 
<code><i><font color="black"><span style='white-space: nowrap'>rho</span></font></i></code>

and 
<code><i><font color="black"><span style='white-space: nowrap'>chi</span></font></i></code>
 rates.
There is no child node smoothing so there are no random effects
for these rates.
In addition, there is no parent smoothing for the other rates
so they are zero.
The value priors for the rate smoothing is uniform with lower limit 1e-4
and upper limit 1.0. The mean 0.1, is only used as a starting point
for the optimization.
The age and time difference prior for this smoothing is
uniform with mean zero and no upper or lower bound.

<br>
<br>
<b><big><a name="Integrands" id="Integrands">Integrands</a></big></b>
<br>
The integrands for this example are
<a href="avg_integrand.htm#Integrand, I_i(a,t).Sincidence" target="_top"><span style='white-space: nowrap'>Sincidence</span></a>
,
<a href="avg_integrand.htm#Integrand, I_i(a,t).remission" target="_top"><span style='white-space: nowrap'>remission</span></a>
, and
<a href="avg_integrand.htm#Integrand, I_i(a,t).mtexcess" target="_top"><span style='white-space: nowrap'>mtexcess</span></a>
.
Note that these integrands are direct measurements of the following rates:
<pre><tt>integrand2rate <font color="#990000">=</font> <font color="#990000">{</font>
   <font color="#FF0000">'Sincidence'</font><font color="#990000">:</font>  <font color="#FF0000">'iota'</font>   <font color="#990000">,</font>
   <font color="#FF0000">'remission'</font><font color="#990000">:</font>   <font color="#FF0000">'rho'</font>    <font color="#990000">,</font>
   <font color="#FF0000">'mtexcess'</font><font color="#990000">:</font>    <font color="#FF0000">'chi'</font>    <font color="#990000">,</font>
<font color="#990000">}</font></tt></pre>
<br>
<b><big><a name="Data" id="Data">Data</a></big></b>
<br>
All of the data corresponds to canada.
There is one data point for each of the integrands listed above.
It is simulated using true value for the corresponding rate:
<pre><tt><b><font color="#0000FF">def</font></b> <b><font color="#000000">rate_true</font></b><font color="#990000">(</font>rate_name<font color="#990000">,</font> age<font color="#990000">,</font> time<font color="#990000">)</font> <font color="#990000">:</font>
   age_fraction  <font color="#990000">=</font> age <font color="#990000">/</font> <font color="#993399">100.0</font>
   time_fraction <font color="#990000">=</font> <font color="#990000">(</font>time <font color="#990000">-</font> <font color="#993399">1980</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">40.0</font>
   <b><font color="#0000FF">assert</font></b> <font color="#993399">0</font> <font color="#990000">&lt;=</font> age_fraction <b><font color="#0000FF">and</font></b> age_fraction <font color="#990000">&lt;=</font> <font color="#993399">1.0</font>
   <b><font color="#0000FF">assert</font></b> <font color="#993399">0</font> <font color="#990000">&lt;=</font> time_fraction <b><font color="#0000FF">and</font></b> time_fraction <font color="#990000">&lt;=</font> <font color="#993399">1.0</font>
   value         <font color="#990000">=</font> age_fraction <font color="#990000">+</font> time_fraction <font color="#990000">+</font> <font color="#993399">1.0</font>
   factor        <font color="#990000">=</font> <font color="#990000">{</font> <font color="#FF0000">'iota'</font><font color="#990000">:</font><font color="#993399">1e-2</font> <font color="#990000">,</font> <font color="#FF0000">'rho'</font><font color="#990000">:</font><font color="#993399">5e-2</font> <font color="#990000">,</font> <font color="#FF0000">'chi'</font><font color="#990000">:</font><font color="#993399">1e-3</font>  <font color="#990000">}</font>
   <b><font color="#0000FF">return</font></b> factor<font color="#990000">[</font>rate_name<font color="#990000">]</font> <font color="#990000">*</font> value</tt></pre>
Even though there is not noise in the simulated data, it is modeled as
have the following coefficient of variation:
<pre style='display:inline'><tt>
meas_cv <font color="#990000">=</font> <font color="#993399">0.2</font>
</tt></pre>
<br>
<b><big><a name="Call to plot_rate_fit" id="Call to plot_rate_fit">Call to plot_rate_fit</a></big></b>

<pre><tt>
database   <font color="#990000">=</font> file_name
rate_set   <font color="#990000">=</font> <font color="#990000">{</font> <font color="#FF0000">'iota'</font><font color="#990000">,</font> <font color="#FF0000">'chi'</font> <font color="#990000">}</font>
pdf_file   <font color="#990000">=</font> <font color="#FF0000">'example.pdf'</font>
plot_title <font color="#990000">=</font> <font color="#FF0000">'Example Rate Plot'</font>
plot_set   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">plot_rate_fit</font></b><font color="#990000">(</font>database<font color="#990000">,</font> pdf_file<font color="#990000">,</font> plot_title<font color="#990000">,</font> rate_set<font color="#990000">)</font>
<b><font color="#0000FF">assert</font></b> plot_set <font color="#990000">==</font> rate_set</tt></pre>
<br>
<b><big><a name="Source Code" id="Source Code">Source Code</a></big></b>

<pre><tt>
<b><font color="#000080">import</font></b> time
<b><font color="#000080">import</font></b> sys
<b><font color="#000080">import</font></b> os
<b><font color="#000080">import</font></b> copy
<b><font color="#000080">import</font></b> random
<b><font color="#000080">import</font></b> math
test_program <font color="#990000">=</font> <font color="#FF0000">'example/user/plot_rate_fit.py'</font>
<b><font color="#0000FF">if</font></b> sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#990000">!=</font> test_program  <b><font color="#0000FF">or</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">:</font>
   usage  <font color="#990000">=</font> <font color="#FF0000">'python3 '</font> <font color="#990000">+</font> test_program <font color="#990000">+</font> <font color="#FF0000">'\n'</font>
   usage <font color="#990000">+=</font> <font color="#FF0000">'where python3 is the python 3 program on your system\n'</font>
   usage <font color="#990000">+=</font> <font color="#FF0000">'and working directory is the dismod_at distribution directory\n'</font>
   sys<font color="#990000">.</font><b><font color="#000000">exit</font></b><font color="#990000">(</font>usage<font color="#990000">)</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font>test_program<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># import dismod_at</font></i>
local_dir <font color="#990000">=</font> os<font color="#990000">.</font><b><font color="#000000">getcwd</font></b><font color="#990000">()</font> <font color="#990000">+</font> <font color="#FF0000">'/python'</font>
<b><font color="#0000FF">if</font></b><font color="#990000">(</font> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">isdir</font></b><font color="#990000">(</font> local_dir <font color="#990000">+</font> <font color="#FF0000">'/dismod_at'</font> <font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
   sys<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">insert</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> local_dir<font color="#990000">)</font>
<b><font color="#000080">import</font></b> dismod_at
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change into the build/example/user directory</font></i>
<b><font color="#0000FF">if</font></b> <b><font color="#0000FF">not</font></b> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">exists</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font> <font color="#990000">:</font>
   os<font color="#990000">.</font><b><font color="#000000">makedirs</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
os<font color="#990000">.</font><b><font color="#000000">chdir</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
random_seed <font color="#990000">=</font> <b><font color="#000000">int</font></b><font color="#990000">(</font> time<font color="#990000">.</font><b><font color="#000000">time</font></b><font color="#990000">()</font> <font color="#990000">)</font>
<i><font color="#9A1900"># ---------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Note that the a, t values are not used for this example</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">example_db</font></b> <font color="#990000">(</font>file_name<font color="#990000">)</font> <font color="#990000">:</font>
   <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_rate_parent</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
      <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_rate_parent'</font><font color="#990000">,</font> <font color="#FF0000">'prior_none'</font><font color="#990000">,</font> <font color="#FF0000">'prior_none'</font><font color="#990000">)</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># age table</font></i>
   age_list    <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">(</font> <b><font color="#000000">range</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">101</font><font color="#990000">,</font> <font color="#993399">10</font><font color="#990000">)</font> <font color="#990000">)</font>
   age_index   <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">(</font> <b><font color="#000000">range</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">,</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>age_list<font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">)</font> <font color="#990000">)</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># time table</font></i>
   time_list   <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">(</font> <b><font color="#000000">range</font></b><font color="#990000">(</font><font color="#993399">1980</font><font color="#990000">,</font> <font color="#993399">2021</font><font color="#990000">,</font> <font color="#993399">10</font><font color="#990000">)</font> <font color="#990000">)</font>
   time_index  <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">(</font> <b><font color="#000000">range</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">,</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>time_list<font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">)</font> <font color="#990000">)</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># integrand table</font></i>
   integrand_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'Sincidence'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'remission'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'mtexcess'</font> <font color="#990000">},</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># node table: world -&gt; north_america</font></i>
   <i><font color="#9A1900">#             north_america -&gt; (united_states, canada)</font></i>
   node_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'world'</font><font color="#990000">,</font>         <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">''</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'north_america'</font><font color="#990000">,</font> <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'world'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'united_states'</font><font color="#990000">,</font> <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'north_america'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'canada'</font><font color="#990000">,</font>        <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">'north_america'</font> <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># weight table:</font></i>
   weight_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># covariate table: no covriates</font></i>
   covariate_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># mulcov table</font></i>
   mulcov_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># nslist_table:</font></i>
   nslist_table <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># avgint table:</font></i>
   avgint_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># data table: same order as list of integrands</font></i>
   data_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
   <i><font color="#9A1900"># values that are the same for all data rows</font></i>
   row <font color="#990000">=</font> <font color="#990000">{</font>
      <font color="#FF0000">'node'</font><font color="#990000">:</font>        <font color="#FF0000">'canada'</font><font color="#990000">,</font>
      <font color="#FF0000">'subgroup'</font><font color="#990000">:</font>    <font color="#FF0000">'world'</font><font color="#990000">,</font>
      <font color="#FF0000">'density'</font><font color="#990000">:</font>     <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
      <font color="#FF0000">'weight'</font><font color="#990000">:</font>      <font color="#FF0000">''</font><font color="#990000">,</font>
      <font color="#FF0000">'hold_out'</font><font color="#990000">:</font>     False<font color="#990000">,</font>
   <font color="#990000">}</font>
   <i><font color="#9A1900"># values that change between rows: (one data point for each integrand)</font></i>
   <b><font color="#0000FF">for</font></b> integrand_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>integrand_table<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
      integrand_name    <font color="#990000">=</font> integrand_table<font color="#990000">[</font>integrand_id<font color="#990000">][</font><font color="#FF0000">'name'</font><font color="#990000">]</font>
      rate_name         <font color="#990000">=</font> integrand2rate<font color="#990000">[</font>integrand_name<font color="#990000">]</font>
      <i><font color="#9A1900">#</font></i>
      <b><font color="#0000FF">for</font></b> age_id <b><font color="#0000FF">in</font></b> age_index <font color="#990000">:</font>
         <b><font color="#0000FF">for</font></b> time_id <b><font color="#0000FF">in</font></b> time_index <font color="#990000">:</font>
            age        <font color="#990000">=</font> age_list<font color="#990000">[</font>age_id<font color="#990000">]</font>
            time       <font color="#990000">=</font> time_list<font color="#990000">[</font>time_id<font color="#990000">]</font>
            true_value <font color="#990000">=</font> <b><font color="#000000">rate_true</font></b><font color="#990000">(</font>rate_name<font color="#990000">,</font> age<font color="#990000">,</font> time<font color="#990000">)</font>
            meas_std          <font color="#990000">=</font> meas_cv <font color="#990000">*</font> true_value
            row<font color="#990000">[</font><font color="#FF0000">'age_lower'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
            row<font color="#990000">[</font><font color="#FF0000">'age_upper'</font><font color="#990000">]</font>  <font color="#990000">=</font> age
            row<font color="#990000">[</font><font color="#FF0000">'time_lower'</font><font color="#990000">]</font> <font color="#990000">=</font> time
            row<font color="#990000">[</font><font color="#FF0000">'time_upper'</font><font color="#990000">]</font> <font color="#990000">=</font> time
            row<font color="#990000">[</font><font color="#FF0000">'integrand'</font><font color="#990000">]</font>  <font color="#990000">=</font> integrand_name
            row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font> <font color="#990000">=</font> true_value
            row<font color="#990000">[</font><font color="#FF0000">'meas_std'</font><font color="#990000">]</font>   <font color="#990000">=</font> true_value <font color="#990000">*</font> <font color="#993399">0.2</font>
            data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># prior_table</font></i>
   prior_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font>  <i><font color="#9A1900"># prior_rate_parent</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_rate_parent'</font><font color="#990000">,</font>
         <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
         <font color="#FF0000">'lower'</font><font color="#990000">:</font>    <font color="#993399">1e-4</font><font color="#990000">,</font>
         <font color="#FF0000">'upper'</font><font color="#990000">:</font>    <font color="#993399">1.0</font><font color="#990000">,</font>
         <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.1</font><font color="#990000">,</font>
      <font color="#990000">},{</font> <i><font color="#9A1900"># prior_none</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_none'</font><font color="#990000">,</font>
         <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
         <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># smooth table</font></i>
   last_time_id   <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>time_list<font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">1</font>
   smooth_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <i><font color="#9A1900"># smooth_rate_parent</font></i>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>                     <font color="#FF0000">'smooth_rate_parent'</font><font color="#990000">,</font>
         <font color="#FF0000">'age_id'</font><font color="#990000">:</font>                   age_index<font color="#990000">,</font>
         <font color="#FF0000">'time_id'</font><font color="#990000">:</font>                  time_index<font color="#990000">,</font>
         <font color="#FF0000">'fun'</font><font color="#990000">:</font>                      fun_rate_parent
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># rate table</font></i>
   rate_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'iota'</font><font color="#990000">,</font>
         <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_rate_parent'</font><font color="#990000">,</font>
      <font color="#990000">},{</font>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'rho'</font><font color="#990000">,</font>
         <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_rate_parent'</font><font color="#990000">,</font>
      <font color="#990000">},{</font>
         <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'chi'</font><font color="#990000">,</font>
         <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_rate_parent'</font><font color="#990000">,</font>
      <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># option_table</font></i>
   option_table <font color="#990000">=</font> <font color="#990000">[</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'parent_node_name'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'canada'</font>       <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'random_seed'</font><font color="#990000">,</font>            <font color="#FF0000">'value'</font><font color="#990000">:</font>random_seed    <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'rate_case'</font><font color="#990000">,</font>              <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'iota_pos_rho_pos'</font> <font color="#990000">},</font>

      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'quasi_fixed'</font><font color="#990000">,</font>            <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'false'</font>        <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'derivative_test_fixed'</font><font color="#990000">,</font>  <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'first-order'</font>  <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_fixed'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'30'</font>           <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_fixed'</font><font color="#990000">,</font>      <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'5'</font>            <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_fixed'</font><font color="#990000">,</font>        <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-12'</font>        <font color="#990000">},</font>

      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'derivative_test_random'</font><font color="#990000">,</font> <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'second-order'</font> <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_random'</font><font color="#990000">,</font>    <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'100'</font>          <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_random'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'0'</font>            <font color="#990000">},</font>
      <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_random'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-12'</font>        <font color="#990000">}</font>
   <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># subgroup_table</font></i>
   subgroup_table <font color="#990000">=</font> <font color="#990000">[</font> <font color="#990000">{</font> <font color="#FF0000">'subgroup'</font><font color="#990000">:</font><font color="#FF0000">'world'</font><font color="#990000">,</font> <font color="#FF0000">'group'</font><font color="#990000">:</font><font color="#FF0000">'world'</font> <font color="#990000">}</font> <font color="#990000">]</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   <i><font color="#9A1900"># create database</font></i>
   dismod_at<font color="#990000">.</font><b><font color="#000000">create_database</font></b><font color="#990000">(</font>
      file_name<font color="#990000">,</font>
      age_list<font color="#990000">,</font>
      time_list<font color="#990000">,</font>
      integrand_table<font color="#990000">,</font>
      node_table<font color="#990000">,</font>
      subgroup_table<font color="#990000">,</font>
      weight_table<font color="#990000">,</font>
      covariate_table<font color="#990000">,</font>
      avgint_table<font color="#990000">,</font>
      data_table<font color="#990000">,</font>
      prior_table<font color="#990000">,</font>
      smooth_table<font color="#990000">,</font>
      nslist_table<font color="#990000">,</font>
      rate_table<font color="#990000">,</font>
      mulcov_table<font color="#990000">,</font>
      option_table
   <font color="#990000">)</font>
   <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
   n_smooth  <font color="#990000">=</font> <b><font color="#000000">len</font></b><font color="#990000">(</font> smooth_table <font color="#990000">)</font>
<i><font color="#9A1900"># ===========================================================================</font></i>
file_name  <font color="#990000">=</font> <font color="#FF0000">'example.db'</font>
<b><font color="#000000">example_db</font></b><font color="#990000">(</font>file_name<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
program <font color="#990000">=</font> <font color="#FF0000">'../../devel/dismod_at'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'init'</font> <font color="#990000">])</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'both'</font> <font color="#990000">])</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">(</font>
   <font color="#990000">[</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'sample'</font><font color="#990000">,</font> <font color="#FF0000">'asymptotic'</font><font color="#990000">,</font> <font color="#FF0000">'both'</font><font color="#990000">,</font> <font color="#FF0000">'20'</font> <font color="#990000">]</font>
<font color="#990000">)</font>
<i><font color="#9A1900"># --------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># BEGIN call plot_rate_fit</font></i>
database   <font color="#990000">=</font> file_name
rate_set   <font color="#990000">=</font> <font color="#990000">{</font> <font color="#FF0000">'iota'</font><font color="#990000">,</font> <font color="#FF0000">'chi'</font> <font color="#990000">}</font>
pdf_file   <font color="#990000">=</font> <font color="#FF0000">'example.pdf'</font>
plot_title <font color="#990000">=</font> <font color="#FF0000">'Example Rate Plot'</font>
plot_set   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">plot_rate_fit</font></b><font color="#990000">(</font>database<font color="#990000">,</font> pdf_file<font color="#990000">,</font> plot_title<font color="#990000">,</font> rate_set<font color="#990000">)</font>
<b><font color="#0000FF">assert</font></b> plot_set <font color="#990000">==</font> rate_set
<i><font color="#9A1900"># END call plot_rate_fit</font></i>
<i><font color="#9A1900"># -----------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># connect to database</font></i>
new             <font color="#990000">=</font> False
connection      <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># get variable and fit_var tables</font></i>
age_table       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'age'</font><font color="#990000">)</font>
time_table      <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'time'</font><font color="#990000">)</font>
var_table       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
node_table      <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'node'</font><font color="#990000">)</font>
rate_table      <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'rate'</font><font color="#990000">)</font>
fit_var_table   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># 3 rates and n_grid values per rate</font></i>
n_grid <font color="#990000">=</font> <font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>age_table<font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">2</font><font color="#990000">)</font> <font color="#990000">*</font> <font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>time_table<font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">2</font> <font color="#990000">)</font>
<b><font color="#0000FF">assert</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font> <font color="#990000">==</font> <font color="#993399">3</font> <font color="#990000">*</font> n_grid
<b><font color="#0000FF">for</font></b> <font color="#990000">(</font>var_id<font color="#990000">,</font> row<font color="#990000">)</font> <b><font color="#0000FF">in</font></b> <b><font color="#000000">enumerate</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font> <font color="#990000">:</font>
   <b><font color="#0000FF">assert</font></b> row<font color="#990000">[</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'rate'</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># age_id, time_id, node_id, rate_id</font></i>
   age_id    <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'age_id'</font><font color="#990000">]</font>
   time_id   <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'time_id'</font><font color="#990000">]</font>
   node_id   <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'node_id'</font><font color="#990000">]</font>
   rate_id   <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'rate_id'</font><font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># age, time, node_name, rate_name</font></i>
   age       <font color="#990000">=</font> age_table<font color="#990000">[</font>age_id<font color="#990000">][</font><font color="#FF0000">'age'</font><font color="#990000">]</font>
   time      <font color="#990000">=</font> time_table<font color="#990000">[</font>time_id<font color="#990000">][</font><font color="#FF0000">'time'</font><font color="#990000">]</font>
   node_name <font color="#990000">=</font> node_table<font color="#990000">[</font>node_id<font color="#990000">][</font><font color="#FF0000">'node_name'</font><font color="#990000">]</font>
   rate_name <font color="#990000">=</font> rate_table<font color="#990000">[</font>rate_id<font color="#990000">][</font><font color="#FF0000">'rate_name'</font><font color="#990000">]</font>
   <b><font color="#0000FF">assert</font></b> node_name <font color="#990000">==</font> <font color="#FF0000">'canada'</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># rate_name</font></i>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># fit_var_value</font></i>
   fit_var_value <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
   <i><font color="#9A1900">#</font></i>
   <i><font color="#9A1900"># check</font></i>
   check  <font color="#990000">=</font> <b><font color="#000000">rate_true</font></b><font color="#990000">(</font>rate_name<font color="#990000">,</font> age<font color="#990000">,</font> time<font color="#990000">)</font>
   err    <font color="#990000">=</font> fit_var_value  <font color="#990000">/</font> check <font color="#990000">-</font> <font color="#993399">1.0</font>
   <b><font color="#0000FF">assert</font></b> <b><font color="#000000">abs</font></b><font color="#990000">(</font>err<font color="#990000">)</font> <font color="#990000">&lt;</font> <font color="#993399">1e-6</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Run plot at unix command line</font></i>
os<font color="#990000">.</font><b><font color="#000000">chdir</font></b><font color="#990000">(</font><font color="#FF0000">'../../..'</font><font color="#990000">)</font>
program  <font color="#990000">=</font> <font color="#FF0000">'bin/dismodat.py'</font>
database <font color="#990000">=</font> f<font color="#FF0000">'build/example/user/{database}'</font>
pdf_file <font color="#990000">=</font> f<font color="#FF0000">'build/example/user/{pdf_file}'</font>
rate_set <font color="#990000">=</font> <font color="#FF0000">'iota chi'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">(</font> <font color="#990000">[</font>
   program<font color="#990000">,</font> database<font color="#990000">,</font> <font color="#FF0000">'plot_rate_fit'</font><font color="#990000">,</font> pdf_file<font color="#990000">,</font> plot_title<font color="#990000">,</font> rate_set
<font color="#990000">]</font> <font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font>f<font color="#FF0000">'Plot file: {pdf_file}'</font><font color="#990000">)</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'plot_rate_fit.py: OK'</font><font color="#990000">)</font></tt></pre>

<hr>Input File: example/user/plot_rate_fit.py

</body>
</html>
