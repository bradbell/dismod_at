<html>
<script type='text/x-mathjax-config'>
MathJax.Hub.Config({
  tex2jax: {
    inlineMath:  [ ['@(@','@)@'] ] ,
    displayMath: [ ['@[@','@]@'] ]
  }
});
</script>
<script type='text/javascript' src=
'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=default'
>
</script>
<head>
<title>Using Lasso on Covariate Multiplier</title>
<meta http-equiv='Content-Type' content='text/html' charset='utf-8'>
<meta name="description" id="description" content="Using Lasso on Covariate Multiplier">
<meta name="keywords" id="keywords" content=" using lasso on covariate multiplier see also purpose problem parameters age time values variables table mulcov rate data prior iota alpha source code ">
<style type='text/css'>
body { color : black }
body { background-color : white }
A:link { color : blue }
A:visited { color : purple }
A:active { color : purple }
</style>
<script type='text/javascript' language='JavaScript' src='_user_lasso_covariate.py_htm.js'>
</script>
</head>
<body>
<table><tr>
<td>
<a href="https://bradbell.github.io/dismod_at" target="_top"><img border="0" src="_image.gif"></a>
</td>
<td>
<select onchange='choose_up0(this)'>
<option>Location-&gt;</option>
<option>dismod_at</option>
<option>user</option>
<option>user_lasso_covariate.py</option>
</select>
</td>
<td>
<select onchange='choose_across0(this)'>
<option>Search-&gt;</option>
<option>contents</option>
<option>reference</option>
<option>index</option>
<option>search</option>
<option>external</option>
</select>
</td>
<td><a href="user_change_grid.py.htm" target="_top">Prev</a>
</td><td><a href="user_students.py.htm" target="_top">Next</a>
</td><td>
<script type='text/javascript' language='JavaScript' src='_childtable_dismod_at_htm.js'></script>
</td>
<td>
<script type='text/javascript' language='JavaScript' src='_childtable_user_htm.js'></script>
</td>
<td>user_lasso_covariate.py</td>
</tr></table><br>
@(@\newcommand{\R}[1]{ {\rm #1} }
\newcommand{\B}[1]{ {\bf #1} }
\newcommand{\W}[1]{ \; #1 \; }@)@<center><b><big><big>Using Lasso on Covariate Multiplier</big></big></b></center>

<br><a href="user_lasso_covariate.py.htm#See Also" target="_top">See&nbsp;Also</a>
<br><a href="user_lasso_covariate.py.htm#Purpose" target="_top">Purpose</a>
<br><a href="user_lasso_covariate.py.htm#Problem Parameters" target="_top">Problem&nbsp;Parameters</a>
<br><a href="user_lasso_covariate.py.htm#Age and Time Values" target="_top">Age&nbsp;and&nbsp;Time&nbsp;Values</a>
<br><a href="user_lasso_covariate.py.htm#Variables" target="_top">Variables</a>
<br><a href="user_lasso_covariate.py.htm#Covariate Table" target="_top">Covariate&nbsp;Table</a>
<br><a href="user_lasso_covariate.py.htm#Mulcov Table" target="_top">Mulcov&nbsp;Table</a>
<br><a href="user_lasso_covariate.py.htm#Rate Table" target="_top">Rate&nbsp;Table</a>
<br><a href="user_lasso_covariate.py.htm#Data Table" target="_top">Data&nbsp;Table</a>
<br><a href="user_lasso_covariate.py.htm#Prior Table" target="_top">Prior&nbsp;Table</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_lasso_covariate.py.htm#Prior Table.iota" target="_top">iota</a>
<br>&#160;&#160;&#160;&#160;&#160;<a href="user_lasso_covariate.py.htm#Prior Table.alpha" target="_top">alpha</a>
<br><a href="user_lasso_covariate.py.htm#Source Code" target="_top">Source&nbsp;Code</a>
<br><br>
<b><big><a name="See Also" id="See Also">See Also</a></big></b>

<br>
<a href="user_meas_covariate.py.htm" target="_top"><span style='white-space: nowrap'>user_meas_covariate.py</span></a>


<br>
<br>
<b><big><a name="Purpose" id="Purpose">Purpose</a></big></b>
<br>
This example uses a <a href="density_table.htm#density_name.laplace" target="_top"><span style='white-space: nowrap'>laplace</span></a>

prior distribution on two covariate multipliers
to detect which covariate is present in the data.
It then refits the data with a uniform on the multiplier that is present
and the other multiplier constrained to be zero.

<br>
<br>
<b><big><a name="Problem Parameters" id="Problem Parameters">Problem Parameters</a></big></b>
<br>
The following values are used to simulate the data and set the priors
for fitting the data:
<pre><tt>alpha_income     <font color="#990000">=</font> <font color="#993399">1.0</font>       <i><font color="#9A1900"># income covariate multiplier during simulation</font></i>
iota_reference   <font color="#990000">=</font> <font color="#993399">0.05</font>      <i><font color="#9A1900"># iota corresponding to reference for covariates</font></i>
n_data           <font color="#990000">=</font> <font color="#993399">301</font>       <i><font color="#9A1900"># number of simulated data points</font></i>
laplace_std      <font color="#990000">=</font> <font color="#993399">0.1</font><font color="#990000">/</font><font color="#993399">17.34</font> <i><font color="#9A1900"># 0.1 / sqrt(n_data)</font></i>
random_seed      <font color="#990000">=</font> <font color="#993399">0</font>         <i><font color="#9A1900"># if zero, seed off the clock</font></i></tt></pre>
<br>
<b><big><a name="Age and Time Values" id="Age and Time Values">Age and Time Values</a></big></b>
<br>
The age and time values do not matter for this problem
because all the functions are constant in age and time.
This can be seen by the fact that all of the smoothings have one age
and one time point.

<br>
<br>
<b><big><a name="Variables" id="Variables">Variables</a></big></b>
<br>
The are three model variables in this example:
<table><tr><td align='left'  valign='top'>


<code><i><font color="black"><span style='white-space: nowrap'>iota_reference</span></font></i></code>

	</td><td align='left'  valign='top'>
 <a href="avg_integrand.htm#Rate Functions.iota_i(a,t)" target="_top"><span style='white-space: nowrap'>iota</span></a>

	corresponding to reference value of covariates
</td></tr><tr><td align='left'  valign='top'>


<code><i><font color="black"><span style='white-space: nowrap'>alpha_income</span></font></i></code>
 </td><td align='left'  valign='top'>
 <a href="mulcov_table.htm" target="_top"><span style='white-space: nowrap'>covariate&nbsp;multiplier</span></a>

	corresponding to income.
</td></tr><tr><td align='left'  valign='top'>


<code><i><font color="black"><span style='white-space: nowrap'>alpha_sex</span></font></i></code>
 </td><td align='left'  valign='top'>

	covariate multiplier corresponding to sex.
</td></tr>
</table>
<br>
<b><big><a name="Covariate Table" id="Covariate Table">Covariate Table</a></big></b>
<br>
There are two <a href="covariate_table.htm" target="_top"><span style='white-space: nowrap'>covariates</span></a>
,
<code><font color="blue">income</font></code> and <code><font color="blue">sex</font></code>, in this example.
Income is a linear function of <a href="data_table.htm#data_id" target="_top"><span style='white-space: nowrap'>data_id</span></a>
.
It starts with 0.0 and ends with 1.0.
To be specific,

<code><font color="blue"><span style='white-space: nowrap'><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>income</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;=&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>data_id</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;/&nbsp;(</span></font><i><font color="black"><span style='white-space: nowrap'>n_data</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;-&nbsp;1)<br>
</span></font></code>
Sex cycles between the values -0.5, 0.0, +0.5
as a function of 
<code><i><font color="black"><span style='white-space: nowrap'>data_id</span></font></i></code>
.
Note that income and sex have range 1.0.
This makes the scaling of the covariate multipliers simpler.
The reference value for each covariate has been set to the midpoint
of its range.
We use 
<code><i><font color="black"><span style='white-space: nowrap'>x_income</span></font></i></code>
 (
<code><i><font color="black"><span style='white-space: nowrap'>x_sex</span></font></i></code>
) to denote the difference
of income (sex) minus its reference value.

<br>
<br>
<b><big><a name="Mulcov Table" id="Mulcov Table">Mulcov Table</a></big></b>
<br>
The <a href="mulcov_table.htm" target="_top"><span style='white-space: nowrap'>covariate&nbsp;multiplier&nbsp;table</span></a>
 has two rows,
one for each covariate multiplier.
Both multipliers affects the value of
<a href="avg_integrand.htm#Rate Functions.iota_i(a,t)" target="_top"><span style='white-space: nowrap'>iota</span></a>
,
but one multiplies income and the other sex.
We use 
<code><i><font color="black"><span style='white-space: nowrap'>alpha_income</span></font></i></code>
 (
<code><i><font color="black"><span style='white-space: nowrap'>alpha_sex</span></font></i></code>
) to denote the
covariate multiplier corresponding to income (sex).
The model for the value of 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
 is

<code><font color="blue"><span style='white-space: nowrap'><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>iota_reference</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;*&nbsp;exp(&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>alpha_income</span></font></i><font color="blue"><span style='white-space: nowrap'>*</span></font><i><font color="black"><span style='white-space: nowrap'>x_income</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;+&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>alpha_sex</span></font></i><font color="blue"><span style='white-space: nowrap'>*</span></font><i><font color="black"><span style='white-space: nowrap'>x_sex</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;)<br>
</span></font></code>
<br>
<b><big><a name="Rate Table" id="Rate Table">Rate Table</a></big></b>
<br>
The <a href="rate_table.htm" target="_top"><span style='white-space: nowrap'>rate_table</span></a>
 only specifies that 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>
 for the parent
is the only nonzero rate for this example.
In addition, it specifies the smoothing for that rate which has only
one grid point. Hence there is only one model variable corresponding to
the rates.

<br>
<br>
<b><big><a name="Data Table" id="Data Table">Data Table</a></big></b>
<br>
For this example, all the data is
<a href="avg_integrand.htm#Integrand, I_i(a,t).Sincidence" target="_top"><span style='white-space: nowrap'>Sincidence</span></a>
,
with a Gaussian density, with mean value

<code><font color="blue"><span style='white-space: nowrap'><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>iota_reference</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;*&nbsp;exp(&nbsp;</span></font><i><font color="black"><span style='white-space: nowrap'>alpha_income</span></font></i><font color="blue"><span style='white-space: nowrap'>&nbsp;*&nbsp;x_income&nbsp;)<br>
</span></font></code>
and with standard deviation equal 10% of the mean.

<br>
<br>
<b><big><a name="Prior Table" id="Prior Table">Prior Table</a></big></b>
<br>
There are three priors in the <a href="prior_table.htm" target="_top"><span style='white-space: nowrap'>prior_table</span></a>
, one for each
model variable.

<br>
<br>
<big><a name="Prior Table.iota" id="Prior Table.iota">iota</a></big>
<br>
The prior for fitting the reference value of 
<code><i><font color="black"><span style='white-space: nowrap'>iota</span></font></i></code>

is uniform with lower limit 0.001, and upper limit 1.
Its mean value 0.1 is only used as a starting and scaling point for the
fitting process; see <a href="start_var_table.htm" target="_top"><span style='white-space: nowrap'>start_var_table</span></a>
 and <a href="scale_var_table.htm" target="_top"><span style='white-space: nowrap'>scale_var_table</span></a>
.

<br>
<br>
<big><a name="Prior Table.alpha" id="Prior Table.alpha">alpha</a></big>
<br>
There is a separate prior for 
<code><i><font color="black"><span style='white-space: nowrap'>alpha_income</span></font></i></code>
 and 
<code><i><font color="black"><span style='white-space: nowrap'>alpha_sex</span></font></i></code>
.
For the first fit, they are both a Laplace density with
mean zero and standard deviation 
<code><i><font color="black"><span style='white-space: nowrap'>laplace_std</span></font></i></code>
.
The first fit is used to decide that 
<code><i><font color="black"><span style='white-space: nowrap'>alpha_income</span></font></i></code>
 is nonzero
and 
<code><i><font color="black"><span style='white-space: nowrap'>alpha_sex</span></font></i></code>
 is zero.
The prior for 
<code><i><font color="black"><span style='white-space: nowrap'>alpha_income</span></font></i></code>
 is changed to a uniform
and the prior for 
<code><i><font color="black"><span style='white-space: nowrap'>alpha_sex</span></font></i></code>
 is change to have upper and lower
limit zero.
A second fit is done to recover the value of 
<code><i><font color="black"><span style='white-space: nowrap'>alpha_income</span></font></i></code>

without shrinkage due to the Laplace prior.

<br>
<br>
<b><big><a name="Source Code" id="Source Code">Source Code</a></big></b>

<pre><tt>
<i><font color="#9A1900"># begin problem parameters</font></i>
alpha_income     <font color="#990000">=</font> <font color="#993399">1.0</font>       <i><font color="#9A1900"># income covariate multiplier during simulation</font></i>
iota_reference   <font color="#990000">=</font> <font color="#993399">0.05</font>      <i><font color="#9A1900"># iota corresponding to reference for covariates</font></i>
n_data           <font color="#990000">=</font> <font color="#993399">301</font>       <i><font color="#9A1900"># number of simulated data points</font></i>
laplace_std      <font color="#990000">=</font> <font color="#993399">0.1</font><font color="#990000">/</font><font color="#993399">17.34</font> <i><font color="#9A1900"># 0.1 / sqrt(n_data)</font></i>
random_seed      <font color="#990000">=</font> <font color="#993399">0</font>         <i><font color="#9A1900"># if zero, seed off the clock</font></i>
<i><font color="#9A1900"># end problem parameters</font></i>
<i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
<b><font color="#000080">import</font></b> time
<b><font color="#0000FF">if</font></b> random_seed <font color="#990000">==</font> <font color="#993399">0</font> <font color="#990000">:</font>
     random_seed <font color="#990000">=</font> <b><font color="#000000">int</font></b><font color="#990000">(</font> time<font color="#990000">.</font><b><font color="#000000">time</font></b><font color="#990000">()</font> <font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<b><font color="#000080">import</font></b> sys
<b><font color="#000080">import</font></b> os
<b><font color="#000080">import</font></b> distutils<font color="#990000">.</font>dir_util
<b><font color="#000080">import</font></b> copy
<b><font color="#000080">import</font></b> random
<b><font color="#000080">import</font></b> math
test_program <font color="#990000">=</font> <font color="#FF0000">'example/user/lasso_covariate.py'</font>
<b><font color="#0000FF">if</font></b> sys<font color="#990000">.</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]</font> <font color="#990000">!=</font> test_program  <b><font color="#0000FF">or</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>sys<font color="#990000">.</font>argv<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">:</font>
     usage  <font color="#990000">=</font> <font color="#FF0000">'python3 '</font> <font color="#990000">+</font> test_program <font color="#990000">+</font> <font color="#FF0000">'\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'where python3 is the python 3 program on your system\n'</font>
     usage <font color="#990000">+=</font> <font color="#FF0000">'and working directory is the dismod_at distribution directory\n'</font>
     sys<font color="#990000">.</font><b><font color="#000000">exit</font></b><font color="#990000">(</font>usage<font color="#990000">)</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font>test_program<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># import dismod_at</font></i>
local_dir <font color="#990000">=</font> os<font color="#990000">.</font><b><font color="#000000">getcwd</font></b><font color="#990000">()</font> <font color="#990000">+</font> <font color="#FF0000">'/python'</font>
<b><font color="#0000FF">if</font></b><font color="#990000">(</font> os<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">isdir</font></b><font color="#990000">(</font> local_dir <font color="#990000">+</font> <font color="#FF0000">'/dismod_at'</font> <font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     sys<font color="#990000">.</font>path<font color="#990000">.</font><b><font color="#000000">insert</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font> local_dir<font color="#990000">)</font>
<b><font color="#000080">import</font></b> dismod_at
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># change into the build/example/user directory</font></i>
distutils<font color="#990000">.</font>dir_util<font color="#990000">.</font><b><font color="#000000">mkpath</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
os<font color="#990000">.</font><b><font color="#000000">chdir</font></b><font color="#990000">(</font><font color="#FF0000">'build/example/user'</font><font color="#990000">)</font>
<i><font color="#9A1900"># ------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Note that the a, t values are not used for this example</font></i>
<b><font color="#0000FF">def</font></b> <b><font color="#000000">example_db</font></b> <font color="#990000">(</font>file_name<font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_iota_parent</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_iota_parent'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_income</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_income'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <b><font color="#0000FF">def</font></b> <b><font color="#000000">fun_sex</font></b><font color="#990000">(</font>a<font color="#990000">,</font> t<font color="#990000">)</font> <font color="#990000">:</font>
          <b><font color="#0000FF">return</font></b> <font color="#990000">(</font><font color="#FF0000">'prior_sex'</font><font color="#990000">,</font> None<font color="#990000">,</font> None<font color="#990000">)</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># age table</font></i>
     age_list    <font color="#990000">=</font> <font color="#990000">[</font>    <font color="#993399">0.0</font><font color="#990000">,</font> <font color="#993399">50.0</font><font color="#990000">,</font>    <font color="#993399">100.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># time table</font></i>
     time_list   <font color="#990000">=</font> <font color="#990000">[</font> <font color="#993399">1995.0</font><font color="#990000">,</font> <font color="#993399">2005.0</font><font color="#990000">,</font> <font color="#993399">2015.0</font> <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># integrand table</font></i>
     integrand_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'Sincidence'</font> <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># node table: world -&gt; north_america</font></i>
     <i><font color="#9A1900">#             north_america -&gt; (united_states, canada)</font></i>
     node_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'world'</font><font color="#990000">,</font>         <font color="#FF0000">'parent'</font><font color="#990000">:</font><font color="#FF0000">''</font> <font color="#990000">},</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># weight table:</font></i>
     weight_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># covariate table:</font></i>
     covariate_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font><font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'income'</font><font color="#990000">,</font> <font color="#FF0000">'reference'</font><font color="#990000">:</font><font color="#993399">0.5</font><font color="#990000">},</font>
          <font color="#990000">{</font><font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'sex'</font><font color="#990000">,</font>    <font color="#FF0000">'reference'</font><font color="#990000">:</font><font color="#993399">0.0</font><font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># mulcov table</font></i>
     <i><font color="#9A1900"># income has been scaled the same as sex so man use same smoothing</font></i>
     mulcov_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font>
               <font color="#FF0000">'covariate'</font><font color="#990000">:</font> <font color="#FF0000">'income'</font><font color="#990000">,</font>
               <font color="#FF0000">'type'</font><font color="#990000">:</font>      <font color="#FF0000">'rate_value'</font><font color="#990000">,</font>
               <font color="#FF0000">'effected'</font><font color="#990000">:</font>  <font color="#FF0000">'iota'</font><font color="#990000">,</font>
               <font color="#FF0000">'smooth'</font><font color="#990000">:</font>    <font color="#FF0000">'smooth_income'</font>
          <font color="#990000">},{</font>
               <font color="#FF0000">'covariate'</font><font color="#990000">:</font> <font color="#FF0000">'sex'</font><font color="#990000">,</font>
               <font color="#FF0000">'type'</font><font color="#990000">:</font>      <font color="#FF0000">'rate_value'</font><font color="#990000">,</font>
               <font color="#FF0000">'effected'</font><font color="#990000">:</font>  <font color="#FF0000">'iota'</font><font color="#990000">,</font>
               <font color="#FF0000">'smooth'</font><font color="#990000">:</font>    <font color="#FF0000">'smooth_sex'</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># avgint table: empty</font></i>
     avgint_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># nslist_table:</font></i>
     nslist_table <font color="#990000">=</font> <b><font color="#000000">dict</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># data table:</font></i>
     data_table <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
     <i><font color="#9A1900"># values that are the same for all data rows</font></i>
     row <font color="#990000">=</font> <font color="#990000">{</font>
          <font color="#FF0000">'node'</font><font color="#990000">:</font>        <font color="#FF0000">'world'</font><font color="#990000">,</font>
          <font color="#FF0000">'integrand'</font><font color="#990000">:</font>   <font color="#FF0000">'Sincidence'</font><font color="#990000">,</font>
          <font color="#FF0000">'density'</font><font color="#990000">:</font>     <font color="#FF0000">'gaussian'</font><font color="#990000">,</font>
          <font color="#FF0000">'weight'</font><font color="#990000">:</font>      <font color="#FF0000">''</font><font color="#990000">,</font>
          <font color="#FF0000">'hold_out'</font><font color="#990000">:</font>     False<font color="#990000">,</font>
          <font color="#FF0000">'age_lower'</font><font color="#990000">:</font>    <font color="#993399">0.0</font><font color="#990000">,</font>
          <font color="#FF0000">'age_upper'</font><font color="#990000">:</font>    <font color="#993399">0.0</font><font color="#990000">,</font>
          <font color="#FF0000">'time_lower'</font><font color="#990000">:</font>   <font color="#993399">1995.0</font><font color="#990000">,</font>
          <font color="#FF0000">'time_upper'</font><font color="#990000">:</font>   <font color="#993399">1995.0</font><font color="#990000">,</font>
     <font color="#990000">}</font>
     <i><font color="#9A1900"># values that change between rows:</font></i>
     income_reference <font color="#990000">=</font> <font color="#993399">0.5</font>
     random<font color="#990000">.</font><b><font color="#000000">seed</font></b><font color="#990000">(</font>random_seed<font color="#990000">)</font>
     <b><font color="#0000FF">for</font></b> data_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> n_data <font color="#990000">)</font> <font color="#990000">:</font>
          income         <font color="#990000">=</font> data_id <font color="#990000">/</font> <b><font color="#000000">float</font></b><font color="#990000">(</font>n_data<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">)</font>
          sex            <font color="#990000">=</font> <font color="#990000">(</font> data_id <font color="#990000">%</font> <font color="#993399">3</font> <font color="#990000">-</font> <font color="#993399">1.0</font> <font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">2.0</font>
          x_income       <font color="#990000">=</font> income <font color="#990000">-</font> income_reference
          avg_integrand  <font color="#990000">=</font> iota_reference <font color="#990000">*</font> math<font color="#990000">.</font><b><font color="#000000">exp</font></b><font color="#990000">(</font> alpha_income <font color="#990000">*</font> x_income <font color="#990000">)</font>
          meas_value     <font color="#990000">=</font> random<font color="#990000">.</font><b><font color="#000000">gauss</font></b><font color="#990000">(</font>avg_integrand<font color="#990000">,</font> <font color="#993399">1e-1</font> <font color="#990000">*</font> avg_integrand<font color="#990000">)</font>
          meas_std       <font color="#990000">=</font> <font color="#993399">0.1</font> <font color="#990000">*</font> meas_value
          row<font color="#990000">[</font><font color="#FF0000">'meas_value'</font><font color="#990000">]</font> <font color="#990000">=</font> meas_value
          row<font color="#990000">[</font><font color="#FF0000">'meas_std'</font><font color="#990000">]</font>   <font color="#990000">=</font> meas_std
          row<font color="#990000">[</font><font color="#FF0000">'income'</font><font color="#990000">]</font>     <font color="#990000">=</font> income
          row<font color="#990000">[</font><font color="#FF0000">'sex'</font><font color="#990000">]</font>        <font color="#990000">=</font> sex
          data_table<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> copy<font color="#990000">.</font><b><font color="#000000">copy</font></b><font color="#990000">(</font>row<font color="#990000">)</font> <font color="#990000">)</font>
     <i><font color="#9A1900">#</font></i>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># prior_table</font></i>
     prior_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <i><font color="#9A1900"># prior_iota_parent</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_iota_parent'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'uniform'</font><font color="#990000">,</font>
               <font color="#FF0000">'lower'</font><font color="#990000">:</font>    <font color="#993399">0.001</font><font color="#990000">,</font>
               <font color="#FF0000">'upper'</font><font color="#990000">:</font>    <font color="#993399">1.00</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.1</font><font color="#990000">,</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_income</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_income'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'laplace'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      laplace_std<font color="#990000">,</font>
          <font color="#990000">},{</font> <i><font color="#9A1900"># prior_sex</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>     <font color="#FF0000">'prior_sex'</font><font color="#990000">,</font>
               <font color="#FF0000">'density'</font><font color="#990000">:</font>  <font color="#FF0000">'laplace'</font><font color="#990000">,</font>
               <font color="#FF0000">'mean'</font><font color="#990000">:</font>     <font color="#993399">0.0</font><font color="#990000">,</font>
               <font color="#FF0000">'std'</font><font color="#990000">:</font>      laplace_std<font color="#990000">,</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># smooth table</font></i>
     smooth_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <i><font color="#9A1900"># smooth_iota_parent</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>                     <font color="#FF0000">'smooth_iota_parent'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>                   <font color="#990000">[</font> <font color="#993399">0</font> <font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>                  <font color="#990000">[</font> <font color="#993399">0</font> <font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>                      fun_iota_parent
          <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_income</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>                     <font color="#FF0000">'smooth_income'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>                   <font color="#990000">[</font> <font color="#993399">0</font> <font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>                  <font color="#990000">[</font> <font color="#993399">0</font> <font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>                      fun_income
          <font color="#990000">},{</font> <i><font color="#9A1900"># smooth_sex</font></i>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>                     <font color="#FF0000">'smooth_sex'</font><font color="#990000">,</font>
               <font color="#FF0000">'age_id'</font><font color="#990000">:</font>                   <font color="#990000">[</font> <font color="#993399">0</font> <font color="#990000">],</font>
               <font color="#FF0000">'time_id'</font><font color="#990000">:</font>                  <font color="#990000">[</font> <font color="#993399">0</font> <font color="#990000">],</font>
               <font color="#FF0000">'fun'</font><font color="#990000">:</font>                      fun_sex
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># rate table</font></i>
     rate_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font>
               <font color="#FF0000">'name'</font><font color="#990000">:</font>          <font color="#FF0000">'iota'</font><font color="#990000">,</font>
               <font color="#FF0000">'parent_smooth'</font><font color="#990000">:</font> <font color="#FF0000">'smooth_iota_parent'</font><font color="#990000">,</font>
          <font color="#990000">}</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># option_table</font></i>
     option_table <font color="#990000">=</font> <font color="#990000">[</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'parent_node_name'</font><font color="#990000">,</font>       <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'world'</font>             <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'rate_case'</font><font color="#990000">,</font>              <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'iota_pos_rho_zero'</font> <font color="#990000">},</font>

          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'quasi_fixed'</font><font color="#990000">,</font>            <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'false'</font>        <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'max_num_iter_fixed'</font><font color="#990000">,</font>     <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'100'</font>          <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'print_level_fixed'</font><font color="#990000">,</font>      <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'0'</font>            <font color="#990000">},</font>
          <font color="#990000">{</font> <font color="#FF0000">'name'</font><font color="#990000">:</font><font color="#FF0000">'tolerance_fixed'</font><font color="#990000">,</font>        <font color="#FF0000">'value'</font><font color="#990000">:</font><font color="#FF0000">'1e-13'</font>        <font color="#990000">},</font>
     <font color="#990000">]</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
     <i><font color="#9A1900"># create database</font></i>
     dismod_at<font color="#990000">.</font><b><font color="#000000">create_database</font></b><font color="#990000">(</font>
          file_name<font color="#990000">,</font>
          age_list<font color="#990000">,</font>
          time_list<font color="#990000">,</font>
          integrand_table<font color="#990000">,</font>
          node_table<font color="#990000">,</font>
          weight_table<font color="#990000">,</font>
          covariate_table<font color="#990000">,</font>
          avgint_table<font color="#990000">,</font>
          data_table<font color="#990000">,</font>
          prior_table<font color="#990000">,</font>
          smooth_table<font color="#990000">,</font>
          nslist_table<font color="#990000">,</font>
          rate_table<font color="#990000">,</font>
          mulcov_table<font color="#990000">,</font>
          option_table
     <font color="#990000">)</font>
     <i><font color="#9A1900"># ----------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># ===========================================================================</font></i>
<i><font color="#9A1900"># Fit to determine nonzero covariate multipliers</font></i>
file_name <font color="#990000">=</font> <font color="#FF0000">'example.db'</font>
<b><font color="#000000">example_db</font></b><font color="#990000">(</font>file_name<font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
program <font color="#990000">=</font> <font color="#FF0000">'../../devel/dismod_at'</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'init'</font> <font color="#990000">])</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'fixed'</font> <font color="#990000">])</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># connect to database</font></i>
new             <font color="#990000">=</font> False
connection      <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">create_connection</font></b><font color="#990000">(</font>file_name<font color="#990000">,</font> new<font color="#990000">)</font>
var_table       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
fit_var_table   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
density_table   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'density'</font><font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># density_id for a uniform distribution</font></i>
uniform_id <font color="#990000">=</font> None
<b><font color="#0000FF">for</font></b> density_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>density_table<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     <b><font color="#0000FF">if</font></b> density_table<font color="#990000">[</font>density_id<font color="#990000">][</font><font color="#FF0000">'density_name'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'uniform'</font> <font color="#990000">:</font>
          uniform_id <font color="#990000">=</font> density_id
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check covariate multiplier values</font></i>
nonzero_mulcov  <font color="#990000">=</font> <b><font color="#000000">list</font></b><font color="#990000">()</font>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     row   <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">]</font>
     match <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'mulcov_rate_value'</font>
     <b><font color="#0000FF">if</font></b> match <font color="#990000">:</font>
          fit_var_value  <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
          covariate_id   <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'covariate_id'</font><font color="#990000">]</font>
          <i><font color="#9A1900">#</font></i>
          nonzero <font color="#990000">=</font> <b><font color="#000000">abs</font></b><font color="#990000">(</font>fit_var_value<font color="#990000">)</font> <font color="#990000">&gt;</font> laplace_std
          <b><font color="#0000FF">if</font></b> covariate_id <font color="#990000">==</font> <font color="#993399">0</font> <font color="#990000">:</font>
               <b><font color="#0000FF">if</font></b><font color="#990000">(</font> <b><font color="#0000FF">not</font></b> nonzero <font color="#990000">)</font> <font color="#990000">:</font>
                    <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'random_seed = '</font><font color="#990000">,</font> random_seed<font color="#990000">)</font>
               <b><font color="#0000FF">assert</font></b> nonzero
          <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
               <b><font color="#0000FF">if</font></b><font color="#990000">(</font> nonzero <font color="#990000">)</font> <font color="#990000">:</font>
                    <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'random_seed = '</font><font color="#990000">,</font> random_seed<font color="#990000">)</font>
               <b><font color="#0000FF">assert</font></b> <b><font color="#0000FF">not</font></b> nonzero
          nonzero_mulcov<font color="#990000">.</font><b><font color="#000000">append</font></b><font color="#990000">(</font> nonzero <font color="#990000">)</font>
<b><font color="#0000FF">assert</font></b> <b><font color="#000000">len</font></b><font color="#990000">(</font>nonzero_mulcov<font color="#990000">)</font> <font color="#990000">==</font> <font color="#993399">2</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i>
<i><font color="#9A1900"># Remove laplace prior on nonzero multipliers and re-fit</font></i>
prior_name <font color="#990000">=</font> <font color="#990000">[</font> <font color="#FF0000">'prior_income'</font><font color="#990000">,</font> <font color="#FF0000">'prior_sex'</font> <font color="#990000">]</font>
<b><font color="#0000FF">for</font></b> covariate_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font><font color="#993399">2</font><font color="#990000">):</font>
     <b><font color="#0000FF">if</font></b> nonzero_mulcov<font color="#990000">[</font>covariate_id<font color="#990000">]</font> <font color="#990000">:</font>
          command <font color="#990000">=</font> <font color="#FF0000">'UPDATE prior SET density_id = '</font><font color="#990000">+</font> <b><font color="#000000">str</font></b><font color="#990000">(</font>uniform_id<font color="#990000">)</font>
          command <font color="#990000">+=</font> <font color="#FF0000">' WHERE prior_name == '</font>
          command <font color="#990000">+=</font> <font color="#FF0000">'"'</font> <font color="#990000">+</font> prior_name<font color="#990000">[</font>covariate_id<font color="#990000">]</font> <font color="#990000">+</font> <font color="#FF0000">'"'</font>
          dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> command<font color="#990000">)</font>
     <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
          command <font color="#990000">=</font> <font color="#FF0000">'UPDATE prior SET lower=0.0, upper=0.0 WHERE prior_name == '</font>
          command <font color="#990000">+=</font> <font color="#FF0000">'"'</font> <font color="#990000">+</font> prior_name<font color="#990000">[</font>covariate_id<font color="#990000">]</font> <font color="#990000">+</font> <font color="#FF0000">'"'</font>
          dismod_at<font color="#990000">.</font><b><font color="#000000">sql_command</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> command<font color="#990000">)</font>
dismod_at<font color="#990000">.</font><b><font color="#000000">system_command_prc</font></b><font color="#990000">([</font> program<font color="#990000">,</font> file_name<font color="#990000">,</font> <font color="#FF0000">'fit'</font><font color="#990000">,</font> <font color="#FF0000">'fixed'</font> <font color="#990000">])</font>
<i><font color="#9A1900">#</font></i>
var_table       <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'var'</font><font color="#990000">)</font>
fit_var_table   <font color="#990000">=</font> dismod_at<font color="#990000">.</font><b><font color="#000000">get_table_dict</font></b><font color="#990000">(</font>connection<font color="#990000">,</font> <font color="#FF0000">'fit_var'</font><font color="#990000">)</font>
<i><font color="#9A1900">#</font></i>
<i><font color="#9A1900"># check covariate multiplier values</font></i>
<b><font color="#0000FF">for</font></b> var_id <b><font color="#0000FF">in</font></b> <b><font color="#000000">range</font></b><font color="#990000">(</font> <b><font color="#000000">len</font></b><font color="#990000">(</font>var_table<font color="#990000">)</font> <font color="#990000">)</font> <font color="#990000">:</font>
     row   <font color="#990000">=</font> var_table<font color="#990000">[</font>var_id<font color="#990000">]</font>
     match <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'var_type'</font><font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'mulcov_rate_value'</font>
     <b><font color="#0000FF">if</font></b> match <font color="#990000">:</font>
          fit_var_value  <font color="#990000">=</font> fit_var_table<font color="#990000">[</font>var_id<font color="#990000">][</font><font color="#FF0000">'fit_var_value'</font><font color="#990000">]</font>
          covariate_id   <font color="#990000">=</font> row<font color="#990000">[</font><font color="#FF0000">'covariate_id'</font><font color="#990000">]</font>
          <i><font color="#9A1900">#</font></i>
          <b><font color="#0000FF">if</font></b> covariate_id <font color="#990000">==</font> <font color="#993399">0</font> <font color="#990000">:</font>
               ok <font color="#990000">=</font> <b><font color="#000000">abs</font></b><font color="#990000">(</font> <font color="#993399">1.0</font> <font color="#990000">-</font> fit_var_value <font color="#990000">/</font> alpha_income <font color="#990000">)</font> <font color="#990000">&lt;</font> <font color="#993399">0.1</font>
               <b><font color="#0000FF">if</font></b> <b><font color="#0000FF">not</font></b> ok <font color="#990000">:</font>
                     <b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'random_seed = '</font><font color="#990000">,</font> random_seed<font color="#990000">)</font>
               <b><font color="#0000FF">assert</font></b> ok
          <b><font color="#0000FF">else</font></b> <font color="#990000">:</font>
               <b><font color="#0000FF">assert</font></b> fit_var_value <font color="#990000">==</font> <font color="#993399">0.0</font>
<b><font color="#0000FF">print</font></b><font color="#990000">(</font><font color="#FF0000">'lasso_covariate.py: OK'</font><font color="#990000">)</font>
<i><font color="#9A1900"># -----------------------------------------------------------------------------</font></i></tt></pre>

<hr>Input File: example/user/lasso_covariate.py

</body>
</html>
